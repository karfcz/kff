(function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.widgets={},b.extend=function(a,b){var c=function(){};a._super=c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a},b.mixins=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},b.createClass=function(a,c){var d;arguments.length===0?a=c={}:arguments.length===1&&(c=a,a={}),c.hasOwnProperty("constructor")?d=c.constructor:a.extend?d=function(){a.extend.apply(this,arguments)}:d=function(){},a.extend&&b.extend(d,a.extend);if(a.mixins){a.mixins instanceof Array||(a.mixins=[a.mixins]);for(var e=0,f=a.mixins.length;e<f;e++)b.mixins(c,a.mixins[e])}return a.staticProperties&&b.mixins(d,a.staticProperties),b.mixins(d.prototype,c),d.prototype.constructor=d,d},b.bindFn=function(a,b){if(typeof a[b]!="function")throw new TypeError("expected function");return a.boundFns||(a.boundFns={}),a.boundFns[b]?a.boundFns[b]:(a.boundFns[b]=function(){return a[b].apply(a,arguments)},a.boundFns[b])},b.isTouchDevice=function(){return"ontouchstart"in window},b.evalObjectPath=function(b){var c=a,d=b.split(".");while(d.length)if(d[0]in c)c=c[d.shift()];else return null;return c}})(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.LinkedList=b.createClass({constructor:function(){this.tail=this.head={next:null},this.count=0},each:function(a){var b=this.head.next;while(b)a.call(null,b.val),b=b.next},append:function(a){var b={val:a,next:null};this.tail.next=b,this.tail=b,this.count++},removeVal:function(a){var b=this.head.next,c=this.head,d=!1;while(b)b.val===a?(b.next?c.next=b.next:(c.next=null,this.tail=c),this.count--,d=!0):c=b,b=b.next;return d}})}(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.Events=b.createClass({constructor:function(){this.subscribers={}},on:function(a,c){this.off(a,c);if(a instanceof Array)for(var d=0,e=a.length;d<e;d++)a[d]&&(this.subscribers[a[d]]||(this.subscribers[a[d]]=[]),this.subscribers[a[d]].push(c));else this.subscribers[a]||(this.subscribers[a]=new b.LinkedList),this.subscribers[a].append(c)},off:function(a,c){var d,e;if(a instanceof Array)for(d=0,e=a.length;d<e;d++)a[d]&&this.off(a[d],c);else this.subscribers[a]instanceof b.LinkedList&&this.subscribers[a].removeVal(c)},trigger:function(a,c){var d,e;if(a instanceof Array)for(d=0,e=a.length;d<e;d++)a[d]&&this.trigger(a[d],c);else this.subscribers[a]instanceof b.LinkedList&&this.subscribers[a].each(function(a){a.call(null,c)})}}),b.EventsMixin={on:function(a,b){return this.events.on(a,b)},off:function(a,b){return this.events.off(a,b)},trigger:function(a,b){return this.events.trigger(a,b)}}}(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.Model=b.createClass({mixins:b.EventsMixin},{constructor:function(){this.events=new b.Events,this.attrs={}},get:function(a){return this.attrs[a]},set:function(a,b,c){var d={};if(typeof a=="string"){if(this.get(a)===b)return;d[a]=b;if(typeof this.validate=="function"&&!this.validate(d))return;this.attrs[a]=b}else if(a===Object(a)){c=b,d=a;if(typeof this.validate=="function"&&!this.validate(d))return;for(var e in d)this.attrs[e]=d[e]}this.trigger("change",{changedAttributes:d})}})}(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.ServiceContainer=b.createClass({constructor:function(a){this.config=a||{parameters:{},services:{}},this.services={}},getService:function(a){if(!this.config.services[a])throw"Service "+a+" not defined";return this.config.services[a].shared?(typeof this.services[a]=="undefined"&&(this.services[a]=this.createService(a)),this.services[a]):this.createService(a)},existsService:function(a){return this.config.services.hasOwnProperty(a)},createService:function(a){var c,d,e,f,g,h,i,j;c=this.config.services[a],typeof c.constructor!="function"&&(c.constructor=b.evalObjectPath(c.constructor)),d=c.constructor,e=function(){},e.prototype=d.prototype,f=new e,g=d.apply(f,this.resolveParameters(c.args)),Object(g)===g&&(f=g),j=c.calls;if(j instanceof Array)for(h=0,i=j.length;h<i;h++)f[j[h].method].apply(f,this.resolveParameters(j[h].args));return f},resolveParameters:function(a){var b,c,d,e;e=this.config;if(typeof a=="string")a[0]==="@"?(a=a.slice(1),a.length===0?b=this:b=this.getService(a)):a.indexOf("%")!==-1?(a=a.replace(/%([^%]+)%/g,function(a,b){return e.parameters[b]?e.parameters[b]:null}),b=a):b=a;else if(a instanceof Array){b=[];for(c=0,d=a.length;c<d;c++)b[c]=this.resolveParameters(a[c])}else if(Object(a)===a){b={};for(c in a)b[c]=this.resolveParameters(a[c])}else b=a;return b}})}(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.View=b.createClass({mixins:b.EventsMixin,staticProperties:{DATA_VIEW_ATTR:"data-kff-view",DATA_OPTIONS_ATTR:"data-kff-options"}},{constructor:function(a){return this.events=new b.Events,this.options={element:null,events:[]},a.events&&(this.options.events=this.options.events.concat(a.events),delete a.events),$.extend(this.options,a),this.$element=$(this.options.element),this.subViews=[],this},delegateEvents:function(a,c){var d,e,f;this.undelegateEvents(),a=a||this.options.events,c=c||this.$element;for(e=0,f=a.length;e<f;e++)d=a[e],d.length===3?c.on(d[0],d[1],b.bindFn(this,d[2])):d.length===2&&c.on(d[0],b.bindFn(this,d[1]))},undelegateEvents:function(a,c){var d,e,f;a=a||this.options.events,c=c||this.$element;for(e=0,f=a.length;e<f;e++)d=a[e],d.length===3?c.off(d[0],d[1],b.bindFn(this,d[2])):d.length===2&&c.off(d[0],b.bindFn(this,d[1]))},init:function(){this.render()},destroy:function(a){this.destroySubviews(),this.undelegateEvents(),a||this.trigger("destroy")},render:function(a){this.delegateEvents(),this.renderSubviews(),a||this.trigger("init")},renderSubviews:function(){var a=[],c,d,e,f,g,h,i,j=this.options.filter||undefined,k=function(d){var e,f,g,h;if(d.hasChildNodes()){g=d.childNodes;for(e=0,f=g.length;e<f;e++)h=g[e],h.getAttribute&&(c=h.getAttribute(b.View.DATA_VIEW_ATTR),c?(!j||j&&$(h).is(j))&&a.push({objPath:c,$element:$(h)}):k(h))}};this.$element.get(0)&&k(this.$element.get(0));for(h=0,i=a.length;h<i;h++)d=b.evalObjectPath(a[h].objPath),d&&(g=a[h].$element.attr(b.View.DATA_OPTIONS_ATTR),f=g?JSON.parse(g):{},f.element=a[h].$element,f.parentView=this,e=new d(f),this.subViews.push(e),e.init())},destroySubviews:function(){var a,b,c;for(b=0,c=this.subViews.length;b<c;b++)a=this.subViews[b],a.destroy(),delete this.subViews[b];this.subViews=[]},refresh:function(){}}),b.PageView=b.createClass({extend:b.View,staticProperties:{precedingView:null}},{constructor:function(a){return a.element=$("body"),b.PageView._super.constructor.call(this,a)},delegateEvents:function(a,c){b.PageView._super.delegateEvents.call(this,a,c||$(document))},undelegateEvents:function(a,c){b.PageView._super.undelegateEvents.call(this,a,c||$(document))},setState:function(a,b){b||this.trigger("setState",a)}}),b.FrontController=b.createClass({constructor:function(){this.views=null,this.viewsQueue=[]},init:function(){},createViewFromState:function(a){return null},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(a){var c=this.getLastView();this.viewsQueue.push(a),c&&(c.on("init",b.bindFn(a,"init")),c.on("setState",b.bindFn(a,"setState")))},popView:function(){if(this.viewsQueue.length===0)return;var a=this.viewsQueue.pop(),c=this.getLastView();return a.off("init",b.bindFn(this,"cascadeState")),c&&(c.off("init",b.bindFn(a,"init")),c.off("setState",b.bindFn(a,"setState"))),a},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].setState(this.state)},setState:function(a){var c=[],d,e,f;this.state=a,this.newViewCtor=this.createViewFromState(a),d=this.getLastView()?this.getLastView().constructor:null,e=this.findSharedView(this.newViewCtor,d);while(d=this.getLastView()?this.getLastView().constructor:null){if(d===e)break;c.push(this.popView())}for(f=0;f<c.length;f++)c[f+1]?c[f].on("destroy",b.bindFn(c[f+1],"destroy")):c[f].on("destroy",b.bindFn(this,"startInit"));c[0]?c[0].destroy():this.startInit()},startInit:function(){var a,c,d=this.getPrecedingViews(this.newViewCtor),e=0;for(a=0,c=d.length;a<c;a++)a>=this.viewsQueue.length?this.pushView(new d[a](this)):e=a+1;this.newViewCtor=null,this.getLastView()&&this.getLastView().on("init",b.bindFn(this,"cascadeState")),this.viewsQueue[e]?this.viewsQueue[e].init():this.cascadeState()},findSharedView:function(a,b){var c,d=this.getPrecedingViews(a),e=this.getPrecedingViews(b),f=null;for(c=0,l=d.length<e.length?d.length:e.length;c<l;c++){if(d[c]!==e[c])break;f=d[c]}return f},getPrecedingViews:function(a){var c=a,d=[c];while(c)c=c.precedingView||null,typeof c=="string"&&(c=b.evalObjectPath(c)),c&&d.unshift(c);return d}})}(this);