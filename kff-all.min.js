(function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.widgets={},t.extend=function(e,t){var n=function(){};e._super=n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},t.mixins=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},t.createClass=function(e,n){var r;arguments.length===0?e=n={}:arguments.length===1&&(n=e,e={}),n.hasOwnProperty("constructor")?r=n.constructor:e.extend?r=function(){e.extend.apply(this,arguments)}:r=function(){},e.extend&&t.extend(r,e.extend),"mixins"in e?e.mixins instanceof Array||(e.mixins=[e.mixins]):e.mixins=[],e.mixins.push(t.classMixin);for(var i=0,s=e.mixins.length;i<s;i++)t.mixins(n,e.mixins[i]);return e.staticProperties&&t.mixins(r,e.staticProperties),t.mixins(r.prototype,n),r.prototype.constructor=r,r},t.bindFn=function(e,t){if(typeof e[t]!="function")throw new TypeError("Expected function: "+t+" (kff.bindFn)");return"_boundFns"in e||(e._boundFns={}),t in e._boundFns?e._boundFns[t]:(e._boundFns[t]=function(){return e[t].apply(e,arguments)},e._boundFns[t])},t.classMixin={f:function(e){var n=this;if(typeof e=="string")return t.bindFn(n,e);if(typeof e=="function")return function(){return e.apply(n,arguments)};throw new TypeError("Expected function: "+e+" (kff.f)")}},t.evalObjectPath=function(t,n){n=n||e;var r=t.split(".");while(r.length){if(!(r[0]in n))return null;n=n[r.shift()]}return n}})(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Events=t.createClass({constructor:function(){this.subscribers={},this.oneSubscribers={}},on:function(e,n){this.off(e,n);if(e instanceof Array)for(var r=0,i=e.length;r<i;r++)e[r]&&(this.subscribers[e[r]]||(this.subscribers[e[r]]=[]),this.subscribers[e[r]].push(n));else this.subscribers[e]||(this.subscribers[e]=new t.LinkedList),this.subscribers[e].append(n)},one:function(e,t){e in this.oneSubscribers||(this.oneSubscribers[e]=[]),this.oneSubscribers[e].push(t),this.on(e,t)},off:function(e,n){var r,i;if(e instanceof Array)for(r=0,i=e.length;r<i;r++)e[r]&&this.off(e[r],n);else this.subscribers[e]instanceof t.LinkedList&&this.subscribers[e].removeVal(n)},trigger:function(e,n){var r,i;if(e instanceof Array)for(r=0,i=e.length;r<i;r++)e[r]&&this.trigger(e[r],n);else if(this.subscribers[e]instanceof t.LinkedList){this.subscribers[e].each(function(e){e.call(null,n)});if(e in this.oneSubscribers){for(r=0,i=this.oneSubscribers[e].length;r<i;r++)this.off(e,this.oneSubscribers[e][r]);this.oneSubscribers[e]=[]}}}}),t.EventsMixin={on:function(e,t){return this.events.on(e,t)},one:function(e,t){return this.events.one(e,t)},off:function(e,t){return this.events.off(e,t)},trigger:function(e,t){return this.events.trigger(e,t)}}}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.LinkedList=t.createClass({constructor:function(){this.tail=this.head={next:null},this.count=0},each:function(e){var t=this.head.next;while(t){if(e.call(null,t.val)===!1)break;t=t.next}},append:function(e){var t={val:e,next:null};this.tail.next=t,this.tail=t,this.count++},removeVal:function(e){var t=this.head.next,n=this.head,r=!1;while(t)t.val===e?(t.next?n.next=t.next:(n.next=null,this.tail=n),this.count--,r=!0):n=t,t=t.next;return r},empty:function(){this.tail=this.head={next:null},this.count=0}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Collection=t.createClass({extend:t.LinkedList,mixins:t.EventsMixin},{constructor:function(e){return e=e||{},this.valFactory=e.valFactory||null,this.valType=e.valType||t.Model,this.serializeAttrs=e.serializeAttrs||null,this.events=new t.Events,t.LinkedList.call(this),this},append:function(e){t.Collection._super.append.call(this,e),this.trigger("change",{addedValue:e})},removeVal:function(e){var n=t.Collection._super.removeVal.call(this,e);return n&&this.trigger("change",{removedValue:e}),n},toJson:function(){var e=this.serializeAttrs,t=[];return this.each(function(n){n&&n.toJson?t.push(n.toJson(e)):t.push(n)}),t},fromJson:function(e){var t,n=this.valFactory;this.empty();for(var r=0;r<e.length;r++)n?t=n(e[r]):t=new this.valType,t.fromJson(e[r]),this.append(t);this.trigger("change",{fromJson:!0})},findByAttr:function(e,t){var n=null;return this.each(function(r){if(r&&r.get(e)===t)return n=r,!1}),n},empty:function(){t.Collection._super.empty.call(this),this.trigger("change")},sort:function(e){var t=[],n,r;this.each(function(e){t.push(e)}),t.sort(e),this.empty();for(var i=0;i<t.length;i++)this.append(t[i]);this.trigger("change")},clone:function(){var e=new t.Collection(this.options);return this.each(function(t){e.append(t)}),e},shuffle:function(){var e=[],t,n,r,i,s,o;this.each(function(t){e.push(t)}),r=e.length,i=r;while(i--)s=parseInt(Math.random()*r,10),o=e[i],e[i]=e[s],e[s]=o;this.empty();for(i=0;i<e.length;i++)this.append(e[i]);this.trigger("change")}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Model=t.createClass({mixins:t.EventsMixin},{constructor:function(){this.events=new t.Events,this.attrs={}},has:function(e){return e in this.attrs},get:function(e){return this.attrs[e]},set:function(e,t,n){var r={};if(typeof e=="string"){if(this.get(e)===t)return;r[e]=t;if(typeof this.validate=="function"&&!this.validate(r))return;this.attrs[e]=t}else if(e===Object(e)){n=t,r=e;if(typeof this.validate=="function"&&!this.validate(r))return;for(var i in r)this.attrs[i]=r[i]}for(var s in r)this.trigger("change:"+s,{changedAttributes:r});this.trigger("change",{changedAttributes:r})},toJson:function(e){var t={};for(var n in this.attrs)(!e||$.inArray(n,e)!==-1)&&this.attrs.hasOwnProperty(n)&&(this.attrs[n]&&typeof this.attrs[n]=="object"&&"toJson"in this.attrs[n]?t[n]=this.attrs[n].toJson():t[n]=this.attrs[n]);return t},fromJson:function(e){var t={};for(var n in this.attrs)this.attrs.hasOwnProperty(n)&&e.hasOwnProperty(n)&&(this.attrs[n]&&typeof this.attrs[n]=="object"&&"fromJson"in this.attrs[n]?this.attrs[n].fromJson(e[n]):this.attrs[n]=e[n]);this.set(this.attrs)}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.ServiceContainer=t.createClass({staticProperties:{singleParamRegex:/^%[^%]+%$/g,multipleParamsRegex:/%([^%]+)%/g}},{constructor:function(e){this.config=e||{parameters:{},services:{}},this.services={},this.cachedParams={}},getService:function(e){if(!this.config.services[e])throw"Service "+e+" not defined";return this.config.services[e].shared?(typeof this.services[e]=="undefined"&&(this.services[e]=this.createService(e)),this.services[e]):this.createService(e)},hasService:function(e){return this.config.services.hasOwnProperty(e)},createService:function(e){var t,n,r,i,s,o,u,a;t=this.config.services[e],n=this.getServiceConstructor(e),r=function(){},r.prototype=n.prototype,i=new r,s=n.apply(i,this.resolveParameters(t.args||[])),Object(s)===s&&(i=s),a=t.calls;if(a instanceof Array)for(o=0,u=a.length;o<u;o++)i[a[o].method].apply(i,this.resolveParameters(a[o].args));return i},getServiceConstructor:function(e){var n,r;n=this.config.services[e];if(!n)return null;n.hasOwnProperty("constructor")?typeof n.constructor=="string"&&(n.constructor=t.evalObjectPath(n.constructor)):(r=t.evalObjectPath(e),typeof r=="function"&&(n.constructor=r));if(typeof n.constructor!="function")throw new TypeError("expected function in getServiceConstructor: "+n.constructor);return n.constructor},resolveParameters:function(e){var n,r,i,s;s=this.config;if(typeof e=="string")e.charAt(0)==="@"?(e=e.slice(1),e.length===0?n=this:n=this.getService(e)):this.cachedParams[e]!==undefined?n=this.cachedParams[e]:(e.search(t.ServiceContainer.singleParamRegex)!==-1?n=s.parameters[e.slice(1,-1)]:(n=e.replace("%%","escpersign"),n=n.replace(t.ServiceContainer.multipleParamsRegex,function(e,t){return s.parameters[t]?s.parameters[t]:""}),n=n.replace("escpersign","%")),this.cachedParams[e]=n);else if(e instanceof Array){n=[];for(r=0,i=e.length;r<i;r++)n[r]=this.resolveParameters(e[r])}else if(typeof e!="function"&&Object(e)===e){n={};for(r in e)n[r]=this.resolveParameters(e[r])}else n=e;return n}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.View=t.createClass({mixins:t.EventsMixin,staticProperties:{DATA_VIEW_ATTR:"data-kff-view",DATA_OPTIONS_ATTR:"data-kff-options",DATA_RENDERED_ATTR:"data-kff-rendered"}},{constructor:function(e){return e=e||{},this.events=new t.Events,this.options={element:null,events:[]},this.setOptions(e),this.viewFactory=e.viewFactory||new t.ViewFactory,this.subViews=[],this},setOptions:function(e){e=e||{},e.events&&(this.options.events=this.options.events.concat(e.events),delete e.events),e.element&&(this.$element=$(e.element),delete e.element),e.viewFactory&&(this.viewFactory=e.viewFactory,delete e.viewFactory),$.extend(this.options,e)},delegateEvents:function(e,n){var r,i,s;this.undelegateEvents(),e=e||this.options.events,n=n||this.$element;for(i=0,s=e.length;i<s;i++)r=e[i],r.length===3?n.on(r[0],r[1],t.bindFn(this,r[2])):r.length===2&&n.on(r[0],t.bindFn(this,r[1]))},undelegateEvents:function(e,n){var r,i,s;e=e||this.options.events,n=n||this.$element;for(i=0,s=e.length;i<s;i++)r=e[i],r.length===3?n.off(r[0],r[1],t.bindFn(this,r[2])):r.length===2&&n.off(r[0],t.bindFn(this,r[1]))},init:function(){this.render()},destroy:function(e){this.destroySubviews(),this.undelegateEvents(),e||this.trigger("destroy")},render:function(e){this.delegateEvents(),this.renderSubviews(),e||this.trigger("init")},renderSubviews:function(){var e=[],n,r,i,s,o,u,a,f,l=this.options.filter||undefined,c=function(r){var i,s,o,u;if(r.hasChildNodes()){o=r.childNodes;for(i=0,s=o.length;i<s;i++)u=o[i],u.getAttribute&&(f=u.getAttribute(t.View.DATA_RENDERED_ATTR),f||(n=u.getAttribute(t.View.DATA_VIEW_ATTR),n?(!l||l&&$(u).is(l))&&e.push({objPath:n,$element:$(u)}):c(u)))}};this.$element.get(0)&&c(this.$element.get(0));for(u=0,a=e.length;u<a;u++)n=e[u].objPath,o=e[u].$element.attr(t.View.DATA_OPTIONS_ATTR),s=o?JSON.parse(o):{},s.element=e[u].$element,s.parentView=this,i=this.viewFactory.createView(n,s),i instanceof t.View&&(i.viewFactory=this.viewFactory,this.subViews.push(i),i.init(),e[u].$element.attr(t.View.DATA_RENDERED_ATTR,!0))},destroySubviews:function(){var e,n,r;for(n=0,r=this.subViews.length;n<r;n++)e=this.subViews[n],e.$element&&e.$element.removeAttr(t.View.DATA_RENDERED_ATTR),e.destroy(),delete this.subViews[n];this.subViews=[]},refresh:function(){}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.PageView=t.createClass({extend:t.View,staticProperties:{precedingView:null}},{constructor:function(e){return e=e||{},e.element=$("body"),t.PageView._super.constructor.call(this,e)},delegateEvents:function(e,n){t.PageView._super.delegateEvents.call(this,e,n||$(document))},undelegateEvents:function(e,n){t.PageView._super.undelegateEvents.call(this,e,n||$(document))},setState:function(e,t){t||this.trigger("setState",e)}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.ViewFactory=t.createClass({constructor:function(e){e=e||{},this.serviceContainer=e.serviceContainer||null,this.precedingViews=e.precedingViews||{}},createView:function(e,n){var r=null,i;return n=n||{},typeof e!="function"&&this.serviceContainer&&this.serviceContainer.hasService(e)?r=this.serviceContainer.getService(e):(typeof e!="function"?i=t.evalObjectPath(e):i=e,i&&(r=new i({viewFactory:this}))),r instanceof t.View&&r.setOptions(n),r},getServiceConstructor:function(e){return typeof e=="function"?e:this.serviceContainer&&this.serviceContainer.hasService(e)?this.serviceContainer.getServiceConstructor(e):t.evalObjectPath(e)},getPrecedingView:function(e){var t;return typeof e=="string"&&this.precedingViews[e]!==undefined?this.precedingViews[e]:(t=this.getServiceConstructor(e),t&&t.precedingView?t.precedingView:null)}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Route=t.createClass({constructor:function(e,t){this.pattern=e,this.target=t,this.keys=null,this.regexp=this.compileRegex()},getTarget:function(){return this.target},match:function(e,t){var n=this.keys,r=e.indexOf("?"),i=~r?e.slice(0,r):e,s=this.regexp.exec(i);if(!s)return!1;for(var o=1,u=s.length;o<u;++o){var a=n[o-1],f="string"==typeof s[o]?decodeURIComponent(s[o]):s[o];a?t[a.name]=undefined!==t[a.name]?t[a.name]:f:t.push(f)}return!0},compileRegex:function(e,t){var n=this.keys=[],r;return r=this.pattern.concat(t?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(e,t,r,i,s,o){return n.push({name:i,optional:!!o}),t=t||"",""+(o?"":t)+"(?:"+(o?t:"")+(r||"")+(s||r&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),new RegExp("^"+r+"$",e?"":"i")}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Router=t.createClass({constructor:function(e){this.options=e||{},this.routes=[],this.buildRoutes()},buildRoutes:function(){this.routes=[];var e=this.options.routes;for(var n in e)this.routes.push(new t.Route(n,e[n]))},match:function(e){var t;for(var n=0,r=this.routes.length;n<r;n++){t=[];if(this.routes[n].match(e,t))return{target:this.routes[n].getTarget(),params:t}}return null}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.FrontController=t.createClass({constructor:function(e){e=e||{},this.views=null,this.viewsQueue=[],this.viewFactory=e.viewFactory||new t.ViewFactory},init:function(){},createViewFromState:function(e){return null},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(e){var n=this.getLastView();this.viewsQueue.push(e),n&&(n.instance.on("init",t.bindFn(e.instance,"init")),n.instance.on("setState",t.bindFn(e.instance,"setState")))},popView:function(){if(this.viewsQueue.length===0)return;var e=this.viewsQueue.pop(),n=this.getLastView();return e.instance.off("init",t.bindFn(this,"cascadeState")),n&&(n.instance.off("init",t.bindFn(e.instance,"init")),n.instance.off("setState",t.bindFn(e.instance,"setState"))),e},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].instance.setState(this.state)},setState:function(e){var n=[],r,i,s;this.state=e,this.newViewCtor=this.createViewFromState(e),r=this.getLastView()?this.getLastView().name:null,i=this.findSharedView(this.newViewCtor,r);while((r=this.getLastView()?this.getLastView().name:null)!==null){if(r===i)break;n.push(this.popView())}for(s=0;s<n.length;s++)n[s+1]?n[s].instance.on("destroy",t.bindFn(n[s+1].instance,"destroy")):n[s].instance.on("destroy",t.bindFn(this,"startInit"));n[0]?n[0].instance.destroy():this.startInit()},startInit:function(){var e,n,r=this.getPrecedingViews(this.newViewCtor),i=0;for(e=0,n=r.length;e<n;e++)e>=this.viewsQueue.length?this.pushView({name:r[e],instance:this.viewFactory.createView(r[e],{viewFactory:this.viewFactory})}):i=e+1;this.newViewCtor=null,this.getLastView()&&this.getLastView().instance.on("init",t.bindFn(this,"cascadeState")),this.viewsQueue[i]?this.viewsQueue[i].instance.init():this.cascadeState()},findSharedView:function(e,t){var n,r=this.getPrecedingViews(e),i=this.getPrecedingViews(t),s=null;for(n=0,l=r.length<i.length?r.length:i.length;n<l;n++){if(r[n]!==i[n])break;s=r[n]}return s},getPrecedingViews:function(e){var t=e,n=[t];while(t)t=this.viewFactory.getPrecedingView(t),t&&n.unshift(t);return n}})}(this);