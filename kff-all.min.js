(function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.widgets={},t.extend=function(e,t){var n=function(){};e._super=n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},t.mixins=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},t.createClass=function(e,n){var r;arguments.length===0?e=n={}:arguments.length===1&&(n=e,e={}),n.hasOwnProperty("constructor")?r=n.constructor:e.extend?r=function(){e.extend.apply(this,arguments)}:r=function(){},e.extend&&t.extend(r,e.extend),"mixins"in e?e.mixins instanceof Array||(e.mixins=[e.mixins]):e.mixins=[],e.mixins.push(t.classMixin);for(var i=0,s=e.mixins.length;i<s;i++)t.mixins(n,e.mixins[i]);return e.staticProperties&&t.mixins(r,e.staticProperties),t.mixins(r.prototype,n),r.prototype.constructor=r,r},t.bindFn=function(e,t){if(typeof e[t]!="function")throw new TypeError("Expected function: "+t+" (kff.bindFn)");return"_boundFns"in e||(e._boundFns={}),t in e._boundFns?e._boundFns[t]:(e._boundFns[t]=function(){return e[t].apply(e,arguments)},e._boundFns[t])},t.classMixin={f:function(e){var n=this;if(typeof e=="string")return t.bindFn(n,e);if(typeof e=="function")return function(){return e.apply(n,arguments)};throw new TypeError("Expected function: "+e+" (kff.f)")}},t.evalObjectPath=function(t,n){n=n||e;var r=t.split(".");while(r.length){if(!(r[0]in n))return null;n=n[r.shift()]}return n}})(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Events=t.createClass({constructor:function(){this.subscribers={},this.oneSubscribers={}},on:function(e,n){this.off(e,n);if(e instanceof Array)for(var r=0,i=e.length;r<i;r++)e[r]&&(this.subscribers[e[r]]||(this.subscribers[e[r]]=[]),this.subscribers[e[r]].push(n));else this.subscribers[e]||(this.subscribers[e]=new t.LinkedList),this.subscribers[e].append(n)},one:function(e,t){e in this.oneSubscribers||(this.oneSubscribers[e]=[]),this.oneSubscribers[e].push(t),this.on(e,t)},off:function(e,n){var r,i;if(e instanceof Array)for(r=0,i=e.length;r<i;r++)e[r]&&this.off(e[r],n);else this.subscribers[e]instanceof t.LinkedList&&this.subscribers[e].removeVal(n)},trigger:function(e,n){var r,i;if(e instanceof Array)for(r=0,i=e.length;r<i;r++)e[r]&&this.trigger(e[r],n);else if(this.subscribers[e]instanceof t.LinkedList){this.subscribers[e].each(function(e){e.call(null,n)});if(e in this.oneSubscribers){for(r=0,i=this.oneSubscribers[e].length;r<i;r++)this.off(e,this.oneSubscribers[e][r]);this.oneSubscribers[e]=[]}}}}),t.EventsMixin={on:function(e,t){return this.events.on(e,t)},one:function(e,t){return this.events.one(e,t)},off:function(e,t){return this.events.off(e,t)},trigger:function(e,t){return this.events.trigger(e,t)}}}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.LinkedList=t.createClass({constructor:function(){this.tail=this.head={next:null},this.count=0},each:function(e){var t=this.head.next,n=0;while(t){if(e.call(null,t.val,n)===!1)break;t=t.next,n++}},append:function(e){var t={val:e,next:null};this.tail.next=t,this.tail=t,this.count++},removeVal:function(e){var t=this.head.next,n=this.head,r=!1;while(t)t.val===e?(t.next?n.next=t.next:(n.next=null,this.tail=n),this.count--,r=!0):n=t,t=t.next;return r},empty:function(){this.tail=this.head={next:null},this.count=0}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Collection=t.createClass({extend:t.LinkedList,mixins:t.EventsMixin},{constructor:function(e){return e=e||{},this.valFactory=e.valFactory||null,this.valType=e.valType||t.Model,this.serializeAttrs=e.serializeAttrs||null,this.events=new t.Events,t.LinkedList.call(this),this},append:function(e){t.Collection._super.append.call(this,e),this.trigger("change",{addedValue:e})},removeVal:function(e){var n=t.Collection._super.removeVal.call(this,e);return n&&this.trigger("change",{removedValue:e}),n},toJson:function(){var e=this.serializeAttrs,t=[];return this.each(function(n){n&&n.toJson?t.push(n.toJson(e)):t.push(n)}),t},fromJson:function(e){var t,n=this.valFactory;this.empty();for(var r=0;r<e.length;r++)n?t=n(e[r]):t=new this.valType,t.fromJson(e[r]),this.append(t);this.trigger("change",{fromJson:!0})},findByAttr:function(e,t){var n=null;return this.each(function(r){if(r&&r.get(e)===t)return n=r,!1}),n},findByIndex:function(e){var t=null,n=0;return this.each(function(r){if(n===e)return t=r,!1;n++}),t},empty:function(){t.Collection._super.empty.call(this),this.trigger("change")},sort:function(e){var t=[],n,r;this.each(function(e){t.push(e)}),t.sort(e),this.empty();for(var i=0;i<t.length;i++)this.append(t[i]);this.trigger("change")},clone:function(){var e=new t.Collection(this.options);return this.each(function(t){e.append(t)}),e},shuffle:function(){var e=[],t,n,r,i,s,o;this.each(function(t){e.push(t)}),r=e.length,i=r;while(i--)s=parseInt(Math.random()*r,10),o=e[i],e[i]=e[s],e[s]=o;this.empty();for(i=0;i<e.length;i++)this.append(e[i]);this.trigger("change")}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Model=t.createClass({mixins:t.EventsMixin},{constructor:function(){this.events=new t.Events,this.attrs={}},has:function(e){return e in this.attrs},get:function(e){return this.attrs[e]},mget:function(e){var n;return typeof e=="string"&&(e=e.split(".")),n=this.get(e.shift()),e.length>0?n instanceof t.Model?n.mget(e):t.evalObjectPath(e,n):n},set:function(e,t,n){var r={};if(typeof e=="string"){if(this.get(e)===t)return;r[e]=t;if(typeof this.validate=="function"&&!this.validate(r))return;this.attrs[e]=t}else if(e===Object(e)){n=t,r=e;if(typeof this.validate=="function"&&!this.validate(r))return;for(var i in r)this.attrs[i]=r[i]}for(var s in r)this.trigger("change:"+s,{changedAttributes:r});this.trigger("change",{changedAttributes:r})},toJson:function(e){var t={};for(var n in this.attrs)(!e||$.inArray(n,e)!==-1)&&this.attrs.hasOwnProperty(n)&&(this.attrs[n]&&typeof this.attrs[n]=="object"&&"toJson"in this.attrs[n]?t[n]=this.attrs[n].toJson():t[n]=this.attrs[n]);return t},fromJson:function(e){if(!e)return;var t={};for(var n in this.attrs)this.attrs.hasOwnProperty(n)&&e.hasOwnProperty(n)&&(this.attrs[n]&&typeof this.attrs[n]=="object"&&"fromJson"in this.attrs[n]?this.attrs[n].fromJson(e[n]):this.attrs[n]=e[n]);this.set(this.attrs)}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.ServiceContainer=t.createClass({staticProperties:{singleParamRegex:/^%[^%]+%$/g,multipleParamsRegex:/%([^%]+)%/g}},{constructor:function(e){this.config=e||{parameters:{},services:{}},this.services={},this.cachedParams={}},getService:function(e){if(!this.config.services[e])throw"Service "+e+" not defined";return this.config.services[e].shared?(typeof this.services[e]=="undefined"&&(this.services[e]=this.createService(e)),this.services[e]):this.createService(e)},hasService:function(e){return this.config.services.hasOwnProperty(e)},createService:function(e){var t,n,r,i,s,o,u,a;t=this.config.services[e],n=this.getServiceConstructor(e),r=function(){},r.prototype=n.prototype,i=new r,s=n.apply(i,this.resolveParameters(t.args||[])),Object(s)===s&&(i=s),a=t.calls;if(a instanceof Array)for(o=0,u=a.length;o<u;o++)i[a[o].method].apply(i,this.resolveParameters(a[o].args));return i},getServiceConstructor:function(e){var n,r;n=this.config.services[e];if(!n)return null;n.hasOwnProperty("constructor")?typeof n.constructor=="string"&&(n.constructor=t.evalObjectPath(n.constructor)):(r=t.evalObjectPath(e),typeof r=="function"&&(n.constructor=r));if(typeof n.constructor!="function")throw new TypeError("expected function in getServiceConstructor: "+n.constructor);return n.constructor},resolveParameters:function(e){var n,r,i,s;s=this.config;if(typeof e=="string")e.charAt(0)==="@"?(e=e.slice(1),e.length===0?n=this:n=this.getService(e)):this.cachedParams[e]!==undefined?n=this.cachedParams[e]:(e.search(t.ServiceContainer.singleParamRegex)!==-1?n=s.parameters[e.slice(1,-1)]:(n=e.replace("%%","escpersign"),n=n.replace(t.ServiceContainer.multipleParamsRegex,function(e,t){return s.parameters[t]?s.parameters[t]:""}),n=n.replace("escpersign","%")),this.cachedParams[e]=n);else if(e instanceof Array){n=[];for(r=0,i=e.length;r<i;r++)n[r]=this.resolveParameters(e[r])}else if(typeof e!="function"&&Object(e)===e){n={};for(r in e)n[r]=this.resolveParameters(e[r])}else n=e;return n}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.View=t.createClass({mixins:t.EventsMixin,staticProperties:{DATA_VIEW_ATTR:"data-kff-view",DATA_OPTIONS_ATTR:"data-kff-options",DATA_RENDERED_ATTR:"data-kff-rendered",DATA_BIND_ATTR:"data-kff-bind"}},{constructor:function(e){return e=e||{},this.events=new t.Events,this.options={element:null,models:null,events:[]},this.models={},this.setOptions(e),this.viewFactory=e.viewFactory||new t.ViewFactory,this.subViews=[],this},setOptions:function(e){e=e||{},e.events&&(this.options.events=this.options.events.concat(e.events),delete e.events),e.element&&(this.$element=$(e.element),delete e.element),e.viewFactory&&(this.viewFactory=e.viewFactory,delete e.viewFactory),e.parentView&&(this.parentView=e.parentView),e.models&&(this.models=e.models,delete e.models),$.extend(this.options,e)},getModel:function(e){var t;return typeof e=="string"&&(e=e.split(".")),t=e.shift(),this.models&&t in this.models?e.length>0?this.models[t].mget(e):this.models[t]:this.options.parentView?(e.unshift(t),this.options.parentView.getModel(e)):null},delegateEvents:function(e,n){var r,i,s;this.undelegateEvents(),e=e||this.options.events,n=n||this.$element;for(i=0,s=e.length;i<s;i++)r=e[i],r.length===3?n.on(r[0],r[1],t.bindFn(this,r[2])):r.length===2&&n.on(r[0],t.bindFn(this,r[1]))},undelegateEvents:function(e,n){var r,i,s;e=e||this.options.events,n=n||this.$element;for(i=0,s=e.length;i<s;i++)r=e[i],r.length===3?n.off(r[0],r[1],t.bindFn(this,r[2])):r.length===2&&n.off(r[0],t.bindFn(this,r[1]))},addEvents:function(e){this.options.events=this.options.events.concat(e)},init:function(){this.render()},destroy:function(e){this.destroySubviews(),this.undelegateEvents(),e||this.trigger("destroy")},render:function(e){this.delegateEvents(),this.renderSubviews(),e||this.trigger("init")},renderSubviews:function(){var e=[],n,r,i,s,o,u,a,f,l=this.options.filter||undefined,c=function(r){var i,s,o,u;if(r.hasChildNodes()){o=r.childNodes;for(i=0,s=o.length;i<s;i++)u=o[i],u.getAttribute&&(f=u.getAttribute(t.View.DATA_RENDERED_ATTR),f||(n=u.getAttribute(t.View.DATA_VIEW_ATTR),!n&&u.getAttribute(t.View.DATA_BIND_ATTR)&&(n="kff.BindingView",u.setAttribute(t.View.DATA_VIEW_ATTR,n)),n?(!l||l&&$(u).is(l))&&e.push({objPath:n,$element:$(u)}):c(u)))}};this.$element.get(0)&&c(this.$element.get(0));for(u=0,a=e.length;u<a;u++)n=e[u].objPath,o=e[u].$element.attr(t.View.DATA_OPTIONS_ATTR),s=o?JSON.parse(o):{},s.element=e[u].$element,s.parentView=this,i=this.viewFactory.createView(n,s),i instanceof t.View&&(i.viewFactory=this.viewFactory,this.subViews.push(i),i.init(),e[u].$element.attr(t.View.DATA_RENDERED_ATTR,!0))},destroySubviews:function(){var e,n,r;for(n=0,r=this.subViews.length;n<r;n++)e=this.subViews[n],e.$element&&e.$element.removeAttr(t.View.DATA_RENDERED_ATTR),e.destroy(),delete this.subViews[n];this.subViews=[]},refresh:function(){}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.PageView=t.createClass({extend:t.View,staticProperties:{precedingView:null}},{constructor:function(e){return e=e||{},e.element=$("body"),t.PageView._super.constructor.call(this,e)},delegateEvents:function(e,n){t.PageView._super.delegateEvents.call(this,e,n||$(document))},undelegateEvents:function(e,n){t.PageView._super.undelegateEvents.call(this,e,n||$(document))},setState:function(e,t){t||this.trigger("setState",e)}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.BindingView=t.createClass({extend:t.View,staticProperties:{binders:{}}},{constructor:function(e){e=e||{},this.modelBinders={},this.collectionBinder=null,this.values={},this.formatters=[],this.parsers=[],t.View.call(this,e)},render:function(e){this.initBinding(),this.collectionBinder&&this.renderBoundViews(),t.BindingView._super.render.call(this,e),this.modelChange()},modelChange:function(){for(var e in this.modelBinders)for(var t=0,n=this.modelBinders[e],r=n.length;t<r;t++)n[t].modelChange()},destroy:function(e){this.destroyBinding(),t.BindingView._super.destroy.call(this,!0),this.destroyBoundViews(),e||this.trigger("destroy")},initBinding:function(){var e,n,r,i,s,o,u,a,f,l,c,h=this.$element.attr(t.View.DATA_BIND_ATTR),p=/([.a-zA-Z0-9]+):?([a-zA-Z0-9]+)?(\([a-zA-Z0-9,\s\*]*\))?:?([a-zA-Z0-9]+\([a-zA-Z0-9,\s]*\))?:?([a-zA-Z0-9]+\([a-zA-Z0-9,\s]*\))?:?([a-zA-Z0-9]+\([a-zA-Z0-9,\s]*\))?/g;this.modelBinders=[];while((r=p.exec(h))!==null){s=r[1],s=s.replace(/^\./,"*.").split("."),o=r[2],u=r[3],u?u=u.slice(1,-1).split(/\s*,\s*/):u=[],a=[],f=[];for(var d=4,v=r.length;d<v&&r[d];d++){i=r[d].match(/([a-zA-Z0-9]+)\(([a-zA-Z0-9\s,]*)\)/),l=i[1],c=[],i[2]&&(c=i[2].split(/\s*,\s*/));switch(l){case"f":this.parseModifiers(c,a);break;case"p":this.parseModifiers(c,f)}}e=this.getModel([].concat(s));if(e instanceof t.Collection)this.options.isBoundView||(this.collectionBinder={collection:e},this.renderSubViews=function(){});else{if(!o)break;n=s.pop(),e=this.getModel(s);if(e instanceof t.Model){o in this.modelBinders||(this.modelBinders[o]=[],this.values[o]=[]);var m=this.modelBinders[o].length,g=new t.BindingView.binders[o]({view:this,$element:this.$element,bindingIndex:this.options.bindingIndex,valueIndex:m,values:this.values[o],params:u,attr:n,model:e,formatters:a,parsers:f});this.modelBinders[o].push(g),this.values[o].push(null),g.init()}}}},parseModifiers:function(e,n){for(var r=0;r<e.length;r++)t.View.helpers[e[r]]&&n.push(t.View.helpers[e[r]])},destroyBinding:function(){for(var e in this.modelBinders)for(var t=0,n=this.modelBinders[e],r=n.length;t<r;t++)n[t].destroy();this.modelBinders={},this.values={}},renderBoundViews:function(){var e=document.createTextNode("");$.browser&&$.browser.msie&&$.browser.version<9&&(e=$("<span/>")),this.$anchor=$(e),this.$element.before(this.$anchor),this.$element.detach(),this.subViewName=this.$element.attr(t.View.DATA_VIEW_ATTR);var n=this.$element.attr(t.View.DATA_OPTIONS_ATTR);this.subViewOptions=n?JSON.parse(n):{},this.subViewOptions.parentView=this,this.collectionBinder.collection.on("change",this.f("refreshBoundViews")),this.refreshBoundViews()},destroyBoundViews:function(){this.$elements&&this.$elements.remove(),this.$elements=null,this.$anchor&&(this.$anchor.after(this.$element),this.$anchor.remove())},refreshBoundViews:function(){this.destroySubviews(),this.$elements&&this.$elements.remove(),this.$elements=$([]),this.collectionBinder.collection.each(this.f(function(e,t){this.$elements=this.$elements.add(this.createSubView(e,t))})),this.$anchor.after(this.$elements)},createSubView:function(e,n){var r=this.$element.clone();this.subViewOptions.element=r,this.subViewOptions.models={"*":e},this.subViewOptions.bindingIndex=n,this.subViewOptions.isBoundView=!0;var i=this.viewFactory.createView(this.subViewName,this.subViewOptions);return i instanceof t.View&&(i.viewFactory=this.viewFactory,this.subViews.push(i),i.init(),r.attr(t.View.DATA_RENDERED_ATTR,!0),i.refresh()),r},getModel:function(e){var n;return typeof e=="string"&&(e=e.split(".")),n=parseInt(e[0]),this.collectionBinder&&!isNaN(n)?this.collectionBinder.collection.findByIndex(n):t.BindingView._super.getModel.call(this,e)},concat:function(e){return e.length===1?e[0]:e.join(" ")}}),t.Binder=t.createClass({constructor:function(e){this.options=e,this.options.events=this.options.events||[],this.view=e.view,this.$element=e.$element,this.attr=e.attr,this.model=e.model,this.parsers=e.parsers,this.formatters=e.formatters,this.values=e.values,this.valueIndex=e.valueIndex,this.params=e.params,this.currentValue=null},init:function(){this.model.on("change"+(this.attr===null?"":":"+this.attr),this.f("modelChange")),this.delegateEvents.call(this,this.options.events)},destroy:function(){this.model.off("change"+(this.attr===null?"":":"+this.attr),this.f("modelChange")),this.undelegateEvents.call(this,this.options.events)},delegateEvents:t.View.prototype.delegateEvents,undelegateEvents:t.View.prototype.undelegateEvents,modelChange:function(){var e=this.model.get(this.attr);this.compareValues(e,this.currentValue)||(this.values[this.valueIndex]=this.format(e),this.currentValue=e,this.refresh())},compareValues:function(e,t){if(e instanceof Array&&t instanceof Array){var n=e.length;if(n!==t.length)return!1;for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}return e===t},getFormattedValue:function(){return this.values.length>1?this.values.join(" "):this.values[this.valueIndex]},updateModel:function(e){var t,n;if(e instanceof Array)for(t=0,n=e.length;t<n;t++)e[t]=this.parse(e[t]);else e=this.parse(e);this.currentValue=e,this.model.set(this.attr,this.currentValue)},refresh:function(e){},format:function(e){for(var t=0,n=this.formatters.length;t<n;t++)e=this.formatters[t].call(this,e);return e},parse:function(e){for(var t=0,n=this.parsers.length;t<n;t++)e=this.parsers[t].call(this,e);return e}}),t.ValueBinder=t.createClass({extend:t.Binder},{constructor:function(e){e=e||{},e.events=[["keypress drop change","inputChange"]],t.Binder.call(this,e)},inputChange:function(e){setTimeout(this.f(function(){this.updateModel(this.$element.val())}),0)},refresh:function(){this.$element.val(this.getFormattedValue())}}),t.CheckBinder=t.createClass({extend:t.Binder},{constructor:function(e){e=e||{},e.events=[["click change","inputChange"]],t.Binder.call(this,e)},inputChange:function(e){setTimeout(this.f(function(){this.updateModel(this.$element.is(":checked"))}),0)},refresh:function(){this.$element.prop("checked",!!this.values[this.valueIndex])}}),t.RadioBinder=t.createClass({extend:t.Binder},{constructor:function(e){e=e||{},e.events=[["click","inputChange"]],t.Binder.call(this,e)},inputChange:function(e){setTimeout(this.f(function(){this.$element.is(":checked")&&this.updateModel(this.$element.val())}),0)},refresh:function(){this.$element.prop("checked",this.parse(this.$element.val())===this.currentValue)}}),t.TextBinder=t.createClass({extend:t.Binder},{init:function(){t.TextBinder._super.init.call(this)},refresh:function(e){this.$element.text(this.values.join(" "))}}),t.HtmlBinder=t.createClass({extend:t.Binder},{refresh:function(){this.$element.html(this.values.join(" "))}}),t.ClassBinder=t.createClass({extend:t.Binder},{init:function(){this.className=this.params[0]||null,t.ClassBinder._super.init.call(this)},refresh:function(){this.className&&this.$element[this.values[this.valueIndex]?"addClass":"removeClass"](this.className)}}),t.AttrBinder=t.createClass({extend:t.Binder},{init:function(){this.attribute=this.params[0]||null,t.AttrBinder._super.init.call(this)},refresh:function(){this.attribute&&this.$element.attr(this.attribute,this.getFormattedValue())}}),t.View.helpers={index:function(e){return this.options&&this.options.bindingIndex?this.options.bindingIndex:e},not:function(e){return!e},"int":function(e){return e=parseInt(e,10),isNaN(e)&&(e=0),e},"float":function(e){return e=parseFloat(e),isNaN(e)&&(e=0),e},"boolean":function(e){var t=parseInt(e);return isNaN(t)?e==="true":!!t},uppercase:function(e){return(e||"").toUpperCase()},lowercase:function(e){return(e||"").toLowerCase()},strong:function(e){return"<strong>"+e+"</strong>"}},t.BindingView.binders.text=t.TextBinder,t.BindingView.binders["class"]=t.ClassBinder,t.BindingView.binders.val=t.ValueBinder,t.BindingView.binders.check=t.CheckBinder,t.BindingView.binders.radio=t.RadioBinder,t.BindingView.binders.html=t.HtmlBinder}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.ViewFactory=t.createClass({constructor:function(e){e=e||{},this.serviceContainer=e.serviceContainer||null,this.precedingViews=e.precedingViews||{}},createView:function(e,n){var r=null,i;return n=n||{},typeof e!="function"&&this.serviceContainer&&this.serviceContainer.hasService(e)?r=this.serviceContainer.getService(e):(typeof e!="function"?i=t.evalObjectPath(e):i=e,i&&(r=new i({viewFactory:this}))),r instanceof t.View&&r.setOptions(n),r},getServiceConstructor:function(e){return typeof e=="function"?e:this.serviceContainer&&this.serviceContainer.hasService(e)?this.serviceContainer.getServiceConstructor(e):t.evalObjectPath(e)},getPrecedingView:function(e){var t;return typeof e=="string"&&this.precedingViews[e]!==undefined?this.precedingViews[e]:(t=this.getServiceConstructor(e),t&&t.precedingView?t.precedingView:null)}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Route=t.createClass({constructor:function(e,t){this.pattern=e,this.target=t,this.keys=null,this.regexp=this.compileRegex()},getTarget:function(){return this.target},match:function(e,t){var n=this.keys,r=e.indexOf("?"),i=~r?e.slice(0,r):e,s=this.regexp.exec(i);if(!s)return!1;for(var o=1,u=s.length;o<u;++o){var a=n[o-1],f="string"==typeof s[o]?decodeURIComponent(s[o]):s[o];a?t[a.name]=undefined!==t[a.name]?t[a.name]:f:t.push(f)}return!0},compileRegex:function(e,t){var n=this.keys=[],r;return r=this.pattern.concat(t?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(e,t,r,i,s,o){return n.push({name:i,optional:!!o}),t=t||"",""+(o?"":t)+"(?:"+(o?t:"")+(r||"")+(s||r&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),new RegExp("^"+r+"$",e?"":"i")}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.Router=t.createClass({constructor:function(e){this.options=e||{},this.routes=[],this.buildRoutes()},buildRoutes:function(){this.routes=[];var e=this.options.routes;for(var n in e)this.routes.push(new t.Route(n,e[n]))},match:function(e){var t;for(var n=0,r=this.routes.length;n<r;n++){t=[];if(this.routes[n].match(e,t))return{target:this.routes[n].getTarget(),params:t}}return null}})}(this),function(e){var t;typeof exports!="undefined"?t=exports:t="kff"in e?e.kff:e.kff={},t.FrontController=t.createClass({constructor:function(e){e=e||{},this.options=e,this.views=null,this.viewsQueue=[],this.viewFactory=e.viewFactory||new t.ViewFactory},init:function(){},createViewFromState:function(e){return null},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(e){var n=this.getLastView();this.viewsQueue.push(e),n&&(n.instance.on("init",t.bindFn(e.instance,"init")),n.instance.on("setState",t.bindFn(e.instance,"setState")))},popView:function(){if(this.viewsQueue.length===0)return;var e=this.viewsQueue.pop(),n=this.getLastView();return e.instance.off("init",t.bindFn(this,"cascadeState")),n&&(n.instance.off("init",t.bindFn(e.instance,"init")),n.instance.off("setState",t.bindFn(e.instance,"setState"))),e},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].instance.setState(this.state)},setState:function(e){var n=[],r,i,s;this.state=e,this.newViewName=this.createViewFromState(e),r=this.getLastView()?this.getLastView().name:null,i=this.findSharedView(this.newViewName,r);while((r=this.getLastView()?this.getLastView().name:null)!==null){if(r===i)break;n.push(this.popView())}for(s=0;s<n.length;s++)n[s+1]?n[s].instance.on("destroy",t.bindFn(n[s+1].instance,"destroy")):n[s].instance.on("destroy",t.bindFn(this,"startInit"));n[0]?n[0].instance.destroy():this.startInit()},startInit:function(){var e,n,r=this.getPrecedingViews(this.newViewName),i=0;for(e=0,n=r.length;e<n;e++)e>=this.viewsQueue.length?this.pushView({name:r[e],instance:this.viewFactory.createView(r[e],{viewFactory:this.viewFactory})}):i=e+1;this.newViewName=null,this.getLastView()&&this.getLastView().instance.on("init",t.bindFn(this,"cascadeState")),this.viewsQueue[i]?this.viewsQueue[i].instance.init():this.cascadeState()},findSharedView:function(e,t){var n,r=this.getPrecedingViews(e),i=this.getPrecedingViews(t),s=null;for(n=0,l=r.length<i.length?r.length:i.length;n<l;n++){if(r[n]!==i[n])break;s=r[n]}return s},getPrecedingViews:function(e){var t=e,n=[t];while(t)t=this.viewFactory.getPrecedingView(t),t&&n.unshift(t);return n}})}(this);