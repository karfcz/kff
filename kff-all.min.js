(function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.widgets={},b.extend=function(a,b){var c=function(){};a._super=c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a},b.mixins=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},b.createClass=function(a,c){var d;arguments.length===0?a=c={}:arguments.length===1&&(c=a,a={}),c.hasOwnProperty("constructor")?d=c.constructor:a.extend?d=function(){a.extend.apply(this,arguments)}:d=function(){},a.extend&&b.extend(d,a.extend);if(a.mixins){a.mixins instanceof Array||(a.mixins=[a.mixins]);for(var e=0,f=a.mixins.length;e<f;e++)b.mixins(c,a.mixins[e])}return a.staticProperties&&b.mixins(d,a.staticProperties),b.mixins(d.prototype,c),d.prototype.constructor=d,d},b.bindFn=function(a,b){if(typeof a[b]!="function")throw new TypeError("expected function");return a.boundFns||(a.boundFns={}),a.boundFns[b]?a.boundFns[b]:(a.boundFns[b]=function(){return a[b].apply(a,arguments)},a.boundFns[b])},b.isTouchDevice=function(){return"ontouchstart"in window},b.evalObjectPath=function(b){var c=a,d=b.split(".");while(d.length)if(d[0]in c)c=c[d.shift()];else return null;return c}})(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.Events=b.createClass({constructor:function(){this.subscribers={}},on:function(a,b){this.off(a,b);if(a instanceof Array)for(var c=0,d=a.length;c<d;c++)a[c]&&(this.subscribers[a[c]]||(this.subscribers[a[c]]=[]),this.subscribers[a[c]].push(b));else this.subscribers[a]||(this.subscribers[a]=[]),this.subscribers[a].push(b)},off:function(a,b){var c,d;if(a instanceof Array)for(c=0,d=a.length;c<d;c++)a[c]&&this.off(a[c],b);else if(this.subscribers[a]instanceof Array)for(c=0,d=this.subscribers[a].length;c<d;c++)this.subscribers[a][c]&&this.subscribers[a][c]===b&&delete this.subscribers[a][c]},trigger:function(a,b){var c,d;if(a instanceof Array)for(c=0,d=a.length;c<d;c++)a[c]&&this.trigger(a[c],b);else if(this.subscribers[a]instanceof Array)for(c=0,d=this.subscribers[a].length;c<d;c++)this.subscribers[a][c]&&typeof this.subscribers[a][c]=="function"&&this.subscribers[a][c](b)}}),b.EventsMixin={on:function(a,b){return this.events.on(a,b)},off:function(a,b){return this.events.off(a,b)},trigger:function(a,b){return this.events.trigger(a,b)}}}(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.Model=b.createClass({mixins:b.EventsMixin},{constructor:function(){this.events=new b.Events,this.attrs={}},get:function(a){return this.attrs[a]},set:function(a,b,c){var d={};if(typeof a=="string"){if(this.get(a)===b)return;d[a]=b;if(typeof this.validate=="function"&&!this.validate(d))return;this.attrs[a]=b}else if(a===Object(a)){c=b,d=a;if(typeof this.validate=="function"&&!this.validate(d))return;for(var e in d)this.attrs[e]=d[e]}this.trigger("change",{changedAttributes:d})}})}(this),function(a){var b;typeof exports!="undefined"?b=exports:b=a.kff=a.kff||{},b.View=b.createClass({mixins:b.EventsMixin},{constructor:function(a){return this.events=new b.Events,this.options={element:null,events:[]},a.events&&(this.options.events=this.options.events.concat(a.events),delete a.events),$.extend(this.options,a),this.$element=$(this.options.element),this.subViews=[],this},delegateEvents:function(a){var c;this.undelegateEvents(),a=a||this.options.events;for(var d=0,e=a.length;d<e;d++)c=a[d],c.length==3?this.$element.on(c[0],c[1],b.bindFn(this,c[2])):c.length==2&&this.$element.on(c[0],b.bindFn(this,c[1]))},undelegateEvents:function(a){var c;a=a||this.options.events;for(var d=0,e=a.length;d<e;d++)c=a[d],c.length==3?this.$element.off(c[0],c[1],b.bindFn(this,c[2])):c.length==2&&this.$element.off(c[0],b.bindFn(this,c[1]))},init:function(){this.render()},destroy:function(a){this.destroySubviews(),this.undelegateEvents(),a||this.trigger("destroy")},render:function(a){this.delegateEvents(),this.renderSubviews(),a||this.trigger("init")},renderSubviews:function(){var a=[],c,d,e,f,g,h,i=this.options.filter||undefined,j=function(b){var d,e,f,g;if(b.hasChildNodes()){f=b.childNodes;for(d=0,e=f.length;d<e;d++)g=f[d],g.getAttribute&&(c=g.getAttribute("data-kff-view"),c?(!i||i&&$(g).is(i))&&a.push({objPath:c,$element:$(g)}):j(g))}};j(this.$element.get(0));for(g=0,h=a.length;g<h;g++)d=b.evalObjectPath(a[g].objPath),d&&(f=a[g].$element.attr("data-kff-options")||{},f.element=a[g].$element,f.parentView=this,e=new d(f),this.subViews.push(e),e.init())},destroySubviews:function(){var a,b;for(b=0;b<this.subViews.length;b++)a=this.subViews[b],a.destroy(),delete this.subViews[b];this.subViews=[]},refresh:function(){}}),b.PageView=b.createClass({extend:b.View,staticProperties:{precedingView:null}},{constructor:function(a){return a.element=$("body"),b.PageView._super.constructor.call(this,a)},setState:function(a,b){b||this.trigger("setState")}}),b.FrontController=b.createClass({constructor:function(){this.views=null,this.viewsQueue=[]},init:function(){},createViewFromState:function(a){return null},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(a){var c=this.getLastView();this.viewsQueue.push(a),c&&(c.on("init",b.bindFn(a,"init")),c.on("setState",b.bindFn(a,"setState")))},popView:function(){if(this.viewsQueue.length==0)return;var a=this.viewsQueue.pop(),c=this.getLastView();return a.off("init",b.bindFn(this,"cascadeState")),c&&(c.off("init",b.bindFn(a,"init")),c.off("setState",b.bindFn(a,"setState"))),a},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].setState(this.state)},setState:function(a){this.newViewCtor=this.createViewFromState(a);var c=this.getLastView()?this.getLastView().constructor:null,d=this.findSharedView(this.newViewCtor,c),e=[];do{if(c===d)break;e.push(this.popView())}while(this.getLastView());for(var f=0;f<e.length;f++)e[f+1]?e[f].on("destroy",b.bindFn(e[f+1],"destroy")):e[f].on("destroy",b.bindFn(this,"startInit"));e[0]?e[0].destroy():this.startInit()},startInit:function(){var a=this.getPrecedingViews(this.newViewCtor);a.push(this.newViewCtor);for(var c=0;c<a.length;c++)c>=this.viewsQueue.length&&this.pushView(new a[c](this));this.newViewCtor=null,this.getLastView()&&this.getLastView().on("init",b.bindFn(this,"cascadeState")),this.viewsQueue[0]&&this.viewsQueue[0].init()},findSharedView:function(a,b){var c=this.getPrecedingViews(a),d=this.getPrecedingViews(b),e=null;for(var f=0,g=c.length<d.length?c.length:d.length;f<g;f++){if(c[f]!=d[f])break;e=c[f]}return e},getPrecedingViews:function(a){var c=a,d=[];while(c)c=c.precedingView||null,typeof c=="string"&&(c=b.evalObjectPath(c)),c&&d.unshift(c);return d}})}(this);