(function(e){var t;t="undefined"!=typeof exports?exports:"kff"in e?e.kff:e.kff={},t.widgets={},t.extend=function(e,t){var i=function(){};e._super=i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e},t.mixins=function(e){var i,n,s,r,o=1,a=arguments.length,h=!1;for(a>2&&arguments[a-1]===!0&&(h=!0,a--);a>o;){n=arguments[o];for(i in n)n.hasOwnProperty(i)&&(s=n[i],h&&t.isPlainObject(s)?(r=e[i],("object"!=typeof r||null===r)&&(r={}),t.mixins(r,s,h)):e[i]=s);o++}return e},t.createClass=function(e,i){var n;0===arguments.length?e=i={}:1===arguments.length&&(i=e,e={}),n=i.hasOwnProperty("constructor")?i.constructor:e.extend?function(){e.extend.apply(this,arguments)}:function(){},e.extend&&t.extend(n,e.extend),"mixins"in e?e.mixins instanceof Array||(e.mixins=[e.mixins]):e.mixins=[],e.mixins.push(t.classMixin);for(var s=0,r=e.mixins.length;r>s;s++)t.mixins(i,e.mixins[s]);return e.staticProperties&&t.mixins(n,e.staticProperties),t.mixins(n.prototype,i),n.prototype.constructor=n,n},t.bindFn=function(e,t){if("function"!=typeof e[t])throw new TypeError("Expected function: "+t+" (kff.bindFn)");return"_boundFns"in e||(e._boundFns={}),t in e._boundFns?e._boundFns[t]:(e._boundFns[t]=function(){return e[t].apply(e,arguments)},e._boundFns[t])},t.classMixin={f:function(e){var i=this;if("string"==typeof e)return t.bindFn(i,e);if("function"==typeof e)return function(){return e.apply(i,arguments)};throw new TypeError("Expected function: "+e+" (kff.f)")}},t.evalObjectPath=function(t,i){i=i||e;for(var n=t.split(".");n.length;){if(!(n[0]in i))return null;i=i[n.shift()]}return i},t.isPlainObject=function(e){return null!==e&&"object"==typeof e&&e.constructor===Object},t.Events=t.createClass({constructor:function(){this.subscribers={},this.oneSubscribers={}},on:function(e,i){if(this.off(e,i),e instanceof Array)for(var n=0,s=e.length;s>n;n++)e[n]&&(this.subscribers[e[n]]||(this.subscribers[e[n]]=[]),this.subscribers[e[n]].push(i));else this.subscribers[e]||(this.subscribers[e]=new t.List),this.subscribers[e].append(i)},one:function(e,t){e in this.oneSubscribers||(this.oneSubscribers[e]=[]),this.oneSubscribers[e].push(t),this.on(e,t)},off:function(e,i){var n,s;if(e instanceof Array)for(n=0,s=e.length;s>n;n++)e[n]&&this.off(e[n],i);else this.subscribers[e]instanceof t.List&&this.subscribers[e].remove(i)},trigger:function(e,i){var n,s;if(e instanceof Array)for(n=0,s=e.length;s>n;n++)e[n]&&this.trigger(e[n],i);else if(this.subscribers[e]instanceof t.List&&(this.subscribers[e].each(function(e){e.call(null,i)}),e in this.oneSubscribers)){for(n=0,s=this.oneSubscribers[e].length;s>n;n++)this.off(e,this.oneSubscribers[e][n]);this.oneSubscribers[e]=[]}}}),t.EventsMixin={initEvents:function(){this.events=new t.Events},on:function(e,t){return this.events.on(e,t)},one:function(e,t){return this.events.one(e,t)},off:function(e,t){return this.events.off(e,t)},trigger:function(e,t){return this.events.trigger(e,t)}},t.List=t.createClass({constructor:function(){this.array=[]},count:function(){return this.array.length},each:function(e){for(var t=this.array,i=t.length,n=0;i>n&&e.call(null,t[n],n)!==!1;n++);},append:function(e){this.array.push(e)},insert:function(e,t){this.array.splice(t,0,e)},remove:function(e){var t=this.indexOf(e);return-1===t?!1:(this.array.splice(t,1),!0)},empty:function(){this.array=[]},indexOf:function(e){var t=0,i=this.array,n=i.length;if(i.indexOf)return i.indexOf(e);for(;n>t;t++)if(i[t]===e)return t;return-1},set:function(e,t){if(void 0===this.array[e])throw new RangeError("Bad index in kff.List.set");this.array[e]=t},get:function(e){return this.array[e]},sort:function(e){this.array.sort(e)},shuffle:function(){for(var e,t,i=this.array,n=i.length,s=n;s--;)e=parseInt(Math.random()*n,10),t=i[s],i[s]=i[e],i[e]=t}}),t.List.prototype.findByIndex=t.List.prototype.get,t.Collection=t.createClass({extend:t.List,mixins:t.EventsMixin},{constructor:function(e){return e=e||{},this.itemFactory=e.itemFactory||null,this.itemType=e.itemType||t.Model,this.serializeAttrs=e.serializeAttrs||null,this.initEvents(),t.List.call(this),this},append:function(e,i){t.Collection._super.append.call(this,e),i||this.trigger("change",{type:"append",item:e})},insert:function(e,i,n){t.Collection._super.insert.call(this,e,i),n||this.trigger("change",{type:"insert",item:e,index:i})},set:function(e,i,n){t.Collection._super.set.call(this,i,e),n||this.trigger("change",{type:"set",item:i,index:e})},remove:function(e,i){var n=t.Collection._super.remove.call(this,e);return n&&!i&&this.trigger("change",{type:"remove",item:e}),n},mget:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=this.get(e.shift()),e.length>0?i instanceof t.Model||i instanceof t.Collection?i.mget(e):t.evalObjectPath(e,i):i},toJson:function(){var e=this.serializeAttrs,t=[];return this.each(function(i){i&&i.toJson?t.push(i.toJson(e)):t.push(i)}),t},fromJson:function(e,t){var i,n=this.itemFactory;this.empty();for(var s=0;e.length>s;s++)i=n?n(e[s]):new this.itemType,i.fromJson(e[s],t),this.append(i,!0);t||this.trigger("change",{type:"fromJson"})},findByAttr:function(e,t){var i=null;return this.each(function(n){return n&&n.get(e)===t?(i=n,!1):void 0}),i},empty:function(e){t.Collection._super.empty.call(this),e||this.trigger("change",{type:"empty"})},sort:function(e,i){t.Collection._super.sort.call(this,e),i||this.trigger("change",{type:"sort"})},clone:function(){var e=new t.Collection(this.options);return this.each(function(t){e.append(t)}),e},shuffle:function(e){t.Collection._super.shuffle.call(this),e||this.trigger("change",{type:"shuffle"})}}),t.Model=t.createClass({mixins:t.EventsMixin},{constructor:function(e){this.initEvents(),this.attrs=this.attrs||{},e&&this.set(e)},has:function(e){return e in this.attrs},get:function(e){return this.attrs[e]},mget:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=this.get(e.shift()),e.length>0?i instanceof t.Model||i instanceof t.Collection?i.mget(e):t.evalObjectPath(e,i):i},set:function(e,t,i){var n={};if("string"==typeof e){if(this.get(e)===t)return;n[e]=t,this.attrs[e]=t}else if(null!==e&&e instanceof Object){i=t,n=e;for(var s in n)this.attrs[s]=n[s]}if(!i){for(var r in n)this.trigger("change:"+r,{model:this,changed:n,changedAttributes:n});this.trigger("change",{model:this,changed:n,changedAttributes:n})}},toJson:function(e){var t={};for(var i in this.attrs)e&&-1===$.inArray(i,e)||!this.attrs.hasOwnProperty(i)||(t[i]=this.attrs[i]&&"object"==typeof this.attrs[i]&&"toJson"in this.attrs[i]?this.attrs[i].toJson():this.attrs[i]);return t},fromJson:function(e,t){if(e){for(var i in this.attrs)this.attrs.hasOwnProperty(i)&&e.hasOwnProperty(i)&&(this.attrs[i]&&"object"==typeof this.attrs[i]&&"fromJson"in this.attrs[i]?this.attrs[i].fromJson(e[i]):this.attrs[i]=e[i]);this.set(this.attrs,t)}}}),t.ServiceContainer=t.createClass({staticProperties:{CONFIG_CONSTRUCTOR:"construct",singleParamRegex:/^%[^%]+%$/g,multipleParamsRegex:/%([^%]+)%/g}},{constructor:function(e){this.config=e||{parameters:{},services:{}},this.services={},this.cachedParams={}},getService:function(e,t){if(!this.config.services[e])throw"Service "+e+" not defined";return this.config.services[e].shared?(this.services[e]===void 0&&(this.services[e]=this.createService(e,t)),this.services[e]):this.createService(e,t)},hasService:function(e){return this.config.services.hasOwnProperty(e)},createService:function(e,i){var n,s,r,o,a,h,c,l,u,d;if(n=this.config.services[e],s=this.getServiceConstructor(e),r=function(){},r.prototype=s.prototype,o=new r,l=this.resolveParameters(n.args||[]),i&&i instanceof Array){for(u=[],h=0,c=i.length;c>h;h++)u[h]=void 0!==i[h]?t.isPlainObject(l[h])&&t.isPlainObject(i[h])?t.mixins({},l[h],i[h]):i[h]:l[h];l=u}if(a=s.apply(o,l),Object(a)===a&&(o=a),d=n.calls,d instanceof Array)for(h=0,c=d.length;c>h;h++)o[d[h].method].apply(o,this.resolveParameters(d[h].args));return o},getServiceConstructor:function(e){var i,n,s=t.ServiceContainer.CONFIG_CONSTRUCTOR;if(i=this.config.services[e],!i)return null;if(i.hasOwnProperty("construct")?"string"==typeof i[s]&&(i[s]=t.evalObjectPath(i[s])):(n=t.evalObjectPath(e),"function"==typeof n&&(i[s]=n)),"function"!=typeof i[s])throw new TypeError("expected function in getServiceConstructor: "+i[s]);return i[s]},resolveParameters:function(e){var i,n,s,r;if(r=this.config,"string"==typeof e)"@"===e.charAt(0)?(e=e.slice(1),i=0===e.length?this:this.getService(e)):void 0!==this.cachedParams[e]?i=this.cachedParams[e]:(-1!==e.search(t.ServiceContainer.singleParamRegex)?i=r.parameters[e.slice(1,-1)]:(i=e.replace("%%","escpersign"),i=i.replace(t.ServiceContainer.multipleParamsRegex,function(e,t){return r.parameters[t]?r.parameters[t]:""}),i=i.replace("escpersign","%")),this.cachedParams[e]=i);else if(e instanceof Array)for(i=[],n=0,s=e.length;s>n;n++)i[n]=this.resolveParameters(e[n]);else if(t.isPlainObject(e)){i={};for(n in e)e.hasOwnProperty(n)&&(i[n]=this.resolveParameters(e[n]))}else i=e;return i},registerServices:function(e,t){var i;for(i in e)(!this.config.services.hasOwnProperty(i)||t)&&(this.config.services[i]=e[i],this.services[i]=void 0)}}),t.View=t.createClass({mixins:t.EventsMixin,staticProperties:{DATA_VIEW_ATTR:"data-kff-view",DATA_OPTIONS_ATTR:"data-kff-options",DATA_RENDERED_ATTR:"data-kff-rendered",DATA_BIND_ATTR:"data-kff-bind",DATA_TRIGGER_ATTR:"data-kff-trigger"}},{constructor:function(e){return e=e||{},this.options={element:null,models:null,events:[]},this.initEvents(),this.models={},e.events&&(this.options.events=this.options.events.concat(e.events)),e.element&&(this.$element=$(e.element)),e.viewFactory&&(this.viewFactory=e.viewFactory),e.parentView&&(this.parentView=e.parentView),e.models&&(this.models=e.models),t.mixins(this.options,e),this.viewFactory=e.viewFactory||new t.ViewFactory,this.subViews=[],this},getModel:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=e.shift(),this.models&&i in this.models?e.length>0?this.models[i]instanceof t.Model?this.models[i].mget(e):null:this.models[i]:this.options.parentView?(e.unshift(i),this.options.parentView.getModel(e)):null},delegateEvents:function(e,i){var n,s,r;for(this.undelegateEvents(),e=e||this.options.events,i=i||this.$element,s=0,r=e.length;r>s;s++)n=e[s],3===n.length?"string"==typeof n[1]?i.on(n[0],n[1],t.bindFn(this,n[2])):n[1].on(n[0],t.bindFn(this,n[2])):2===n.length&&i.on(n[0],t.bindFn(this,n[1]))},undelegateEvents:function(e,i){var n,s,r;for(e=e||this.options.events,i=i||this.$element,s=0,r=e.length;r>s;s++)n=e[s],3===n.length?"string"==typeof n[1]?i.off(n[0],n[1],t.bindFn(this,n[2])):n[1].off(n[0],t.bindFn(this,n[2])):2===n.length&&i.off(n[0],t.bindFn(this,n[1]))},addEvents:function(e){this.options.events=this.options.events.concat(e)},init:function(){this.startRender()},render:function(){},startRender:function(e){var i=this.render();this.$element.attr(t.View.DATA_RENDERED_ATTR,!0),this.renderSubviews(),this.processTriggerEvents(),this.delegateEvents(),"function"==typeof this.afterRender&&this.afterRender(),e!==!0&&i!==!1&&this.trigger("render")},renderSubviews:function(){var e,i,n,s,r,o,a=[],h=this.options.filter||void 0,c=this.$element.get(0);for(c&&this.findViewElements(c,a,h),r=0,o=a.length;o>r;r++)e=a[r].objPath,s=a[r].$element.attr(t.View.DATA_OPTIONS_ATTR),n=s?JSON.parse(s):{},n.element=a[r].$element,n.parentView=this,i=this.viewFactory.createView(e,n),i instanceof t.View&&(i.viewFactory=this.viewFactory,this.subViews.push(i),i.init())},findViewElements:function(e,i,n){var s,r,o,a,h,c,l;if(e.hasChildNodes())for(o=e.childNodes,s=0,r=o.length;r>s;s++)a=o[s],1===a.nodeType&&(c=a.getAttribute(t.View.DATA_RENDERED_ATTR),c||(h=a.getAttribute(t.View.DATA_VIEW_ATTR),!h&&a.getAttribute(t.View.DATA_BIND_ATTR)&&(h="kff.BindingView",a.setAttribute(t.View.DATA_VIEW_ATTR,h)),h?(!n||n&&$(a).is(n))&&i.push({objPath:h,$element:$(a)}):(l=a.getAttribute(t.View.DATA_TRIGGER_ATTR),l&&this.processChildTriggerEvents(a,l),this.findViewElements(a,i,n))))},processTriggerEvents:function(){this.processChildTriggerEvents(this.$element.get(0))},processChildTriggerEvents:function(e,i){var n,s,r,o,a=[];if(i=i||e.getAttribute(t.View.DATA_TRIGGER_ATTR)){for(n=i.split(/\s+/),r=0,o=n.length;o>r;r++)s=n[r].split(":"),a.push([s[0].replace("|"," "),$(e),s[1]]);this.addEvents(a)}},destroy:function(){},startDestroy:function(e){var i;this.$element.removeAttr(t.View.DATA_RENDERED_ATTR),this.undelegateEvents(),this.destroySubviews(),i=this.destroy(),"function"==typeof this.afterDestroy&&this.afterDestroy(),e!==!0&&i!==!1&&this.trigger("destroy")},destroySubviews:function(){var e,t,i;for(t=0,i=this.subViews.length;i>t;t++)e=this.subViews[t],e.startDestroy(),delete this.subViews[t];this.subViews=[]},refresh:function(){},refreshBinders:function(e){for(var t=0,i=this.subViews.length;i>t;t++)this.subViews[t].refreshBinders(e)},getBindingIndex:function(e){return this.parentView instanceof t.View?this.parentView.getBindingIndex(e):null}}),t.PageView=t.createClass({extend:t.View,staticProperties:{precedingView:null}},{constructor:function(e){return e=e||{},e.element=$("body"),t.View.call(this,e)},delegateEvents:function(e,i){t.PageView._super.delegateEvents.call(this,e,i||$(document))},undelegateEvents:function(e,i){t.PageView._super.undelegateEvents.call(this,e,i||$(document))},setState:function(e,t){t||this.trigger("setState",e)}}),t.BindingView=t.createClass({extend:t.View,staticProperties:{bindingRegex:/([.a-zA-Z0-9-]+):?([a-zA-Z0-9]+)?(\([^\(\))]*\))?(?::?([a-zA-Z0-9]+\([a-zA-Z0-9,\s{}]*\))?)(?::?([a-zA-Z0-9]+\([a-zA-Z0-9,\s{}]*\))?)(?::?([a-zA-Z0-9]+\([a-zA-Z0-9,\s{}]*\))?)(?::?([a-zA-Z0-9]+\([a-zA-Z0-9,\s{}]*\))?)(?::?([a-zA-Z0-9]+\([a-zA-Z0-9,\s{}]*\))?)/g,modifierRegex:/([a-zA-Z0-9]+)\(([^\(\)]*)\)/,modifierArgsRegex:/([^{}]+){([a-zA-Z0-9,\s]+)\}/,commaSeparateRegex:/\s*,\s*/,modifierSeparateRegex:/([^{},\s]+)|({[a-zA-Z0-9,\s]+})/g,leadingPeriodRegex:/^\./,binders:{},helpers:{},registerBinder:function(e,i){t.BindingView.binders[e]=i},registerHelper:function(e,i){t.BindingView.helpers[e]=i}}},{constructor:function(e){e=e||{},this.modelBinders={},this.collectionBinder=null,this.bindingIndex=null,this.values={},this.formatters=[],this.parsers=[],this.itemAlias=null,t.View.call(this,e)},startRender:function(e){this.initBinding(),this.collectionBinder&&this.renderBoundViews(),t.BindingView._super.startRender.call(this,e),setTimeout(this.f("refreshOwnBinders"),0)},startDestroy:function(e){this.destroyBinding(),t.BindingView._super.startDestroy.call(this,!0),this.destroyBoundViews(),e||this.trigger("destroy")},initBinding:function(){var e,i,n,s,r,o,a,h,c,l,u,d,f,g,p,v=this.$element.attr(t.View.DATA_BIND_ATTR),m=t.BindingView.bindingRegex,w=t.BindingView.modifierRegex,V=t.BindingView.commaSeparateRegex,b=t.BindingView.leadingPeriodRegex;for(m.lastIndex=0,this.modelBinders={};null!==(n=m.exec(v));){r=n[1],r=r.replace(b,"*.").split("."),o=n[2],a=n[3],a=a?a.slice(1,-1).split(V):[],h=[],c=[],u=[],l=[],d=[];for(var B=4,y=n.length;y>B&&n[B];B++)if(s=n[B].match(w))switch(f=s[1],g=[],s[2]&&(g=s[2].match(t.BindingView.modifierSeparateRegex)),f){case"f":this.parseHelpers(g,h);break;case"p":this.parseHelpers(g,c);break;case"on":this.parseSetters(g,d);break;case"as":this.parseSetters(g,itemAliases);break;case"set":this.parseSetters(g,u);break;case"get":this.parseSetters(g,l)}if(e=this.getModel([].concat(r)),e instanceof t.Collection)this.options.isBoundView||(this.collectionBinder={collection:e},"as"===o&&a.length>0&&(this.itemAlias=a[0]));else{if(!(o&&o in t.BindingView.binders))break;if(i=r.length>1?r.pop():null,p=r.length>0?r[0]:null,e=this.getModel(r),e instanceof t.Collection&&"count"===i&&(e=this.bindCollectionCount(e)),e instanceof t.Model){o in this.modelBinders||(this.modelBinders[o]=[],this.values[o]=[]);var x=this.modelBinders[o].length,C=new t.BindingView.binders[o]({view:this,$element:this.$element,valueIndex:x,values:this.values[o],params:a,attr:i,model:e,modelName:p,formatters:h,parsers:c,setters:u,getters:l,eventNames:d});this.modelBinders[o].push(C),this.values[o].push(null),C.init()}}}},bindCollectionCount:function(e){var i=new t.Model,n=function(){i.set("count",e.count())};return n(),this.boundCollectionCounts||(this.boundCollectionCounts=[]),this.boundCollectionCounts.push({collection:e,handler:n}),e.on("change",n),i},destroyCollectionCountBindings:function(){if(this.boundCollectionCounts)for(var e=0,t=this.boundCollectionCounts.length;t>e;e++)this.boundCollectionCounts[e].collection.off("change",this.boundCollectionCounts[e].handler)},parseHelpers:function(e,i){for(var n,s,r=0,o=e.length;o>r;r++)n=e[r],o>r+1&&0===e[r+1].indexOf("{")?(s=e[r+1].match(/([^,\s{}]+)/),r++):s=[],t.BindingView.helpers[n]&&i.push({fn:t.BindingView.helpers[n],args:s})},parseSetters:function(e,t){for(var i=0;e.length>i;i++)t.push(e[i])},destroyBinding:function(){for(var e in this.modelBinders)for(var t=0,i=this.modelBinders[e],n=i.length;n>t;t++)i[t].destroy();this.modelBinders={},this.values={},this.destroyCollectionCountBindings()},renderBoundViews:function(){this.$anchor=$(document.createTextNode("")),this.$element.before(this.$anchor),this.$element.remove(),this.subViewsMap=[],this.subViewName=this.$element.attr(t.View.DATA_VIEW_ATTR);var e=this.$element.attr(t.View.DATA_OPTIONS_ATTR);this.initCollectionFilter(),this.subViewOptions=e?JSON.parse(e):{},this.subViewOptions.parentView=this,this.collectionBinder.collection.on("change",this.f("refreshBoundViews")),this.refreshBoundViewsAll()},initCollectionFilter:function(){var e=this.$element.attr("data-kff-filter");e&&(this.collectionFilter={model:null,fn:null},e=e.replace(/^\./,"").split("."),1===e.length?this.collectionFilter.fn=e[0]:(this.collectionFilter.fn=e.pop(),this.collectionFilter.model=this.getModel([].concat(e))))},destroyBoundViews:function(){if(this.elements)for(var e=0,t=this.elements.length;t>e;e++)this.elements[e].remove();this.elements=[],this.$anchor&&(this.$anchor.after(this.$element),this.$anchor.remove()),this.destroySubviews()},refreshBoundViews:function(e){switch(e?e.type:null){case"append":this.refreshBoundViewsOnAppend(e);break;case"insert":this.refreshBoundViewsOnInsert(e);break;case"remove":this.refreshBoundViewsOnRemove(e);break;default:this.refreshBoundViewsAll()}},refreshBoundViewsOnAppend:function(e){this.subViewsMap.push({renderIndex:null,rendered:!1}),e.item.on("change",this.f("collectionItemChange")),this.collectionItemChange({model:e.item})},refreshBoundViewsOnInsert:function(e){this.subViewsMap.splice(e.index,0,{renderIndex:null,rendered:!1}),e.item.on("change",this.f("collectionItemChange")),this.collectionItemChange({model:e.item})},refreshBoundViewsOnRemove:function(e){e.item.off("change",this.f("collectionItemChange"));for(var t=0,i=this.subViews.length;i>t&&e.item!==this.subViews[t].models["*"];t++);for(var n=t,s=null,t=0,i=this.subViewsMap.length;i>t;t++)if(this.subViewsMap[t].renderIndex===n){s=t;break}null!==s&&(this.subViewsMap[t].rendered&&this.removeSubViewAt(n),this.subViewsMap.splice(t,1)),this.reindexSubviews(t)},refreshBoundViewsAll:function(){if(this.destroySubviews(),this.elements)for(var e=0,t=this.elements.length;t>e;e++)this.elements[e].remove();this.elements=[],this.subViewsMap=[],this.collectionBinder.collection.each(this.f(function(e){this.subViewsMap.push({renderIndex:null,rendered:!1}),e.on("change",this.f("collectionItemChange")),this.collectionItemChange({model:e})})),this.reindexSubviews()},collectionItemChange:function(e){var t,i,n,s,r=e.model,o=this.collectionBinder.collection.indexOf(r);if(this.collectionFilter)if(s=r,this.collectionFilter.model&&(s=this.collectionFilter.model),i=0,n=!!s[this.collectionFilter.fn].call(s,r),n&&!this.subViewsMap[o].rendered){for(t=0;o>t;t++)this.subViewsMap[t].rendered&&i++;this.addSubViewAt(o,i)}else!n&&this.subViewsMap[o].rendered&&(this.subViewsMap[o].rendered=!1,this.removeSubViewAt(this.subViewsMap[o].renderIndex));else this.subViewsMap[o].rendered||this.addSubViewAt(o,o)},refilterCollection:function(){this.collectionBinder.collection.each(this.f(function(e){this.collectionItemChange({model:e})}))},removeSubViewAt:function(e){this.subViews[e].destroy(),this.subViews.splice(e,1),this.elements[e].remove(),this.elements.splice(e,1),this.reindexSubviews(e)},addSubViewAt:function(e,t){var i=this.collectionBinder.collection.findByIndex(e),n=this.createSubView(i,t);0===t?this.$anchor.after(n):this.elements[t-1].after(n),this.elements.splice(t,0,n),this.subViewsMap[e].renderIndex=t,this.subViewsMap[e].rendered=!0,this.reindexSubviews(t)},reindexSubviews:function(e,t){e||(e=0),(!t||t>this.subViews.length)&&(t=this.subViews.length);for(var i=e;t>i;i++)this.subViews[i].setBindingIndex(i),this.subViews[i].refreshBinders(!0);for(var i=0,n=this.subViewsMap.length,s=0;n>i;i++)this.subViewsMap[i].rendered?(this.subViewsMap[i].renderIndex=s,s++):this.subViewsMap[i].renderIndex=null},createSubView:function(e,i){var n=this.$element.clone();this.subViewOptions.element=n,this.subViewOptions.models={"*":e},this.itemAlias&&(this.subViewOptions.models[this.itemAlias]=e),this.subViewOptions.isBoundView=!0;var s=this.viewFactory.createView(this.subViewName,this.subViewOptions);return s instanceof t.View&&(s.viewFactory=this.viewFactory,this.subViews.splice(i,0,s),s.setBindingIndex(i),s.init(),n.attr(t.View.DATA_RENDERED_ATTR,!0)),n},getModel:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=parseInt(e[0],10),this.collectionBinder&&!isNaN(i)?this.collectionBinder.collection.findByIndex(i):t.BindingView._super.getModel.call(this,e)},refreshOwnBinders:function(e){for(var t in this.modelBinders)for(var i=0,n=this.modelBinders[t],s=n.length;s>i;i++)n[i].modelChange(!0);e!==!0&&this.collectionBinder&&this.refilterCollection()},refreshBinders:function(e){this.refreshOwnBinders(e),t.BindingView._super.refreshBinders.call(this,e)},renderSubviews:function(){this.collectionBinder||t.BindingView._super.renderSubviews.call(this)},getBindingIndex:function(e){return e=e||"*",null!==this.bindingIndex&&e in this.models?this.bindingIndex:this.parentView instanceof t.View?this.parentView.getBindingIndex(e):null},setBindingIndex:function(e){this.bindingIndex=e},concat:function(e){return 1===e.length?e[0]:e.join(" ")}}),t.BindingView.registerHelper("index",function(e,t){return null!==this.getBindingIndex(t)?this.getBindingIndex(t):e}),t.BindingView.registerHelper("indexFromOne",function(e){return null!==this.getBindingIndex(modelName)?this.getBindingIndex(modelName)+1:e}),t.BindingView.registerHelper("boolean",function(e){var t=parseInt(e,10);return isNaN(t)?"true"===e:!!t}),t.BindingView.registerHelper("not",function(e){return!e}),t.BindingView.registerHelper("null",function(e){return null===e||"null"===e?null:e}),t.BindingView.registerHelper("int",function(e){return e=parseInt(e,10),isNaN(e)&&(e=0),e}),t.BindingView.registerHelper("float",function(e){return e=parseFloat(e),isNaN(e)&&(e=0),e}),t.BindingView.registerHelper("string",function(e){return""+e}),t.Binder=t.createClass({constructor:function(e){this.options=e,this.options.events=this.options.events||[],this.view=e.view,this.$element=e.$element,this.attr=e.attr,this.model=e.model,this.modelName=e.modelName,this.parsers=e.parsers,this.formatters=e.formatters,this.setter=e.setters instanceof Array&&e.setters.length>0?e.setters[0]:null,this.getter=e.getters instanceof Array&&e.getters.length>0?e.getters[0]:null,this.values=e.values,this.valueIndex=e.valueIndex,this.params=e.params,this.currentValue=null,this.bindingIndex=null},init:function(){this.model.on("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.delegateEvents.call(this,this.options.events)},destroy:function(){this.model.off("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.undelegateEvents.call(this,this.options.events),this.currentValue=null,this.values[this.valueIndex]=null},delegateEvents:t.View.prototype.delegateEvents,undelegateEvents:t.View.prototype.undelegateEvents,modelChange:function(e){var t;if(this.getter&&"function"==typeof this.model[this.getter])t=this.model[this.getter](this.attr);else if(e!==!0)t=e.changed[this.attr];else{if("string"!=typeof this.attr)return;t=this.model.get(this.attr)}e!==!0&&this.compareValues(t,this.currentValue)||(this.values[this.valueIndex]=this.format(t),this.currentValue=t,this.refresh())},compareValues:function(e,t){if(e instanceof Array&&t instanceof Array){var i=e.length;if(i!==t.length)return!1;for(var n=0;i>n;n++)if(e[n]!==t[n])return!1;return!0}return e===t},getFormattedValue:function(){return this.values.length>1?this.values.join(" "):this.values[this.valueIndex]},updateModel:function(e){var t,i;if(e instanceof Array)for(t=0,i=e.length;i>t;t++)e[t]=this.parse(e[t]);else e=this.parse(e);this.compareValues(e,this.currentValue)||(this.currentValue=e,this.setter&&"function"==typeof this.model[this.setter]?this.model[this.setter](this.attr,this.currentValue):this.model.set(this.attr,this.currentValue))},refresh:function(){},format:function(e){var t,i,n,s,r;for(t=0,i=this.formatters.length;i>t;t++)if(e instanceof Array){for(r=[],n=0,s=e.length;s>n;n++)r[n]=this.formatters[t].fn.apply(this,[e[n]].concat(this.formatters[t].args));e=r}else e=this.formatters[t].fn.apply(this,[e].concat(this.formatters[t].args));return e},parse:function(e){var t,i,n,s,r;for(t=0,i=this.parsers.length;i>t;t++)if(e instanceof Array){for(r=[],n=0,s=e.length;s>n;n++)r[n]=this.parsers[t].fn.apply(this,[e[n]].concat(this.parsers[t].args));e=r}else e=this.parsers[t].fn.apply(this,[e].concat(this.parsers[t].args));return e},getBindingIndex:function(e){return e=e||"*",this.view.getBindingIndex(e)}}),t.EventBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click";e.events=[[i,"triggerEvent"]],t.Binder.call(this,e)},init:function(){this.value=this.params[0]||null,t.EventBinder._super.init.call(this)},triggerEvent:function(e){setTimeout(this.f(function(){this.updateModel(this.value)}),0),e.preventDefault()},compareValues:function(){return!1}}),t.BindingView.registerBinder("event",t.EventBinder),t.AttrBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},init:function(){this.attribute=this.params[0]||null,this.prefix=this.params[1]||"",this.suffix=this.params[2]||"",t.AttrBinder._super.init.call(this)},refresh:function(){this.attribute&&this.$element.attr(this.attribute,this.prefix+this.getFormattedValue()+this.suffix)}}),t.BindingView.registerBinder("attr",t.AttrBinder),t.CheckBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click change";e=e||{},e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){setTimeout(this.f(function(){this.updateModel(this.$element.is(":checked"))}),0)},refresh:function(){this.$element.prop("checked",!!this.values[this.valueIndex])}}),t.BindingView.registerBinder("check",t.CheckBinder),t.ClassBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},init:function(){this.className=this.params[0]||null,this.equalsTo=this.params[1]||!0,t.ClassBinder._super.init.call(this)},refresh:function(){this.className&&this.$element[this.matchValue()?"addClass":"removeClass"](this.className)},matchValue:function(){return this.equalsTo?this.values[this.valueIndex]===this.parse(this.equalsTo):this.values[this.valueIndex]}}),t.BindingView.registerBinder("class",t.ClassBinder),t.StyleBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},init:function(){this.styleProperty=this.params[0]||null,t.StyleBinder._super.init.call(this)},refresh:function(){this.styleProperty&&this.$element.css(this.styleProperty,this.getFormattedValue())}}),t.BindingView.registerBinder("style",t.StyleBinder),t.ClickBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["click"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("click",t.ClickBinder),t.DoubleClickBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["dblclick"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("dblclick",t.DoubleClickBinder),t.FocusBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["focus"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("focus",t.FocusBinder),t.BlurBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["blur"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("blur",t.BlurBinder),t.FocusBlurBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["focus blur"]),t.EventBinder.call(this,e)},triggerEvent:function(){setTimeout(this.f(function(){this.updateModel(this.$element.is(":focus"))}),0)},refresh:function(){this.values[this.valueIndex]?this.$element.is(":focus")||this.$element.trigger("focus"):this.$element.is(":focus")&&this.$element.trigger("blur")}}),t.BindingView.registerBinder("focusblur",t.FocusBlurBinder),t.HtmlBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},refresh:function(){this.$element.html(this.values.join(" "))}}),t.BindingView.registerBinder("html",t.HtmlBinder),t.RadioBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click";e=e||{},e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){setTimeout(this.f(function(){this.$element.is(":checked")&&this.updateModel(this.$element.val())}),0)},refresh:function(){this.$element.prop("checked",this.parse(this.$element.val())===this.currentValue)}}),t.BindingView.registerBinder("radio",t.RadioBinder),t.TextBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},refresh:function(){this.$element.text(this.values.join(" "))}}),t.BindingView.registerBinder("text",t.TextBinder),t.ValueBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"keydown drop change";e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){setTimeout(this.f(function(){this.updateModel(this.$element.val())}),0)},refresh:function(){this.$element.val(this.getFormattedValue())}}),t.BindingView.registerBinder("val",t.ValueBinder),t.ViewFactory=t.createClass({constructor:function(e){e=e||{},this.serviceContainer=e.serviceContainer||null,this.precedingViews=e.precedingViews||{}},createView:function(e,i){var n,s=null;return i=i||{},"function"!=typeof e&&this.serviceContainer&&this.serviceContainer.hasService(e)?s=this.serviceContainer.getService(e,[i]):(n="function"!=typeof e?t.evalObjectPath(e):e,n&&(s=new n(t.mixins({},i,{viewFactory:this})))),s},getServiceConstructor:function(e){return"function"==typeof e?e:this.serviceContainer&&this.serviceContainer.hasService(e)?this.serviceContainer.getServiceConstructor(e):t.evalObjectPath(e)},getPrecedingView:function(e){var t;return"string"==typeof e&&void 0!==this.precedingViews[e]?this.precedingViews[e]:(t=this.getServiceConstructor(e),t&&t.precedingView?t.precedingView:null)}}),t.Route=t.createClass({constructor:function(e,t){this.pattern=e,this.target=t,this.keys=null,this.regexp=this.compileRegex()},getTarget:function(){return this.target},match:function(e,t){var i=this.keys,n=e.indexOf("?"),s=~n?e.slice(0,n):e,r=this.regexp.exec(s);if(!r)return!1;for(var o=1,a=r.length;a>o;++o){var h=i[o-1],c="string"==typeof r[o]?decodeURIComponent(r[o]):r[o];h?t[h.name]=void 0!==t[h.name]?t[h.name]:c:t.push(c)}return!0},compileRegex:function(e,t){var i,n=this.keys=[];return i=this.pattern.concat(t?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(e,t,i,s,r,o){return n.push({name:s,optional:!!o}),t=t||"",""+(o?"":t)+"(?:"+(o?t:"")+(i||"")+(r||i&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+i+"$",e?"":"i")
}}),t.Router=t.createClass({constructor:function(e){this.options=e||{},this.routes=[],this.buildRoutes()},buildRoutes:function(){this.routes=[];var e=this.options.routes;for(var i in e)this.routes.push(new t.Route(i,e[i]))},match:function(e){for(var t,i=0,n=this.routes.length;n>i;i++)if(t=[],this.routes[i].match(e,t))return{target:this.routes[i].getTarget(),params:t};return null}}),t.FrontController=t.createClass({constructor:function(e){e=e||{},this.options=e,this.views=null,this.viewsQueue=[],this.viewFactory=e.viewFactory||new t.ViewFactory,this.router=e.router||null},init:function(){this.router?$(window).bind("hashchange",this.f("hashChange")).trigger("hashchange"):this.setState(null)},createViewFromState:function(e){if(this.router){var t,i=e.path;if(""===i&&(i="#"),t=this.router.match(i))return e.params=t.params,t.target}return this.options.defaultView},hashChange:function(){var e=location.hash;return 0!==e.indexOf("#")&&""!=e?!1:(this.setState({path:e,params:{}}),!1)},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(e){var i=this.getLastView();this.viewsQueue.push(e),i&&(i.instance.on("render",t.bindFn(e.instance,"init")),i.instance.on("setState",t.bindFn(e.instance,"setState")))},popView:function(){if(0!==this.viewsQueue.length){var e=this.viewsQueue.pop(),i=this.getLastView();return e.instance.off("init",t.bindFn(this,"cascadeState")),i&&(i.instance.off("init",t.bindFn(e.instance,"init")),i.instance.off("setState",t.bindFn(e.instance,"setState"))),e}},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].instance.setState(this.state)},setState:function(e){var i,n,s,r=[];for(this.state=e,this.newViewName=this.createViewFromState(e),i=this.getLastView()?this.getLastView().name:null,n=this.findSharedView(this.newViewName,i);null!==(i=this.getLastView()?this.getLastView().name:null)&&i!==n;)r.push(this.popView());for(s=0;r.length>s;s++)r[s+1]?r[s].instance.on("destroy",t.bindFn(r[s+1].instance,"startDestroy")):r[s].instance.on("destroy",t.bindFn(this,"startInit"));r[0]?r[0].instance.startDestroy():this.startInit()},startInit:function(){var e,i,n=this.getPrecedingViews(this.newViewName),s=0;for(e=0,i=n.length;i>e;e++)e>=this.viewsQueue.length?this.pushView({name:n[e],instance:this.viewFactory.createView(n[e],{viewFactory:this.viewFactory})}):s=e+1;this.newViewName=null,this.getLastView()&&this.getLastView().instance.on("render",t.bindFn(this,"cascadeState")),this.viewsQueue[s]?this.viewsQueue[s].instance.init():this.cascadeState()},findSharedView:function(e,t){var i,n=this.getPrecedingViews(e),s=this.getPrecedingViews(t),r=null;for(i=0,l=n.length<s.length?n.length:s.length;l>i&&n[i]===s[i];i++)r=n[i];return r},getPrecedingViews:function(e){for(var t=e,i=[t];t;)t=this.viewFactory.getPrecedingView(t),t&&i.unshift(t);return i}}),t.App=t.createClass({constructor:function(e){var i;e=e||{},i=e.models||{};var n={parameters:{},services:{viewFactory:{construct:"kff.ViewFactory",args:[{serviceContainer:"@"}],shared:!0},frontController:{construct:"kff.FrontController",args:[{viewFactory:"@viewFactory",defaultView:"pageView"}],shared:!0},pageView:{construct:"kff.PageView",args:[{viewFactory:"@viewFactory",models:i}]}}};return this.serviceContainer=new t.ServiceContainer(n),"services"in e&&this.serviceContainer.registerServices(e.services,!0),this},init:function(){this.serviceContainer.getService("frontController").init()},getServiceContainer:function(){return this.serviceContainer}})})(this);