!function(a){var b;b="undefined"!=typeof exports?exports:"kff"in a?a.kff:a.kff={},b.widgets={},b.extend=function(a,b){var c;Object.create?a.prototype=Object.create(b.prototype):(c=function(){},c.prototype=b.prototype,a.prototype=new c),a._super=b.prototype,a.prototype.constructor=a},b.mixins=function(a){var c,d,e,f,g=1,h=arguments.length,i=!1;for(h>2&&arguments[h-1]===!0&&(i=!0,h--);h>g;){d=arguments[g];for(c in d)d.hasOwnProperty(c)&&(e=d[c],i&&b.isPlainObject(e)?(f=a[c],("object"!=typeof f||null===f)&&(f={}),b.mixins(f,e,i)):a[c]=e);g++}return a},b.createClass=function(a,c){var d;0===arguments.length?a=c={}:1===arguments.length&&(c=a,a={}),d=c.hasOwnProperty("constructor")?c.constructor:a.extend?function(){a.extend.apply(this,arguments)}:function(){},a.extend&&b.extend(d,a.extend),"mixins"in a?a.mixins instanceof Array||(a.mixins=[a.mixins]):a.mixins=[],a.mixins.push(b.classMixin);for(var e=0,f=a.mixins.length;f>e;e++)b.mixins(c,a.mixins[e]);return a.staticProperties&&b.mixins(d,a.staticProperties),a.statics&&b.mixins(d,a.statics),b.mixins(d.prototype,c),d.prototype.constructor=d,d},b.bindFn=function(a,b,c){if("function"!=typeof a[b])throw new TypeError("Expected function: "+b+" (kff.bindFn)");return"_boundFns"in a||(a._boundFns={}),b in a._boundFns?a._boundFns[b]:(a._boundFns[b]=function(){return c?a[b].apply(a,c.concat(Array.prototype.slice.call(arguments))):a[b].apply(a,arguments)},a._boundFns[b])},b.classMixin={f:function(a,c){var d=this;if("string"==typeof a)return b.bindFn(d,a,c);if("function"==typeof a)return function(){return c?a.apply(d,c.concat(Array.prototype.slice.call(arguments))):a.apply(d,arguments)};throw new TypeError("Expected function: "+a+" (kff.f)")}},function(){var c,d,e,f;b.evalObjectPath=function(b,g){if(g=g||a,"string"!=typeof b)return null;for(c=b.split("."),e=0,f=c.length;f>e;e++){if(d=c[e],!(d in g))return null;g=g[d]}return g}}(),b.isPlainObject=function(a){return null!==a&&"object"==typeof a&&a.constructor===Object},b.setZeroTimeout=function(a){var c=[],d="kff-zerotimeoutmsg",e=function(a){a.source===window&&a.data===d&&(a.stopPropagation(),c.length>0&&c.shift()())};"postMessage"in window&&"addEventListener"in window&&!("attachEvent"in window)?(b.setZeroTimeout=function(a){c.push(a),window.postMessage(d,"*")},window.addEventListener("message",e,!0)):b.setZeroTimeout=function(a){setTimeout(a,0)},b.setZeroTimeout(a)},b.Events=b.createClass({constructor:function(){this.subscribers={},this.oneSubscribers={}},on:function(a,c){if(this.off(a,c),a instanceof Array)for(var d=0,e=a.length;e>d;d++)a[d]&&(this.subscribers[a[d]]||(this.subscribers[a[d]]=new b.List),this.subscribers[a[d]].append(c));else this.subscribers[a]||(this.subscribers[a]=new b.List),this.subscribers[a].append(c)},one:function(a,b){a in this.oneSubscribers||(this.oneSubscribers[a]=[]),this.oneSubscribers[a].push(b),this.on(a,b)},off:function(a,c){var d,e;if(a instanceof Array)for(d=0,e=a.length;e>d;d++)a[d]&&this.off(a[d],c);else this.subscribers[a]instanceof b.List&&this.subscribers[a].remove(c)},trigger:function(a,c){var d,e;if(a instanceof Array)for(d=0,e=a.length;e>d;d++)a[d]&&this.trigger(a[d],c);else if(this.subscribers[a]instanceof b.List&&(this.subscribers[a].each(function(a){"function"==typeof a&&a.call(null,c)}),a in this.oneSubscribers)){for(d=0,e=this.oneSubscribers[a].length;e>d;d++)this.off(a,this.oneSubscribers[a][d]);this.oneSubscribers[a]=[]}}}),b.EventsMixin={initEvents:function(){this.events=new b.Events},on:function(a,b){return this.events.on(a,b)},one:function(a,b){return this.events.one(a,b)},off:function(a,b){return this.events.off(a,b)},trigger:function(a,b){return this.events.trigger(a,b)}},b.List=b.createClass({constructor:function(){this.array=[]},count:function(){return this.array.length},each:function(a){for(var b=this.array,c=b.length,d=0;c>d&&a.call(null,b[d],d)!==!1;d++);},append:function(a){this.array.push(a)},insert:function(a,b){this.array.splice(b,0,a)},remove:function(a){var b=this.indexOf(a);return-1===b?!1:(this.array.splice(b,1),!0)},empty:function(){this.array=[]},splice:function(){Array.prototype.splice.apply(this.array,arguments)},indexOf:function(a){return b.List.prototype.indexOf=Array.prototype.indexOf?function(a){return this.array.indexOf(a)}:function(a){for(var b=0,c=this.array,d=c.length;d>b;b++)if(c[b]===a)return b;return-1},this.indexOf(a)},set:function(a,b){if(void 0===this.array[a])throw new RangeError("Bad index in kff.List.set");this.array[a]=b},get:function(a){return this.array[a]},sort:function(a){this.array.sort(a)},shuffle:function(){for(var a,b,c=this.array,d=c.length,e=d;e--;)a=parseInt(Math.random()*d,10),b=c[e],c[e]=c[a],c[a]=b}}),b.List.prototype.findByIndex=b.List.prototype.get,b.Collection=b.createClass({extend:b.List,mixins:b.EventsMixin},{constructor:function(a){return a=a||{},this.itemFactory=a.itemFactory||null,this.itemType=a.itemType||b.Model,this.serializeAttrs=a.serializeAttrs||null,this.onEachEvents=[],this.initEvents(),b.List.call(this),this},append:function(a,c){b.Collection._super.append.call(this,a),this.bindOnOne(a),c||this.trigger("change",{type:"append",item:a})},insert:function(a,c,d){b.Collection._super.insert.call(this,a,c),this.bindOnOne(a),d||this.trigger("change",{type:"insert",item:a,index:c})},set:function(a,c,d){var e=this.get(a);e&&this.unbindOnOne(e),b.Collection._super.set.call(this,c,a),this.bindOnOne(c),d||this.trigger("change",{type:"set",item:c,index:a})},remove:function(a,c){this.unbindOnOne(a);var d=b.Collection._super.remove.call(this,a);return d&&!c&&this.trigger("change",{type:"remove",item:a}),d},mget:function(a){var c;return"string"==typeof a&&(a=a.split(".")),c=this.get(a.shift()),a.length>0?c instanceof b.Model||c instanceof b.Collection?c.mget(a):b.evalObjectPath(a,c):c},toJson:function(){var a=this.serializeAttrs,b=[];return this.each(function(c){c&&c.toJson?b.push(c.toJson(a)):b.push(c)}),b},fromJson:function(a,b){var c,d=this.itemFactory;this.empty();for(var e=0;e<a.length;e++)c=d?d(a[e]):new this.itemType,c.fromJson(a[e],b),this.append(c,!0);b||this.trigger("change",{type:"fromJson"})},findByAttr:function(a,b){var c=null;return this.each(function(d){return d&&d.get(a)===b?(c=d,!1):void 0}),c},empty:function(a){this.unbindEach(),b.Collection._super.empty.call(this),a||this.trigger("change",{type:"empty"})},sort:function(a,c){b.Collection._super.sort.call(this,a),c||this.trigger("change",{type:"sort"})},clone:function(){var a=new b.Collection(this.options);return this.each(function(b){a.append(b)}),a.onEachEvents=[].concat(this.onEachEvents),a.rebindEach(),a},shuffle:function(a){b.Collection._super.shuffle.call(this),a||this.trigger("change",{type:"shuffle"})},splice:function(){this.unbindEach(),b.Collection._super.splice.apply(this,arguments),this.rebindEach(),this.trigger("change",{type:"splice"})},onEach:function(a,b){for(var c=0,d=this.onEachEvents.length;d>c;c++)if(this.onEachEvents[c].eventType===a&&this.onEachEvents[c].fn===b)return;this.onEachEvents.push({eventType:a,fn:b}),this.each(function(c){c.on(a,b)})},offEach:function(a,b){for(var c=0,d=this.onEachEvents.length;d>c;c++)this.onEachEvents[c].eventType===a&&this.onEachEvents[c].fn===b&&(this.onEachEvents.splice(c,1),d--);this.each(function(c){c.off(a,b)})},bindOnOne:function(a){for(var b=0,c=this.onEachEvents.length;c>b;b++)a.on(this.onEachEvents[b].eventType,this.onEachEvents[b].fn)},unbindOnOne:function(a){for(var b=0,c=this.onEachEvents.length;c>b;b++)a.off(this.onEachEvents[b].eventType,this.onEachEvents[b].fn)},rebindEach:function(){var a=this;this.each(function(b){for(var c=0,d=a.onEachEvents.length;d>c;c++)b.on(a.onEachEvents[c].eventType,a.onEachEvents[c].fn)})},unbindEach:function(){var a=this;this.each(function(b){for(var c=0,d=a.onEachEvents.length;d>c;c++)b.off(a.onEachEvents[c].eventType,a.onEachEvents[c].fn)})}}),b.Model=b.createClass({mixins:b.EventsMixin},{constructor:function(a){this.initEvents(),this.attrs=this.attrs||{},a&&this.set(a)},has:function(a){return a in this.attrs},get:function(a){return this.attrs[a]},mget:function(a){var c;return"string"==typeof a&&(a=a.split(".")),c=this.get(a.shift()),a.length>0?c instanceof b.Model||c instanceof b.Collection?c.mget(a):b.evalObjectPath(a,c):c},set:function(a,b,c){var d={};if("string"==typeof a){if(this.get(a)===b)return;d[a]=b,this.attrs[a]=b}else if(null!==a&&a instanceof Object){c=b,d=a;for(var e in d)this.attrs[e]=d[e]}if(!c){for(var f in d)this.trigger("change:"+f,{model:this,changed:d,changedAttributes:d});this.trigger("change",{model:this,changed:d,changedAttributes:d})}},toJson:function(a){var b={};for(var c in this.attrs)a&&-1===$.inArray(c,a)||!this.attrs.hasOwnProperty(c)||(b[c]=this.attrs[c]&&"object"==typeof this.attrs[c]&&"toJson"in this.attrs[c]?this.attrs[c].toJson():this.attrs[c]);return b},fromJson:function(a,b){if(a){for(var c in this.attrs)this.attrs.hasOwnProperty(c)&&a.hasOwnProperty(c)&&(this.attrs[c]&&"object"==typeof this.attrs[c]&&"fromJson"in this.attrs[c]?this.attrs[c].fromJson(a[c]):this.attrs[c]=a[c]);this.set(this.attrs,b)}},createComputed:function(a,b,c){var d,e,f;for(this._computed||(this._computed=[]),d={args:[a,b,c],boundFn:this.f(function(){var d=[];for(e=0,f=b.length;f>e;e++)d[e]=this.get(b[e]);this.set(a,this.f(c).apply(this,d))})},this._computed.push(d),e=0,f=b.length;f>e;e++)this.on("change:"+b[e],d.boundFn);d.boundFn()},each:function(a){var b,c=this.attrs;for(b in c)a(b,c[b])}}),b.ServiceContainer=b.createClass({statics:{CONFIG_CONSTRUCTOR:"construct",singleParamRegex:/^%[^%]+%$/g,multipleParamsRegex:/%([^%]+)%/g}},{constructor:function(a){this.config=a||{parameters:{},services:{}},this.services={},this.cachedParams={}},getService:function(a,b){var c;if(!this.config.services[a]){if(c=this.getServiceConfigAnnotation(a),!c)throw new Error("Service "+a+" not defined");this.config.services[a]=c}return this.config.services[a].shared?("undefined"==typeof this.services[a]&&(this.services[a]=this.createService(a,b)),this.services[a]):this.createService(a,b)},hasService:function(a){if(this.config.services.hasOwnProperty(a))return!0;var b=this.getServiceConfigAnnotation(a);return b?(this.config.services[a]=b,!0):!1},createService:function(a,c){var d,e,f,g,h,i,j,k,l,m;if(d=this.config.services[a],e=this.getServiceConstructor(a),f=function(){},f.prototype=e.prototype,g=new f,k=this.resolveParameters(d.args||[]),c&&c instanceof Array){for(l=[],i=0,j=c.length;j>i;i++)l[i]=void 0!==c[i]?b.isPlainObject(k[i])&&b.isPlainObject(c[i])?b.mixins({},k[i],c[i]):c[i]:k[i];k=l}if(h=e.apply(g,k),Object(h)===h&&(g=h),m=d.calls,m instanceof Array)for(i=0,j=m.length;j>i;i++)g[m[i].method].apply(g,this.resolveParameters(m[i].args));return g},getServiceConstructor:function(a){var c,d,e=b.ServiceContainer.CONFIG_CONSTRUCTOR;if(c=this.config.services[a],!c){if(c=this.getServiceConfigAnnotation(a),!c)return null;this.config.services[a]=c}if(c.hasOwnProperty("construct")?"string"==typeof c[e]&&(c[e]=b.evalObjectPath(c[e])):(d=b.evalObjectPath(a),"function"==typeof d&&(c[e]=d)),"function"!=typeof c[e])throw new Error('Cannot create service "'+a+'" in kff.getServiceConstructor. Expected constructor function, got: '+c[e]);return c[e]},getServiceConfigAnnotation:function(a){var c={},d=b.evalObjectPath(a);return"function"==typeof d?("service"in d&&b.isPlainObject(d.service)&&(c=d.service),"construct"in c||(c.construct=d),c):null},resolveParameters:function(a){var c,d,e,f;if(f=this.config,"string"==typeof a)"@"===a.charAt(0)?(a=a.slice(1),c=0===a.length?this:this.getService(a)):void 0!==this.cachedParams[a]?c=this.cachedParams[a]:(-1!==a.search(b.ServiceContainer.singleParamRegex)?c=f.parameters[a.slice(1,-1)]:(c=a.replace("%%","escpersign"),c=c.replace(b.ServiceContainer.multipleParamsRegex,function(a,b){return f.parameters[b]?f.parameters[b]:""}),c=c.replace("escpersign","%")),this.cachedParams[a]=c);else if(a instanceof Array)for(c=[],d=0,e=a.length;e>d;d++)c[d]=this.resolveParameters(a[d]);else if(b.isPlainObject(a)){c={};for(d in a)a.hasOwnProperty(d)&&(c[d]=this.resolveParameters(a[d]))}else c=a;return c},registerServices:function(a,b){var c;for(c in a)(!this.config.services.hasOwnProperty(c)||b)&&(this.config.services[c]=a[c],this.services[c]=void 0)},registerParameters:function(a,b){var c;for(c in a)(!this.config.parameters.hasOwnProperty(c)||b)&&(this.config.parameters[c]=a[c])}}),b.View=b.createClass({mixins:b.EventsMixin,staticProperties:{DATA_VIEW_ATTR:"data-kff-view",DATA_OPTIONS_ATTR:"data-kff-options",DATA_RENDERED_ATTR:"data-kff-rendered",DATA_BIND_ATTR:"data-kff-bind",DATA_TRIGGER_ATTR:"data-kff-trigger"}},{constructor:function(a){var c;return a=a||{},this.options={element:null,models:null,events:[],modelEvents:[]},this.initEvents(),a.parentView?(this.parentView=a.parentView,c=function(){},c.prototype=this.parentView.models,this.models=new c):this.models={},a.events&&(this.options.events=this.options.events.concat(a.events)),a.modelEvents&&(this.options.modelEvents=this.options.modelEvents.concat(a.modelEvents)),a.element&&(this.$element=$(a.element)),a.viewFactory&&(this.viewFactory=a.viewFactory),a.models&&b.mixins(this.models,a.models),b.mixins(this.options,a),this.viewFactory=a.viewFactory||new b.ViewFactory,this.subviewsStruct=[],this.explicitSubviewsStruct=null,this.subViews=[],this},getModel:function(a){var c;return a="string"==typeof a?a.split("."):[].concat(a),c=a.shift(),this.models&&c in this.models?a.length>0?this.models[c]instanceof b.Model?this.models[c].mget(a):null:this.models[c]:null},delegateEvents:function(a,b){var c,d,e,f;for(this.undelegateEvents(),a=a||this.options.events,b=b||this.$element,d=0,e=a.length;e>d;d++)c=a[d],3===c.length?(f="string"==typeof c[2]?this.f(c[2]):c[2],"string"==typeof c[1]?b.on(c[0],c[1],f):c[1].on(c[0],f)):2===c.length&&(f="string"==typeof c[1]?this.f(c[1]):c[1],b.on(c[0],f))},undelegateEvents:function(a,b){var c,d,e,f;for(a=a||this.options.events,b=b||this.$element,d=0,e=a.length;e>d;d++)c=a[d],3===c.length?(f="string"==typeof c[2]?this.f(c[2]):c[2],"string"==typeof c[1]?b.off(c[0],c[1],f):c[1].off(c[0],f)):2===c.length&&(f="string"==typeof c[1]?this.f(c[1]):c[1],b.off(c[0],f))},addEvents:function(a){this.options.events=this.options.events.concat(a)},delegateModelEvents:function(a){var b,c,d,e;for(this.undelegateModelEvents(),a=a||this.options.modelEvents,c=0,d=a.length;d>c;c++)b=a[c],3===b.length&&this.models[b[0]]&&(e="string"==typeof b[2]?this.f(b[2]):b[2],this.models[b[0]].on(b[1],e))},undelegateModelEvents:function(a){var b,c,d,e;for(a=a||this.options.modelEvents,c=0,d=a.length;d>c;c++)b=a[c],3===b.length&&this.models[b[0]]&&(e="string"==typeof b[2]?this.f(b[2]):b[2],this.models[b[0]].off(b[1],e))},init:function(){this.startRender()},render:function(){},startRender:function(a){this.explicitSubviewsStruct=[];var c=this.render();this.$element.attr(b.View.DATA_RENDERED_ATTR,!0),this.renderSubviews(),this.processTriggerEvents(),this.delegateEvents(),this.delegateModelEvents(),"function"==typeof this.afterRender&&this.afterRender(),a!==!0&&c!==!1&&this.trigger("render")},renderSubviews:function(){var a,c,d,e,f,g=this.$element.get(0);for(g&&this.findViewElements(g,this.subviewsStruct),f=this.subviewsStruct.concat(this.explicitSubviewsStruct),a=0,c=f.length;c>a;a++)e=f[a].options,e.element=f[a].$element,d=this.createView(f[a].viewName,e),d instanceof b.View&&d.init()},createView:function(a,c){c.parentView=this;var d=this.viewFactory.createView(a,c);return d instanceof b.View&&(d.viewFactory=this.viewFactory,this.subViews.push(d)),d},addSubview:function(a,b,c){this.explicitSubviewsStruct.push({viewName:b,$element:a,options:c||{}})},findViewElements:function(a,c,d){var e,f,g,h,i,j,k,l;if(a.hasChildNodes())for(g=a.childNodes,e=0,f=g.length;f>e;e++)h=g[e],1===h.nodeType&&(j=h.getAttribute(b.View.DATA_RENDERED_ATTR),(!j||d)&&(i=h.getAttribute(b.View.DATA_VIEW_ATTR),!i&&h.getAttribute(b.View.DATA_BIND_ATTR)&&(i="kff.BindingView",h.setAttribute(b.View.DATA_VIEW_ATTR,i)),i?(l=h.getAttribute(b.View.DATA_OPTIONS_ATTR),c.push({viewName:i,$element:$(h),options:l?JSON.parse(l):{}})):(k=h.getAttribute(b.View.DATA_TRIGGER_ATTR),k&&this.processChildTriggerEvents(h,k),this.findViewElements(h,c,d))))},processTriggerEvents:function(){this.processChildTriggerEvents(this.$element.get(0))},processChildTriggerEvents:function(a,c){var d,e,f,g,h=[];if(c=c||a.getAttribute(b.View.DATA_TRIGGER_ATTR)){for(d=c.split(/\s+/),f=0,g=d.length;g>f;f++)e=d[f].split(":"),h.push([e[0].replace("|"," "),$(a),this.f(function(){this.callTriggerMethod.apply(this,arguments)},[e[1]])]);this.addEvents(h)}},callTriggerMethod:function(a){"function"==typeof this[a]?this[a].apply(this,Array.prototype.slice.call(arguments,1)):this.parentView&&this.parentView.callTriggerMethod.apply(this.parentView,arguments)},destroy:function(){},startDestroy:function(a){var c;this.$element.removeAttr(b.View.DATA_RENDERED_ATTR),this.undelegateEvents(),this.undelegateModelEvents(),this.destroySubviews(),c=this.destroy(),"function"==typeof this.afterDestroy&&this.afterDestroy(),a!==!0&&c!==!1&&this.trigger("destroy")},destroySubviews:function(){var a,b,c;for(b=0,c=this.subViews.length;c>b;b++)a=this.subViews[b],a.startDestroy();this.subViews=[]},refresh:function(){},refreshBinders:function(a){for(var b=0,c=this.subViews.length;c>b;b++)this.subViews[b].refreshBinders(a)},getBindingIndex:function(a){return this.parentView instanceof b.View?this.parentView.getBindingIndex(a):null}}),b.PageView=b.createClass({extend:b.View,staticProperties:{precedingView:null}},{constructor:function(a){return a=a||{},a.element=$("body"),b.View.call(this,a)},delegateEvents:function(a,c){b.PageView._super.delegateEvents.call(this,a,c||$(document))},undelegateEvents:function(a,c){b.PageView._super.undelegateEvents.call(this,a,c||$(document))},setState:function(a,b){b||this.trigger("setState",a)}}),b.BinderMap=b.createClass({constructor:function(){this.binders=[]},add:function(a){this.binders.push(a)},clone:function(){var a,c,d=new b.BinderMap,e=d.binders;for(a=0,c=this.binders.length;c>a;a++)e[a]=this.binders[a].clone();return d},setView:function(a){var b,c;for(b=0,c=this.binders.length;c>b;b++)this.binders[b].view=a,this.binders[b].$element=a.$element,this.binders[b].model=a.getModel([].concat(this.binders[b].modelPathArray)),this.binders[b].value=null},initBinders:function(){for(var a=0,b=this.binders.length;b>a;a++)this.binders[a].init()},destroyBinders:function(){for(var a=0,b=this.binders.length;b>a;a++)this.binders[a].destroy()},refreshBinders:function(){for(var a=0,b=this.binders.length;b>a;a++)this.binders[a].modelChange(!0)}}),b.BindingView=b.createClass({extend:b.View,staticProperties:{bindingRegex:/(?:([.a-zA-Z0-9*-]+))((?::[a-zA-Z0-9]+(?:\((?:[^()]*)\))?)*)/g,operatorsRegex:/:([a-zA-Z0-9]+)(?:\(([^()]*)\))?/g,commaSeparateRegex:/\s*,\s*/,modifierSeparateRegex:/([^{},\s]+)|({[a-zA-Z0-9,\[\]_\-\.\s*]+})/g,leadingPeriodRegex:/^\./,trailingPeriodRegex:/\.$/,binders:{},helpers:{},registerBinder:function(a,c){b.BindingView.binders[a]=c},registerHelper:function(a,c){b.BindingView.helpers[a]=c}}},{constructor:function(a){a=a||{},this.modelBindersMap=null,this.collectionBinder=null,this.bindingIndex=null,this.itemAlias=null,b.View.call(this,a)},startRender:function(a){null!==this.modelBindersMap?this.modelBindersMap.initBinders():this.initBinding(),this.collectionBinder&&this.renderBoundViews(),b.BindingView._super.startRender.call(this,a),b.setZeroTimeout(this.f("refreshOwnBinders"))},startDestroy:function(){this.destroyBinding(),b.BindingView._super.startDestroy.call(this,!0),this.destroyBoundViews()},initBinding:function(){var a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=this.$element.attr(b.View.DATA_BIND_ATTR),u=b.BindingView.bindingRegex,v=b.BindingView.operatorsRegex,w=b.BindingView.modifierSeparateRegex,x=b.BindingView.commaSeparateRegex,y=b.BindingView.leadingPeriodRegex,z=b.BindingView.trailingPeriodRegex;for(u.lastIndex=0,v.lastIndex=0,this.modelBindersMap=new b.BinderMap;null!==(d=u.exec(t));){for(f=d[1].replace(y,"*.").replace(z,".*").split("."),i=[],j=[],l=[],k=[],m=[],n=!1,p=!1,o=0;null!==(e=v.exec(d[2]));){if(0===o)g=e[1],h=e[2],h=h?h.split(x):[];else switch(q=e[1],r=[],e[2]&&(r=e[2].match(w)),q){case"f":this.parseHelpers(r,i);break;case"p":this.parseHelpers(r,j);break;case"on":this.parseSetters(r,m);break;case"as":this.parseSetters(r,itemAliases);break;case"set":this.parseSetters(r,l);break;case"get":this.parseSetters(r,k);break;case"fill":n=!0;break;case"watch":p=!0}o++}if(a=this.getModel(f),a instanceof b.Collection)this.options.isBoundView||(this.collectionBinder={collection:a},"as"===g&&h.length>0&&(this.itemAlias=h[0]));else{if(!(g&&g in b.BindingView.binders))break;c=f.length>1?f.pop():null,"*"===c&&(c=null),s=f.length>0?f[0]:null,a=this.getModel(f),a instanceof b.Collection&&"count"===c&&(a=this.bindCollectionCount(a));var A=new b.BindingView.binders[g]({view:this,$element:this.$element,params:h,attr:c,model:a,modelName:s,modelPathArray:f,formatters:i,parsers:j,setters:l,getters:k,eventNames:m,fill:n,watchModelPath:p});this.modelBindersMap.add(A),A.init()}}},bindCollectionCount:function(a){var c=new b.Model,d=function(){c.set("count",a.count())};return d(),this.boundCollectionCounts||(this.boundCollectionCounts=[]),this.boundCollectionCounts.push({collection:a,handler:d}),a.on("change",d),c},destroyCollectionCountBindings:function(){if(this.boundCollectionCounts)for(var a=0,b=this.boundCollectionCounts.length;b>a;a++)this.boundCollectionCounts[a].collection.off("change",this.boundCollectionCounts[a].handler)},parseHelpers:function(a,c){for(var d,e,f=0,g=a.length;g>f;f++)d=a[f],g>f+1&&0===a[f+1].indexOf("{")?(e=a[f+1].match(/([^,{}]+)/g),f++):e=[],b.BindingView.helpers[d]&&c.push({fn:b.BindingView.helpers[d],args:e})},parseSetters:function(a,b){for(var c=0;c<a.length;c++)b.push(a[c])},destroyBinding:function(){this.modelBindersMap.destroyBinders(),this.modelBindersMap=null,this.destroyCollectionCountBindings()},renderBoundViews:function(){this.$anchor=$(document.createTextNode("")),this.$element.before(this.$anchor),this.$element.remove(),this.subViewsMap=[],this.subViewName=this.$element.attr(b.View.DATA_VIEW_ATTR);var a=this.$element.attr(b.View.DATA_OPTIONS_ATTR);this.initCollectionFilter(),this.subViewOptions=a?JSON.parse(a):{},this.subViewOptions.parentView=this,this.subViewOptions.viewFactory=this.viewFactory,this.subViewOptions.isBoundView=!0,this.collectionBinder.collection.on("change",this.f("refreshBoundViews")),this.refreshBoundViewsAll()},initCollectionFilter:function(){var a=this.$element.attr("data-kff-filter");a&&(this.collectionFilter={model:null,fn:null},a=a.replace(/^\./,"").split("."),1===a.length?this.collectionFilter.fn=a[0]:(this.collectionFilter.fn=a.pop(),this.collectionFilter.model=this.getModel([].concat(a))))},destroyBoundViews:function(){if(this.collectionBinder&&this.collectionBinder.collection.off("change",this.f("refreshBoundViews")),this.elements)for(var a=0,b=this.elements.length;b>a;a++)this.elements[a].remove();this.elements=[],this.$anchor&&(this.$anchor.after(this.$element),this.$anchor.remove())},refreshBoundViews:function(a){switch(a?a.type:null){case"append":this.refreshBoundViewsOnAppend(a);break;case"insert":this.refreshBoundViewsOnInsert(a);break;case"remove":this.refreshBoundViewsOnRemove(a);break;default:this.refreshBoundViewsAll()}},refreshBoundViewsOnAppend:function(a){this.subViewsMap.push(!1),a.item.on("change",this.f("collectionItemChange")),this.collectionItemChange({model:a.item})},refreshBoundViewsOnInsert:function(a){this.subViewsMap.splice(a.index,0,!1),a.item.on("change",this.f("collectionItemChange")),this.collectionItemChange({model:a.item})},refreshBoundViewsOnRemove:function(a){a.item.off("change",this.f("collectionItemChange"));for(var b=0,c=this.subViews.length;c>b&&a.item!==this.subViews[b].models["*"];b++);for(var d=b,e=null,b=0,c=this.subViewsMap.length;c>b;b++)if(this.subViewsMap[b]===d){e=b;break}null!==e&&(this.subViewsMap[b]!==!1&&this.removeSubViewAt(d),this.subViewsMap.splice(b,1)),this.reindexSubviews(b)},refreshBoundViewsAll:function(){var a,c,d,e,f=0,g=this.f("collectionItemChange"),h=this;b.setZeroTimeout(function(){if(h.collectionBinder.collection.each(function(a){a.off("change",g)}),h.destroySubviews(),h.elements)for(var b=0,i=h.elements.length;i>b;b++)h.elements[b].remove();h.elements=[],h.subViewsMap=[],h.collectionFilter&&(a=!0,c=h.collectionFilter.model||null,d=h.collectionFilter.fn),h.collectionBinder.collection.each(function(b){var i;e=!0,b.on("change",g),a&&(i=c||b,e=!!i[d](b)),e?(h.elements.push(h.createSubView(b)),h.subViewsMap.push(f),f++):h.subViewsMap.push(!1)})}),b.setZeroTimeout(function(){if("Zepto"in window&&$===window.Zepto){for(var a=[],b=0,c=h.elements.length;c>b;b++)a.push(h.elements[b].get(0));h.$anchor.after(a),h.reindexSubviews()}else h.$anchor.after(h.elements),h.reindexSubviews()})},collectionItemChange:function(a){var b,c,d,e,f=a.model,g=this.collectionBinder.collection.indexOf(f);if(this.collectionFilter)if(e=f,this.collectionFilter.model&&(e=this.collectionFilter.model),c=0,d=!!e[this.collectionFilter.fn].call(e,f),d&&this.subViewsMap[g]===!1){for(b=0;g>b;b++)this.subViewsMap[b]!==!1&&c++;this.addSubViewAt(g,c)}else d||this.subViewsMap[g]===!1||(c=this.subViewsMap[g],this.subViewsMap[g]=!1,this.removeSubViewAt(c));else this.subViewsMap[g]===!1&&this.addSubViewAt(g,g)},refilterCollection:function(){this.collectionBinder.collection.each(this.f(function(a){this.collectionItemChange({model:a})}))},removeSubViewAt:function(a){this.subViews[a]&&(this.subViews[a].startDestroy(),this.subViews.splice(a,1),this.elements[a].remove(),this.elements.splice(a,1),this.reindexSubviews(a))},addSubViewAt:function(a,b){var c=this.collectionBinder.collection.findByIndex(a),d=this.createSubView(c,b);0===b?this.$anchor.after(d):this.elements[b-1].after(d),this.elements.splice(b,0,d),this.subViewsMap[a]=b,this.reindexSubviews(b)},reindexSubviews:function(a,b){a||(a=0),(!b||b>this.subViews.length)&&(b=this.subViews.length);for(var c=a;b>c;c++)this.subViews[c].setBindingIndex(c),this.subViews[c].refreshBinders(!0);for(var c=0,d=this.subViewsMap.length,e=0;d>c;c++)this.subViewsMap[c]!==!1&&(this.subViewsMap[c]=e,e++)},createSubView:function(a,c){var d,e=this.$element.clone();return this.subViewOptions.element=e,this.subViewOptions.models={"*":a},this.itemAlias&&(this.subViewOptions.models[this.itemAlias]=a),d=new this.constructor(this.subViewOptions),d instanceof b.View&&(void 0===c?(this.subViews.push(d),c=this.subViews.length-1):this.subViews.splice(c,0,d),d.setBindingIndex(c),this.modelBindersMapTemplate&&(d.modelBindersMap=this.modelBindersMapTemplate.clone(),d.modelBindersMap.setView(d)),d.init(),this.modelBindersMapTemplate||(this.modelBindersMapTemplate=d.modelBindersMap.clone(),this.modelBindersMapTemplate.destroyBinders())),e},refreshOwnBinders:function(a){this.modelBindersMap&&this.modelBindersMap.refreshBinders(),a!==!0&&this.collectionBinder&&this.collectionFilter&&this.refilterCollection()},refreshBinders:function(a){this.refreshOwnBinders(a),b.BindingView._super.refreshBinders.call(this,a)},renderSubviews:function(){this.collectionBinder||b.BindingView._super.renderSubviews.call(this)},getBindingIndex:function(a){return a=a||"*",null!==this.bindingIndex&&this.models.hasOwnProperty(a)?this.bindingIndex:this.parentView instanceof b.View?this.parentView.getBindingIndex(a):null},setBindingIndex:function(a){this.bindingIndex=a}}),b.BindingView.registerHelper("index",function(a,b){return null!==this.getBindingIndex(b)?this.getBindingIndex(b):a}),b.BindingView.registerHelper("indexFromOne",function(a,b){return null!==this.getBindingIndex(b)?this.getBindingIndex(b)+1:a}),b.BindingView.registerHelper("boolean",function(a){var b=parseInt(a,10);return isNaN(b)?"true"===a:!!b}),b.BindingView.registerHelper("not",function(a){return!a}),b.BindingView.registerHelper("null",function(a){return null===a||"null"===a?null:a}),b.BindingView.registerHelper("int",function(a){return a=parseInt(a,10),isNaN(a)&&(a=0),a}),b.BindingView.registerHelper("float",function(a){return a=parseFloat(a),isNaN(a)&&(a=0),a}),b.BindingView.registerHelper("string",function(a){return a.toString()}),b.Binder=b.createClass({constructor:function(a){this.options=a,this.eventNames=a.eventNames,this.events=a.events||[],this.view=a.view,this.$element=a.$element,this.attr=a.attr,this.model=a.model,this.modelName=a.modelName,this.modelPathArray=a.modelPathArray,this.parsers=a.parsers,this.formatters=a.formatters,this.setter=a.setters instanceof Array&&a.setters.length>0?a.setters[0]:null,this.getter=a.getters instanceof Array&&a.getters.length>0?a.getters[0]:null,this.params=a.params,this.currentValue=null,this.bindingIndex=null,this.dynamicBindings=[],this.value=null},init:function(){this.options.watchModelPath?this.rebind():this.model instanceof b.Model&&(this.model.on("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.$element&&this.events.length>0&&this.delegateEvents.call(this,this.events)),this.options.fill&&this.model instanceof b.Model&&this.fill()},destroy:function(){this.model instanceof b.Model&&this.model.off("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.options.watchModelPath&&this.unbindDynamic(),this.$element&&this.events.length>0&&this.undelegateEvents.call(this,this.events),this.currentValue=null,this.value=null},delegateEvents:b.View.prototype.delegateEvents,undelegateEvents:b.View.prototype.undelegateEvents,modelChange:function(a){var c;this.model instanceof b.Model&&(c=this.getter&&"function"==typeof this.model[this.getter]?this.model[this.getter](this.attr):a!==!0?a.changed[this.attr]:"string"==typeof this.attr?this.model.get(this.attr):null,a!==!0&&this.compareValues(c,this.currentValue)||(this.value=this.format(c),this.currentValue=c,this.refresh()))},compareValues:function(a,b){if(a instanceof Array&&b instanceof Array){var c=a.length;if(c!==b.length)return!1;for(var d=0;c>d;d++)if(a[d]!==b[d])return!1;return!0}return a===b},getFormattedValue:function(){return this.value},updateModel:function(a){var b,c;if(a instanceof Array)for(b=0,c=a.length;c>b;b++)a[b]=this.parse(a[b]);else a=this.parse(a);this.compareValues(a,this.currentValue)||(this.currentValue=a,this.setter&&"function"==typeof this.model[this.setter]?null===this.attr?this.model[this.setter](this.currentValue):this.model[this.setter](this.attr,this.currentValue):this.model.set(this.attr,this.currentValue))},refresh:function(){},format:function(a){var b,c,d,e,f;for(b=0,c=this.formatters.length;c>b;b++)if(a instanceof Array){for(f=[],d=0,e=a.length;e>d;d++)f[d]=this.formatters[b].fn.apply(this,[a[d]].concat(this.formatters[b].args));a=f}else a=this.formatters[b].fn.apply(this,[a].concat(this.formatters[b].args));return a},parse:function(a){var b,c,d,e,f;for(b=0,c=this.parsers.length;c>b;b++)if(a instanceof Array){for(f=[],d=0,e=a.length;e>d;d++)f[d]=this.parsers[b].fn.apply(this,[a[d]].concat(this.parsers[b].args));a=f}else a=this.parsers[b].fn.apply(this,[a].concat(this.parsers[b].args));return a},getBindingIndex:function(a){return a=a||"*",this.view.getBindingIndex(a)},clone:function(){var a=new this.constructor({eventNames:this.eventNames,view:null,$element:this.$element,attr:this.attr,model:null,modelName:this.modelName,modelPathArray:this.modelPathArray,parsers:this.parsers,formatters:this.formatters,params:this.params,fill:this.options.fill});return a.setter=this.setter,a.getter=this.getter,a},fill:function(){},rebindTimed:function(){b.setZeroTimeout(this.f("rebind"))},rebind:function(){this.unbindDynamic(),this.model instanceof b.Model&&(this.model.off("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.$element&&this.events.length>0&&this.undelegateEvents.call(this,this.events)),this.bindDynamic(),this.model instanceof b.Model&&(this.model.on("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.$element&&this.events.length>0&&this.delegateEvents.call(this,this.events),this.modelChange(!0))
},bindDynamic:function(){for(var a,c=this.modelPathArray[0],d=this.view.getModel(c),e=1,f=this.modelPathArray.length;f>e;e++)a=this.modelPathArray[e],d instanceof b.Model?(d.on("change:"+a,this.f("rebindTimed")),this.dynamicBindings.push({model:d,attr:a}),d=d.get(a)):d=null!==d&&"object"==typeof d&&a in d?d.attr:null;this.model=d instanceof b.Model?d:null},unbindDynamic:function(){for(var a=0,b=this.dynamicBindings.length;b>a;a++)this.dynamicBindings[a].model.off("change:"+this.dynamicBindings[a].attr,this.f("rebindTimed"));this.dynamicBindings=[]}}),b.EventBinder=b.createClass({extend:b.Binder},{constructor:function(a){var c=a.eventNames.length>0?a.eventNames.join(" "):"click";a.events=[[c,"triggerEvent"]],b.Binder.call(this,a)},init:function(){this.userValue=this.params[0]||null,b.EventBinder._super.init.call(this)},triggerEvent:function(a){b.setZeroTimeout(this.f(function(){this.updateModel(this.userValue)})),a.preventDefault()},compareValues:function(){return!1}}),b.BindingView.registerBinder("event",b.EventBinder),b.AttrBinder=b.createClass({extend:b.Binder},{constructor:function(a){b.Binder.call(this,a)},init:function(){this.attribute=this.params[0]||null,this.prefix=this.params[1]||"",this.suffix=this.params[2]||"",b.AttrBinder._super.init.call(this)},refresh:function(){this.attribute&&this.$element.attr(this.attribute,this.prefix+this.value+this.suffix)}}),b.BindingView.registerBinder("attr",b.AttrBinder),b.CheckBinder=b.createClass({extend:b.Binder},{constructor:function(a){var c=a.eventNames.length>0?a.eventNames.join(" "):"click change";a=a||{},a.events=[[c,"inputChange"]],b.Binder.call(this,a)},inputChange:function(){b.setZeroTimeout(this.f(function(){this.updateModel(this.$element.is(":checked"))}))},refresh:function(){this.$element.prop("checked",!!this.value)},fill:function(){this.fillVal||(this.fillVal=this.$element.is(":checked")),b.setZeroTimeout(this.f(function(){this.updateModel(this.fillVal)}))}}),b.BindingView.registerBinder("check",b.CheckBinder),b.DisabledBinder=b.createClass({extend:b.Binder},{constructor:function(a){b.Binder.call(this,a)},refresh:function(){this.$element.prop("disabled",!!this.value)},fill:function(){this.fillVal||(this.fillVal=this.$element.is(":disbaled")),b.setZeroTimeout(this.f(function(){this.updateModel(this.fillVal)}))}}),b.BindingView.registerBinder("disabled",b.DisabledBinder),b.ClassBinder=b.createClass({extend:b.Binder},{constructor:function(a){b.Binder.call(this,a)},init:function(){this.className=this.params[0]||null,this.equalsTo=this.params[1]||!0,this.operator=this.params[2]||null,b.ClassBinder._super.init.call(this)},refresh:function(){this.className&&this.$element[this.matchValue()?"addClass":"removeClass"](this.className)},matchValue:function(){return this.equalsTo?"ne"===this.operator?this.value!==this.parse(this.equalsTo):this.value===this.parse(this.equalsTo):this.value}}),b.BindingView.registerBinder("class",b.ClassBinder),b.StyleBinder=b.createClass({extend:b.Binder},{constructor:function(a){b.Binder.call(this,a)},init:function(){this.styleProperty=this.params[0]||null,b.StyleBinder._super.init.call(this)},refresh:function(){this.styleProperty&&this.$element.css(this.styleProperty,this.value)}}),b.BindingView.registerBinder("style",b.StyleBinder),b.ClickBinder=b.createClass({extend:b.EventBinder},{constructor:function(a){0===a.eventNames.length&&(a.eventNames=["click"]),b.EventBinder.call(this,a)}}),b.BindingView.registerBinder("click",b.ClickBinder),b.DoubleClickBinder=b.createClass({extend:b.EventBinder},{constructor:function(a){0===a.eventNames.length&&(a.eventNames=["dblclick"]),b.EventBinder.call(this,a)}}),b.BindingView.registerBinder("dblclick",b.DoubleClickBinder),b.FocusBinder=b.createClass({extend:b.EventBinder},{constructor:function(a){0===a.eventNames.length&&(a.eventNames=["focus"]),b.EventBinder.call(this,a)}}),b.BindingView.registerBinder("focus",b.FocusBinder),b.BlurBinder=b.createClass({extend:b.EventBinder},{constructor:function(a){0===a.eventNames.length&&(a.eventNames=["blur"]),b.EventBinder.call(this,a)}}),b.BindingView.registerBinder("blur",b.BlurBinder),b.FocusBlurBinder=b.createClass({extend:b.EventBinder},{constructor:function(a){0===a.eventNames.length&&(a.eventNames=["focus blur"]),b.EventBinder.call(this,a)},triggerEvent:function(){b.setZeroTimeout(this.f(function(){this.updateModel(this.$element.is(":focus"))}))},refresh:function(){this.value?this.$element.is(":focus")||this.$element.trigger("focus"):this.$element.is(":focus")&&this.$element.trigger("blur")}}),b.BindingView.registerBinder("focusblur",b.FocusBlurBinder),b.HtmlBinder=b.createClass({extend:b.Binder},{constructor:function(a){b.Binder.call(this,a)},refresh:function(){this.$element.html(this.value)}}),b.BindingView.registerBinder("html",b.HtmlBinder),b.RadioBinder=b.createClass({extend:b.Binder},{constructor:function(a){var c=a.eventNames.length>0?a.eventNames.join(" "):"click";a=a||{},a.events=[[c,"inputChange"]],b.Binder.call(this,a)},inputChange:function(){b.setZeroTimeout(this.f(function(){this.$element.is(":checked")&&this.updateModel(this.$element.val())}))},refresh:function(){this.$element.prop("checked",this.parse(this.$element.val())===this.currentValue)},fill:function(){this.fillVal||(this.fillVal=this.$element.is(":checked")),b.setZeroTimeout(this.f(function(){this.fillVal&&this.updateModel(this.$element.val())}))}}),b.BindingView.registerBinder("radio",b.RadioBinder),b.TextBinder=b.createClass({extend:b.Binder},{constructor:function(a){b.Binder.call(this,a)},refresh:function(){this.$element.text(this.value)}}),b.BindingView.registerBinder("text",b.TextBinder),b.ValueBinder=b.createClass({extend:b.Binder},{constructor:function(a){var c=a.eventNames.length>0?a.eventNames.join(" "):"keydown drop change";a.events=[[c,"inputChange"]],b.Binder.call(this,a)},inputChange:function(){b.setZeroTimeout(this.f(function(){this.updateModel(this.$element.val())}))},refresh:function(){this.$element.val(this.getFormattedValue())},fill:function(){this.fillVal||(this.fillVal=this.$element.val()),b.setZeroTimeout(this.f(function(){this.updateModel(this.fillVal)}))}}),b.BindingView.registerBinder("val",b.ValueBinder),b.ViewFactory=b.createClass({constructor:function(a){a=a||{},this.serviceContainer=a.serviceContainer||null,this.precedingViews=a.precedingViews||{}},createView:function(a,c){var d,e=null;return c=c||{},"function"!=typeof a&&this.serviceContainer&&this.serviceContainer.hasService(a)?e=this.serviceContainer.getService(a,[c]):(d="function"!=typeof a?b.evalObjectPath(a):a,d&&(e=new d(b.mixins({},c,{viewFactory:this})))),e},getServiceConstructor:function(a){return"function"==typeof a?a:this.serviceContainer&&this.serviceContainer.hasService(a)?this.serviceContainer.getServiceConstructor(a):b.evalObjectPath(a)},getPrecedingView:function(a){var b;return"string"==typeof a&&void 0!==this.precedingViews[a]?this.precedingViews[a]:(b=this.getServiceConstructor(a),b&&b.precedingView?b.precedingView:null)}}),b.Route=b.createClass({constructor:function(a,b){this.pattern=a,this.target=b,this.keys=null,this.regexp=this.compileRegex()},getTarget:function(){return this.target},match:function(a,b){var c=this.keys,d=a.indexOf("?"),e=~d?a.slice(0,d):a,f=this.regexp.exec(e);if(!f)return!1;for(var g=1,h=f.length;h>g;++g){var i=c[g-1],j="string"==typeof f[g]?decodeURIComponent(f[g]):f[g];i?b[i.name]=void 0!==b[i.name]?b[i.name]:j:b.push(j)}return!0},compileRegex:function(a,b){var c,d=this.keys=[];return c=this.pattern.concat(b?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,b,c,e,f,g){return d.push({name:e,optional:!!g}),b=b||"",""+(g?"":b)+"(?:"+(g?b:"")+(c||"")+(f||c&&"([^/.]+?)"||"([^/]+?)")+")"+(g||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),new RegExp("^"+c+"$",a?"":"i")}}),b.Router=b.createClass({constructor:function(a){this.options=a||{},this.routes=[],this.buildRoutes()},buildRoutes:function(){this.routes=[];var a=this.options.routes;for(var c in a)this.routes.push(new b.Route(c,a[c]))},match:function(a){for(var b,c=0,d=this.routes.length;d>c;c++)if(b=[],this.routes[c].match(a,b))return{target:this.routes[c].getTarget(),params:b};return null}}),b.FrontController=b.createClass({constructor:function(a){a=a||{},this.options=a,this.views=null,this.viewsQueue=[],this.viewFactory=a.viewFactory||new b.ViewFactory,this.router=a.router||null},init:function(){this.router?$(window).bind("hashchange",this.f("hashChange")).trigger("hashchange"):this.setState(null)},createViewFromState:function(a){if(this.router){var b,c=a.path;if(""===c&&(c="#"),b=this.router.match(c))return a.params=b.params,b.target}return this.options.defaultView},hashChange:function(){var a=location.hash;return 0!==a.indexOf("#")&&""!=a?!1:(this.setState({path:a,params:{}}),!1)},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(a){var c=this.getLastView();this.viewsQueue.push(a),c&&(c.instance.on("render",b.bindFn(a.instance,"init")),c.instance.on("setState",b.bindFn(a.instance,"setState")))},popView:function(){if(0!==this.viewsQueue.length){var a=this.viewsQueue.pop(),c=this.getLastView();return a.instance.off("init",b.bindFn(this,"cascadeState")),c&&(c.instance.off("init",b.bindFn(a.instance,"init")),c.instance.off("setState",b.bindFn(a.instance,"setState"))),a}},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].instance.setState(this.state)},setState:function(a){var c,d,e,f=[];for(this.state=a,this.newViewName=this.createViewFromState(a),c=this.getLastView()?this.getLastView().name:null,d=this.findSharedView(this.newViewName,c);null!==(c=this.getLastView()?this.getLastView().name:null)&&c!==d;)f.push(this.popView());for(e=0;e<f.length;e++)f[e+1]?f[e].instance.on("destroy",b.bindFn(f[e+1].instance,"startDestroy")):f[e].instance.on("destroy",b.bindFn(this,"startInit"));f[0]?f[0].instance.startDestroy():this.startInit()},startInit:function(){var a,c,d=this.getPrecedingViews(this.newViewName),e=0;for(a=0,c=d.length;c>a;a++)a>=this.viewsQueue.length?this.pushView({name:d[a],instance:this.viewFactory.createView(d[a],{viewFactory:this.viewFactory})}):e=a+1;this.newViewName=null,this.getLastView()&&this.getLastView().instance.on("render",b.bindFn(this,"cascadeState")),this.viewsQueue[e]?this.viewsQueue[e].instance.init():this.cascadeState()},findSharedView:function(a,b){var c,d=this.getPrecedingViews(a),e=this.getPrecedingViews(b),f=null;for(c=0,l=d.length<e.length?d.length:e.length;l>c&&d[c]===e[c];c++)f=d[c];return f},getPrecedingViews:function(a){for(var b=a,c=[b];b;)b=this.viewFactory.getPrecedingView(b),b&&c.unshift(b);return c}}),b.App=b.createClass({constructor:function(a){var c;a=a||{},c=a.models||{};var d={parameters:{},services:{viewFactory:{construct:"kff.ViewFactory",args:[{serviceContainer:"@"}],shared:!0},frontController:{construct:"kff.FrontController",args:[{viewFactory:"@viewFactory",defaultView:"pageView"}],shared:!0},pageView:{construct:"kff.PageView",args:[{viewFactory:"@viewFactory",models:c}]}}};return this.serviceContainer=new b.ServiceContainer(d),"parameters"in a&&this.serviceContainer.registerParameters(a.parameters,!0),"services"in a&&this.serviceContainer.registerServices(a.services,!0),this},init:function(){this.serviceContainer.getService("frontController").init()},getServiceContainer:function(){return this.serviceContainer}})}(this);