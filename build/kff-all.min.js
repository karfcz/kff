(function(e){var t;t="undefined"!=typeof exports?exports:"kff"in e?e.kff:e.kff={},t.widgets={},t.extend=function(e,t){var i=function(){};e._super=i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e},t.mixins=function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},t.createClass=function(e,i){var n;0===arguments.length?e=i={}:1===arguments.length&&(i=e,e={}),n=i.hasOwnProperty("constructor")?i.constructor:e.extend?function(){e.extend.apply(this,arguments)}:function(){},e.extend&&t.extend(n,e.extend),"mixins"in e?e.mixins instanceof Array||(e.mixins=[e.mixins]):e.mixins=[],e.mixins.push(t.classMixin);for(var s=0,r=e.mixins.length;r>s;s++)t.mixins(i,e.mixins[s]);return e.staticProperties&&t.mixins(n,e.staticProperties),t.mixins(n.prototype,i),n.prototype.constructor=n,n},t.bindFn=function(e,t){if("function"!=typeof e[t])throw new TypeError("Expected function: "+t+" (kff.bindFn)");return"_boundFns"in e||(e._boundFns={}),t in e._boundFns?e._boundFns[t]:(e._boundFns[t]=function(){return e[t].apply(e,arguments)},e._boundFns[t])},t.classMixin={f:function(e){var i=this;if("string"==typeof e)return t.bindFn(i,e);if("function"==typeof e)return function(){return e.apply(i,arguments)};throw new TypeError("Expected function: "+e+" (kff.f)")}},t.evalObjectPath=function(t,i){i=i||e;for(var n=t.split(".");n.length;){if(!(n[0]in i))return null;i=i[n.shift()]}return i},t.Events=t.createClass({constructor:function(){this.subscribers={},this.oneSubscribers={}},on:function(e,i){if(this.off(e,i),e instanceof Array)for(var n=0,s=e.length;s>n;n++)e[n]&&(this.subscribers[e[n]]||(this.subscribers[e[n]]=[]),this.subscribers[e[n]].push(i));else this.subscribers[e]||(this.subscribers[e]=new t.List),this.subscribers[e].append(i)},one:function(e,t){e in this.oneSubscribers||(this.oneSubscribers[e]=[]),this.oneSubscribers[e].push(t),this.on(e,t)},off:function(e,i){var n,s;if(e instanceof Array)for(n=0,s=e.length;s>n;n++)e[n]&&this.off(e[n],i);else this.subscribers[e]instanceof t.List&&this.subscribers[e].removeVal(i)},trigger:function(e,i){var n,s;if(e instanceof Array)for(n=0,s=e.length;s>n;n++)e[n]&&this.trigger(e[n],i);else if(this.subscribers[e]instanceof t.List&&(this.subscribers[e].each(function(e){e.call(null,i)}),e in this.oneSubscribers)){for(n=0,s=this.oneSubscribers[e].length;s>n;n++)this.off(e,this.oneSubscribers[e][n]);this.oneSubscribers[e]=[]}}}),t.EventsMixin={on:function(e,t){return this.events.on(e,t)},one:function(e,t){return this.events.one(e,t)},off:function(e,t){return this.events.off(e,t)},trigger:function(e,t){return this.events.trigger(e,t)}},t.List=t.createClass({constructor:function(){this.array=[],this.count=this.array.length},each:function(e){for(var t=this.array,i=t.length,n=0;i>n&&e.call(null,t[n],n)!==!1;n++);},append:function(e){this.array.push(e),this.count++},remove:function(e){var t=this.indexOf(e);return-1===t?!1:(this.array.splice(t,1),this.count--,!0)},empty:function(){this.array=[],this.count=0},indexOf:function(e){var t=0,i=this.array,n=i.length;if(i.indexOf)return i.indexOf(e);for(;n>t;t++)if(i[t]===e)return t;return-1},findByIndex:function(e){return this.array[e]},sort:function(e){this.array.sort(e)},shuffle:function(){for(var e,t,i=this.array,n=i.length,s=n;s--;)e=parseInt(Math.random()*n,10),t=i[s],i[s]=i[e],i[e]=t}}),t.List.prototype.removeVal=t.List.prototype.remove,t.Collection=t.createClass({extend:t.List,mixins:t.EventsMixin},{constructor:function(e){return e=e||{},this.valFactory=e.valFactory||null,this.valType=e.valType||t.Model,this.serializeAttrs=e.serializeAttrs||null,this.events=new t.Events,t.List.call(this),this},append:function(e,i){t.Collection._super.append.call(this,e),i||this.trigger("change",{addedValue:e})},remove:function(e,i){var n=t.Collection._super.remove.call(this,e);return n&&!i&&this.trigger("change",{removedValue:e}),n},toJson:function(){var e=this.serializeAttrs,t=[];return this.each(function(i){i&&i.toJson?t.push(i.toJson(e)):t.push(i)}),t},fromJson:function(e,t){var i,n=this.valFactory;this.empty();for(var s=0;e.length>s;s++)i=n?n(e[s]):new this.valType,i.fromJson(e[s],t),this.append(i,!0);t||this.trigger("change",{fromJson:!0})},findByAttr:function(e,t){var i=null;return this.each(function(n){return n&&n.get(e)===t?(i=n,!1):void 0}),i},empty:function(e){t.Collection._super.empty.call(this),e||this.trigger("change")},sort:function(e,i){t.Collection._super.sort.call(this,e),i||this.trigger("change")},clone:function(){var e=new t.Collection(this.options);return this.each(function(t){e.append(t)}),e},shuffle:function(e){t.Collection._super.shuffle.call(this),e||this.trigger("change")}}),t.Collection.prototype.removeVal=t.Collection.prototype.remove,t.Model=t.createClass({mixins:t.EventsMixin},{constructor:function(e){this.events=new t.Events,this.attrs=this.attrs||{},e&&this.set(e)},has:function(e){return e in this.attrs},get:function(e){return this.attrs[e]},mget:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=this.get(e.shift()),e.length>0?i instanceof t.Model?i.mget(e):t.evalObjectPath(e,i):i},set:function(e,t,i){var n={};if("string"==typeof e){if(this.get(e)===t)return;n[e]=t,this.attrs[e]=t}else if(null!==e&&e instanceof Object){i=t,n=e;for(var s in n)this.attrs[s]=n[s]}if(!i){for(var r in n)this.trigger("change:"+r,{model:this,changedAttributes:n});this.trigger("change",{model:this,changedAttributes:n})}},toJson:function(e){var t={};for(var i in this.attrs)e&&-1===$.inArray(i,e)||!this.attrs.hasOwnProperty(i)||(t[i]=this.attrs[i]&&"object"==typeof this.attrs[i]&&"toJson"in this.attrs[i]?this.attrs[i].toJson():this.attrs[i]);return t},fromJson:function(e,t){if(e){for(var i in this.attrs)this.attrs.hasOwnProperty(i)&&e.hasOwnProperty(i)&&(this.attrs[i]&&"object"==typeof this.attrs[i]&&"fromJson"in this.attrs[i]?this.attrs[i].fromJson(e[i]):this.attrs[i]=e[i]);this.set(this.attrs,t)}}}),t.ServiceContainer=t.createClass({staticProperties:{singleParamRegex:/^%[^%]+%$/g,multipleParamsRegex:/%([^%]+)%/g}},{constructor:function(e){this.config=e||{parameters:{},services:{}},this.services={},this.cachedParams={}},getService:function(e){if(!this.config.services[e])throw"Service "+e+" not defined";return this.config.services[e].shared?(this.services[e]===void 0&&(this.services[e]=this.createService(e)),this.services[e]):this.createService(e)},hasService:function(e){return this.config.services.hasOwnProperty(e)},createService:function(e){var t,i,n,s,r,o,a,h;if(t=this.config.services[e],i=this.getServiceConstructor(e),n=function(){},n.prototype=i.prototype,s=new n,r=i.apply(s,this.resolveParameters(t.args||[])),Object(r)===r&&(s=r),h=t.calls,h instanceof Array)for(o=0,a=h.length;a>o;o++)s[h[o].method].apply(s,this.resolveParameters(h[o].args));return s},getServiceConstructor:function(e){var i,n;if(i=this.config.services[e],!i)return null;if(i.hasOwnProperty("constructor")?"string"==typeof i.constructor&&(i.constructor=t.evalObjectPath(i.constructor)):(n=t.evalObjectPath(e),"function"==typeof n&&(i.constructor=n)),"function"!=typeof i.constructor)throw new TypeError("expected function in getServiceConstructor: "+i.constructor);return i.constructor},resolveParameters:function(e){var i,n,s,r;if(r=this.config,"string"==typeof e)"@"===e.charAt(0)?(e=e.slice(1),i=0===e.length?this:this.getService(e)):void 0!==this.cachedParams[e]?i=this.cachedParams[e]:(-1!==e.search(t.ServiceContainer.singleParamRegex)?i=r.parameters[e.slice(1,-1)]:(i=e.replace("%%","escpersign"),i=i.replace(t.ServiceContainer.multipleParamsRegex,function(e,t){return r.parameters[t]?r.parameters[t]:""}),i=i.replace("escpersign","%")),this.cachedParams[e]=i);else if(e instanceof Array)for(i=[],n=0,s=e.length;s>n;n++)i[n]=this.resolveParameters(e[n]);else if("object"==typeof e&&e.constructor===Object){i={};for(n in e)i[n]=this.resolveParameters(e[n])}else i=e;return i}}),t.View=t.createClass({mixins:t.EventsMixin,staticProperties:{DATA_VIEW_ATTR:"data-kff-view",DATA_OPTIONS_ATTR:"data-kff-options",DATA_RENDERED_ATTR:"data-kff-rendered",DATA_BIND_ATTR:"data-kff-bind"}},{constructor:function(e){return e=e||{},this.events=new t.Events,this.options={element:null,models:null,events:[]},this.models={},this.setOptions(e),this.viewFactory=e.viewFactory||new t.ViewFactory,this.subViews=[],this},setOptions:function(e){e=e||{},e.events&&(this.options.events=this.options.events.concat(e.events)),e.element&&(this.$element=$(e.element)),e.viewFactory&&(this.viewFactory=e.viewFactory),e.parentView&&(this.parentView=e.parentView),e.models&&(this.models=e.models),$.extend(this.options,e)},getModel:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=e.shift(),this.models&&i in this.models?e.length>0?this.models[i]instanceof t.Model?this.models[i].mget(e):null:this.models[i]:this.options.parentView?(e.unshift(i),this.options.parentView.getModel(e)):null},delegateEvents:function(e,i){var n,s,r;for(this.undelegateEvents(),e=e||this.options.events,i=i||this.$element,s=0,r=e.length;r>s;s++)n=e[s],3===n.length?i.on(n[0],n[1],t.bindFn(this,n[2])):2===n.length&&i.on(n[0],t.bindFn(this,n[1]))},undelegateEvents:function(e,i){var n,s,r;for(e=e||this.options.events,i=i||this.$element,s=0,r=e.length;r>s;s++)n=e[s],3===n.length?i.off(n[0],n[1],t.bindFn(this,n[2])):2===n.length&&i.off(n[0],t.bindFn(this,n[1]))},addEvents:function(e){this.options.events=this.options.events.concat(e)},init:function(){this.render()},render:function(e){this.$element.attr(t.View.DATA_RENDERED_ATTR,!0),this.delegateEvents(),this.renderSubviews(),e||this.trigger("init")},renderSubviews:function(){var e,i,n,s,r,o,a=[],h=this.options.filter||void 0;for(this.$element.get(0)&&this.findViewElements(this.$element.get(0),a,h),r=0,o=a.length;o>r;r++)e=a[r].objPath,s=a[r].$element.attr(t.View.DATA_OPTIONS_ATTR),n=s?JSON.parse(s):{},n.element=a[r].$element,n.parentView=this,i=this.viewFactory.createView(e,n),i instanceof t.View&&(i.viewFactory=this.viewFactory,this.subViews.push(i),i.init())},findViewElements:function(e,i,n){var s,r,o,a,h,l;if(e.hasChildNodes())for(o=e.childNodes,s=0,r=o.length;r>s;s++)a=o[s],1===a.nodeType&&(l=a.getAttribute(t.View.DATA_RENDERED_ATTR),l||(h=a.getAttribute(t.View.DATA_VIEW_ATTR),!h&&a.getAttribute(t.View.DATA_BIND_ATTR)&&(h="kff.BindingView",a.setAttribute(t.View.DATA_VIEW_ATTR,h)),h?(!n||n&&$(a).is(n))&&i.push({objPath:h,$element:$(a)}):this.findViewElements(a,i,n)))},destroy:function(e){this.$element.removeAttr(t.View.DATA_RENDERED_ATTR),this.destroySubviews(),this.undelegateEvents(),e||this.trigger("destroy")},destroySubviews:function(){var e,t,i;for(t=0,i=this.subViews.length;i>t;t++)e=this.subViews[t],e.destroy(),delete this.subViews[t];this.subViews=[]},refresh:function(){},refreshBinders:function(){for(var e=0,t=this.subViews.length;t>e;e++)this.subViews[e].refreshBinders()}}),t.View.helpers={index:function(e){return null!==this.getBindingIndex()?this.getBindingIndex():e},"boolean":function(e){var t=parseInt(e,10);return isNaN(t)?"true"===e:!!t},not:function(e){return!e},"null":function(e){return null===e||"null"===e?null:e},"int":function(e){return e=parseInt(e,10),isNaN(e)&&(e=0),e},"float":function(e){return e=parseFloat(e),isNaN(e)&&(e=0),e},uppercase:function(e){return(e||"").toUpperCase()},lowercase:function(e){return(e||"").toLowerCase()},strong:function(e){return"<strong>"+e+"</strong>"}},t.PageView=t.createClass({extend:t.View,staticProperties:{precedingView:null}},{constructor:function(e){return e=e||{},e.element=$("body"),t.View.call(this,e)},delegateEvents:function(e,i){t.PageView._super.delegateEvents.call(this,e,i||$(document))},undelegateEvents:function(e,i){t.PageView._super.undelegateEvents.call(this,e,i||$(document))},setState:function(e,t){t||this.trigger("setState",e)}}),t.BindingView=t.createClass({extend:t.View,staticProperties:{binders:{},registerBinder:function(e,i){t.BindingView.binders[e]=i}}},{constructor:function(e){e=e||{},this.modelBinders={},this.collectionBinder=null,this.bindingIndex=null,this.values={},this.formatters=[],this.parsers=[],t.View.call(this,e)},render:function(e){this.initBinding(),this.collectionBinder&&this.renderBoundViews(),t.BindingView._super.render.call(this,e),this.refreshOwnBinders()},destroy:function(e){this.destroyBinding(),t.BindingView._super.destroy.call(this,!0),this.destroyBoundViews(),e||this.trigger("destroy")},initBinding:function(){var e,i,n,s,r,o,a,h,l,c,u,d,f,g,p=this.$element.attr(t.View.DATA_BIND_ATTR),v=/([.a-zA-Z0-9]+):?([a-zA-Z0-9]+)?(\([^\(\))]*\))?:?([a-zA-Z0-9]+\([a-zA-Z0-9,\s]*\))?:?([a-zA-Z0-9]+\([a-zA-Z0-9,\s]*\))?:?([a-zA-Z0-9]+\([a-zA-Z0-9,\s]*\))?/g;for(this.modelBinders={};null!==(n=v.exec(p));){r=n[1],r=r.replace(/^\./,"*.").split("."),o=n[2],a=n[3],a=a?a.slice(1,-1).split(/\s*,\s*/):[],h=[],l=[],u=[],c=[],d=[];for(var m=4,w=n.length;w>m&&n[m];m++)if(s=n[m].match(/([a-zA-Z0-9]+)\(([^\(\)]*)\)/))switch(f=s[1],g=[],s[2]&&(g=s[2].split(/\s*,\s*/)),f){case"f":this.parseModifiers(g,h);break;case"p":this.parseModifiers(g,l);break;case"on":this.parseSetters(g,d);break;case"set":this.parseSetters(g,u);break;case"get":this.parseSetters(g,c)}if(e=this.getModel([].concat(r)),e instanceof t.Collection)this.options.isBoundView||(this.collectionBinder={collection:e},this.renderSubViews=function(){});else{if(!(o&&o in t.BindingView.binders))break;if(i=r.pop(),e=this.getModel(r),e instanceof t.Collection&&"count"===i&&(e=this.bindCollectionCount(e)),e instanceof t.Model){o in this.modelBinders||(this.modelBinders[o]=[],this.values[o]=[]);var V=this.modelBinders[o].length,b=new t.BindingView.binders[o]({view:this,$element:this.$element,valueIndex:V,values:this.values[o],params:a,attr:i,model:e,formatters:h,parsers:l,setters:u,getters:c,eventNames:d});this.modelBinders[o].push(b),this.values[o].push(null),b.init()}}}},bindCollectionCount:function(e){var i=new t.Model,n=function(){i.set("count",e.count)};return n(),this.boundCollectionCounts||(this.boundCollectionCounts=[]),this.boundCollectionCounts.push({collection:e,handler:n}),e.on("change",n),i},destroyCollectionCountBindings:function(){if(this.boundCollectionCounts)for(var e=0,t=this.boundCollectionCounts.length;t>e;e++)this.boundCollectionCounts[e].collection.off("change",this.boundCollectionCounts[e].handler)},parseModifiers:function(e,i){for(var n=0;e.length>n;n++)t.View.helpers[e[n]]&&i.push(t.View.helpers[e[n]])},parseSetters:function(e,t){for(var i=0;e.length>i;i++)t.push(e[i])},destroyBinding:function(){for(var e in this.modelBinders)for(var t=0,i=this.modelBinders[e],n=i.length;n>t;t++)i[t].destroy();this.modelBinders={},this.values={},this.destroyCollectionCountBindings()},renderBoundViews:function(){this.$anchor=$(document.createTextNode("")),this.$element.before(this.$anchor),this.$element.remove(),this.subViewsMap=[],this.subViewName=this.$element.attr(t.View.DATA_VIEW_ATTR);var e=this.$element.attr(t.View.DATA_OPTIONS_ATTR);this.initCollectionFilter(),this.subViewOptions=e?JSON.parse(e):{},this.subViewOptions.parentView=this,this.collectionBinder.collection.on("change",this.f("refreshBoundViews")),this.refreshBoundViews()},initCollectionFilter:function(){var e=this.$element.attr("data-kff-filter");e&&(this.collectionFilter={model:null,fn:null},e=e.replace(/^\./,"").split("."),1===e.length?this.collectionFilter.fn=e[0]:(this.collectionFilter.fn=e.pop(),this.collectionFilter.model=this.getModel([].concat(e))))},destroyBoundViews:function(){this.$elements&&this.$elements.remove(),this.$elements=null,this.$anchor&&(this.$anchor.after(this.$element),this.$anchor.remove()),this.destroySubviews()},refreshBoundViews:function(e){if(e&&"addedValue"in e&&(this.subViewsMap.push({renderIndex:null,rendered:!1}),e.addedValue.on("change",this.f("collectionItemChange")),this.collectionItemChange({model:e.addedValue})),e&&"removedValue"in e){e.removedValue.off("change",this.f("collectionItemChange"));for(var t=0,i=this.subViews.length;i>t&&e.removedValue!==this.subViews[t].models["*"];t++);for(var n=t,s=null,t=0,i=this.subViewsMap.length;i>t;t++)if(this.subViewsMap[t].renderIndex===n){s=t;break}null!==s&&(this.subViewsMap[t].rendered&&this.removeSubViewAt(n),this.subViewsMap.splice(t,1)),this.reindexSubviews(n)}else this.destroySubviews(),this.$elements&&this.$elements.remove(),this.$elements=$([]),this.subViewsMap=[],this.collectionBinder.collection.each(this.f(function(e){this.subViewsMap.push({renderIndex:null,rendered:!1}),e.on("change",this.f("collectionItemChange")),this.collectionItemChange({model:e})})),this.reindexSubviews()},collectionItemChange:function(e){var t=e.model,i=this.collectionBinder.collection.indexOf(t);if(this.collectionFilter){var n=t;this.collectionFilter.model&&(n=this.collectionFilter.model);var s=0,r=!!n[this.collectionFilter.fn].call(n,t);if(!this.subViewsMap[i].rendered||r!==this.subViewsMap[i].rendered)if(r){for(s=i;s>0&&!this.subViewsMap[s].rendered;s--);this.addSubViewAt(i,this.subViewsMap[s].renderIndex+1)}else this.subViewsMap[i].rendered&&(this.subViewsMap[i].rendered=!1,this.removeSubViewAt(this.subViewsMap[i].renderIndex))}else this.subViewsMap[i].rendered||this.addSubViewAt(i,i)},removeSubViewAt:function(e){this.subViews[e].destroy(),this.subViews.splice(e,1),this.$elements.eq(e).remove(),this.$elements=this.$elements.slice(0,e).add(this.$elements.slice(e+1)),this.reindexSubviews(e)},addSubViewAt:function(e,t){var i=this.collectionBinder.collection.findByIndex(e),n=this.createSubView(i,t);0===this.$elements.length?(this.$elements=this.$elements.add(n),this.$anchor.after(n)):(this.$elements.eq(t-1).after(n),this.$elements=this.$elements.slice(0,t).add(n).add(this.$elements.slice(t))),this.subViewsMap[e].renderIndex=t,this.subViewsMap[e].rendered=!0,this.reindexSubviews(t)},reindexSubviews:function(e,t){e||(e=0),(!t||t>this.subViews.length)&&(t=this.subViews.length);for(var i=e;t>i;i++)this.subViews[i].setBindingIndex(i),this.subViews[i].refreshBinders();for(var i=0,n=this.subViewsMap.length,s=0;n>i;i++)this.subViewsMap[i].rendered?(this.subViewsMap[i].renderIndex=s,s++):this.subViewsMap[i].renderIndex=null},createSubView:function(e,i){var n=this.$element.clone();this.subViewOptions.element=n,this.subViewOptions.models={"*":e},this.subViewOptions.isBoundView=!0;var s=this.viewFactory.createView(this.subViewName,this.subViewOptions);return s instanceof t.View&&(s.viewFactory=this.viewFactory,this.subViews.push(s),s.setBindingIndex(i),s.init(),n.attr(t.View.DATA_RENDERED_ATTR,!0),s.refresh()),n},getModel:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=parseInt(e[0],10),this.collectionBinder&&!isNaN(i)?this.collectionBinder.collection.findByIndex(i):t.BindingView._super.getModel.call(this,e)},refreshOwnBinders:function(){for(var e in this.modelBinders)for(var t=0,i=this.modelBinders[e],n=i.length;n>t;t++)i[t].modelChange(!0);this.collectionBinder&&this.refreshBoundViews()},refreshBinders:function(){this.refreshOwnBinders(),t.BindingView._super.refreshBinders.call(this)},getBindingIndex:function(){return null!==this.bindingIndex?this.bindingIndex:this.parentView instanceof t.BindingView?this.parentView.getBindingIndex():null},setBindingIndex:function(e){this.bindingIndex=e},concat:function(e){return 1===e.length?e[0]:e.join(" ")}}),t.Binder=t.createClass({constructor:function(e){this.options=e,this.options.events=this.options.events||[],this.view=e.view,this.$element=e.$element,this.attr=e.attr,this.model=e.model,this.parsers=e.parsers,this.formatters=e.formatters,this.setter=e.setters instanceof Array&&e.setters.length>0?e.setters[0]:null,this.getter=e.getters instanceof Array&&e.getters.length>0?e.getters[0]:null,this.values=e.values,this.valueIndex=e.valueIndex,this.params=e.params,this.currentValue=null,this.bindingIndex=null},init:function(){this.model.on("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.delegateEvents.call(this,this.options.events)},destroy:function(){this.model.off("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.undelegateEvents.call(this,this.options.events),this.currentValue=null,this.values[this.valueIndex]=null},delegateEvents:t.View.prototype.delegateEvents,undelegateEvents:t.View.prototype.undelegateEvents,modelChange:function(e){var t;t=this.getter&&"function"==typeof this.model[this.getter]?this.model[this.getter](this.attr):e!==!0?e.changedAttributes[this.attr]:this.model.get(this.attr),e!==!0&&this.compareValues(t,this.currentValue)||(this.values[this.valueIndex]=this.format(t),this.currentValue=t,this.refresh())},compareValues:function(e,t){if(e instanceof Array&&t instanceof Array){var i=e.length;if(i!==t.length)return!1;for(var n=0;i>n;n++)if(e[n]!==t[n])return!1;return!0}return e===t},getFormattedValue:function(){return this.values.length>1?this.values.join(" "):this.values[this.valueIndex]},updateModel:function(e){var t,i;if(e instanceof Array)for(t=0,i=e.length;i>t;t++)e[t]=this.parse(e[t]);else e=this.parse(e);this.compareValues(e,this.currentValue)||(this.currentValue=e,this.setter&&"function"==typeof this.model[this.setter]?this.model[this.setter](this.currentValue):this.model.set(this.attr,this.currentValue))},refresh:function(){},format:function(e){for(var t=0,i=this.formatters.length;i>t;t++)e=this.formatters[t].call(this,e);return e},parse:function(e){for(var t=0,i=this.parsers.length;i>t;t++)e=this.parsers[t].call(this,e);return e},getBindingIndex:function(){return this.view.getBindingIndex()}}),t.AttrBinder=t.createClass({extend:t.Binder},{init:function(){this.attribute=this.params[0]||null,this.prefix=this.params[1]||null,t.AttrBinder._super.init.call(this)},refresh:function(){this.attribute&&this.$element.attr(this.attribute,this.prefix+this.getFormattedValue())}}),t.BindingView.registerBinder("attr",t.AttrBinder),t.BlurBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"blur";e=e||{},e.events=[[i,"blur"]],t.Binder.call(this,e)},init:function(){this.value=this.params[0]||null,t.BlurBinder._super.init.call(this)},blur:function(){setTimeout(this.f(function(){this.updateModel(this.value)}),0)}}),t.BindingView.registerBinder("blur",t.BlurBinder),t.CheckBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click change";e=e||{},e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){setTimeout(this.f(function(){this.updateModel(this.$element.is(":checked"))}),0)},refresh:function(){this.$element.prop("checked",!!this.values[this.valueIndex])}}),t.BindingView.registerBinder("check",t.CheckBinder),t.ClassBinder=t.createClass({extend:t.Binder},{init:function(){this.className=this.params[0]||null,this.equalsTo=this.params[1]||null,t.ClassBinder._super.init.call(this)},refresh:function(){this.className&&this.$element[this.matchValue()?"addClass":"removeClass"](this.className)},matchValue:function(){return this.equalsTo?this.values[this.valueIndex]===this.parse(this.equalsTo):this.values[this.valueIndex]}}),t.BindingView.registerBinder("class",t.ClassBinder),t.ClickBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click";e=e||{},e.events=[[i,"click"]],t.Binder.call(this,e)},init:function(){this.value=this.params[0]||null,t.ClickBinder._super.init.call(this)},click:function(e){setTimeout(this.f(function(){this.updateModel(this.value)}),0),e.preventDefault()},updateModel:function(e){var t,i;if(e instanceof Array)for(t=0,i=e.length;i>t;t++)e[t]=this.parse(e[t]);else e=this.parse(e);this.currentValue=e,this.setter&&"function"==typeof this.model[this.setter]?this.model[this.setter](this.currentValue):this.model.set(this.attr,this.currentValue)}}),t.BindingView.registerBinder("click",t.ClickBinder),t.DoubleClickBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"dblclick";e=e||{},e.events=[[i,"dblclick"]],t.Binder.call(this,e)},init:function(){this.value=this.params[0]||null,t.DoubleClickBinder._super.init.call(this)},dblclick:function(){setTimeout(this.f(function(){this.updateModel(this.value)}),0)}}),t.BindingView.registerBinder("dblclick",t.DoubleClickBinder),t.EventBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click";e=e||{},e.events=[[i,"click"]],t.Binder.call(this,e)},init:function(){this.value=this.params[0]||null,t.EventBinder._super.init.call(this)},click:function(e){setTimeout(this.f(function(){this.updateModel(this.value)}),0),e.preventDefault()},updateModel:function(e){var t,i;if(e instanceof Array)for(t=0,i=e.length;i>t;t++)e[t]=this.parse(e[t]);else e=this.parse(e);this.currentValue=e,this.setter&&"function"==typeof this.model[this.setter]?this.model[this.setter](this.currentValue):this.model.set(this.attr,this.currentValue)}}),t.BindingView.registerBinder("event",t.EventBinder),t.HtmlBinder=t.createClass({extend:t.Binder},{refresh:function(){this.$element.html(this.values.join(" "))}}),t.BindingView.registerBinder("html",t.HtmlBinder),t.RadioBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click";e=e||{},e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){setTimeout(this.f(function(){this.$element.is(":checked")&&this.updateModel(this.$element.val())}),0)},refresh:function(){this.$element.prop("checked",this.parse(this.$element.val())===this.currentValue)}}),t.BindingView.registerBinder("radio",t.RadioBinder),t.TextBinder=t.createClass({extend:t.Binder},{constructor:function(e){e=e||{},t.Binder.call(this,e)},init:function(){t.TextBinder._super.init.call(this)},refresh:function(){this.$element.text(this.values.join(" "))}}),t.BindingView.registerBinder("text",t.TextBinder),t.ValueBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"keydown drop change";e=e||{},e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){setTimeout(this.f(function(){this.updateModel(this.$element.val())}),0)},refresh:function(){this.$element.val(this.getFormattedValue())}}),t.BindingView.registerBinder("val",t.ValueBinder),t.ViewFactory=t.createClass({constructor:function(e){e=e||{},this.serviceContainer=e.serviceContainer||null,this.precedingViews=e.precedingViews||{}},createView:function(e,i){var n,s=null;return i=i||{},"function"!=typeof e&&this.serviceContainer&&this.serviceContainer.hasService(e)?s=this.serviceContainer.getService(e):(n="function"!=typeof e?t.evalObjectPath(e):e,n&&(s=new n({viewFactory:this}))),s instanceof t.View&&s.setOptions(i),s},getServiceConstructor:function(e){return"function"==typeof e?e:this.serviceContainer&&this.serviceContainer.hasService(e)?this.serviceContainer.getServiceConstructor(e):t.evalObjectPath(e)},getPrecedingView:function(e){var t;return"string"==typeof e&&void 0!==this.precedingViews[e]?this.precedingViews[e]:(t=this.getServiceConstructor(e),t&&t.precedingView?t.precedingView:null)}}),t.Route=t.createClass({constructor:function(e,t){this.pattern=e,this.target=t,this.keys=null,this.regexp=this.compileRegex()},getTarget:function(){return this.target},match:function(e,t){var i=this.keys,n=e.indexOf("?"),s=~n?e.slice(0,n):e,r=this.regexp.exec(s);if(!r)return!1;for(var o=1,a=r.length;a>o;++o){var h=i[o-1],l="string"==typeof r[o]?decodeURIComponent(r[o]):r[o];h?t[h.name]=void 0!==t[h.name]?t[h.name]:l:t.push(l)}return!0},compileRegex:function(e,t){var i,n=this.keys=[];return i=this.pattern.concat(t?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(e,t,i,s,r,o){return n.push({name:s,optional:!!o}),t=t||"",""+(o?"":t)+"(?:"+(o?t:"")+(i||"")+(r||i&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+i+"$",e?"":"i")}}),t.Router=t.createClass({constructor:function(e){this.options=e||{},this.routes=[],this.buildRoutes()},buildRoutes:function(){this.routes=[];var e=this.options.routes;for(var i in e)this.routes.push(new t.Route(i,e[i]))},match:function(e){for(var t,i=0,n=this.routes.length;n>i;i++)if(t=[],this.routes[i].match(e,t))return{target:this.routes[i].getTarget(),params:t};return null}}),t.FrontController=t.createClass({constructor:function(e){e=e||{},this.options=e,this.views=null,this.viewsQueue=[],this.viewFactory=e.viewFactory||new t.ViewFactory,this.router=e.router||null},init:function(){this.router&&$(window).bind("hashchange",this.f("hashChange")).trigger("hashchange")},createViewFromState:function(e){if(this.router){var t,i=e.path;return""===i&&(i="#"),t=this.router.match(i),t?(e.params=t.params,t.target):this.options.defaultView}return null},hashChange:function(){var e=location.hash;return 0!==e.indexOf("#")&&""!=e?!1:(this.setState({path:e,params:{}}),!1)},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(e){var i=this.getLastView();this.viewsQueue.push(e),i&&(i.instance.on("init",t.bindFn(e.instance,"init")),i.instance.on("setState",t.bindFn(e.instance,"setState")))},popView:function(){if(0!==this.viewsQueue.length){var e=this.viewsQueue.pop(),i=this.getLastView();return e.instance.off("init",t.bindFn(this,"cascadeState")),i&&(i.instance.off("init",t.bindFn(e.instance,"init")),i.instance.off("setState",t.bindFn(e.instance,"setState"))),e}},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].instance.setState(this.state)},setState:function(e){var i,n,s,r=[];for(this.state=e,this.newViewName=this.createViewFromState(e),i=this.getLastView()?this.getLastView().name:null,n=this.findSharedView(this.newViewName,i);null!==(i=this.getLastView()?this.getLastView().name:null)&&i!==n;)r.push(this.popView());for(s=0;r.length>s;s++)r[s+1]?r[s].instance.on("destroy",t.bindFn(r[s+1].instance,"destroy")):r[s].instance.on("destroy",t.bindFn(this,"startInit"));r[0]?r[0].instance.destroy():this.startInit()},startInit:function(){var e,i,n=this.getPrecedingViews(this.newViewName),s=0;for(e=0,i=n.length;i>e;e++)e>=this.viewsQueue.length?this.pushView({name:n[e],instance:this.viewFactory.createView(n[e],{viewFactory:this.viewFactory})}):s=e+1;this.newViewName=null,this.getLastView()&&this.getLastView().instance.on("init",t.bindFn(this,"cascadeState")),this.viewsQueue[s]?this.viewsQueue[s].instance.init():this.cascadeState()},findSharedView:function(e,t){var i,n=this.getPrecedingViews(e),s=this.getPrecedingViews(t),r=null;for(i=0,l=n.length<s.length?n.length:s.length;l>i&&n[i]===s[i];i++)r=n[i];return r},getPrecedingViews:function(e){for(var t=e,i=[t];t;)t=this.viewFactory.getPrecedingView(t),t&&i.unshift(t);return i}})})(this);