(function(e){var t;t="undefined"!=typeof exports?exports:"kff"in e?e.kff:e.kff={},t.widgets={},t.extend=function(e,t){var i;Object.create?e.prototype=Object.create(t.prototype):(i=function(){},i.prototype=t.prototype,e.prototype=new i),e._super=t.prototype,e.prototype.constructor=e},t.mixins=function(e){var i,n,s,r,o=1,a=arguments.length,h=!1;for(a>2&&arguments[a-1]===!0&&(h=!0,a--);a>o;){n=arguments[o];for(i in n)n.hasOwnProperty(i)&&(s=n[i],h&&t.isPlainObject(s)?(r=e[i],("object"!=typeof r||null===r)&&(r={}),t.mixins(r,s,h)):e[i]=s);o++}return e},t.createClass=function(e,i){var n;0===arguments.length?e=i={}:1===arguments.length&&(i=e,e={}),n=i.hasOwnProperty("constructor")?i.constructor:e.extend?function(){e.extend.apply(this,arguments)}:function(){},e.extend&&t.extend(n,e.extend),"mixins"in e?e.mixins instanceof Array||(e.mixins=[e.mixins]):e.mixins=[],e.mixins.push(t.classMixin);for(var s=0,r=e.mixins.length;r>s;s++)t.mixins(i,e.mixins[s]);return e.staticProperties&&t.mixins(n,e.staticProperties),e.statics&&t.mixins(n,e.statics),t.mixins(n.prototype,i),n.prototype.constructor=n,n},t.bindFn=function(e,t,i){if("function"!=typeof e[t])throw new TypeError("Expected function: "+t+" (kff.bindFn)");return"_boundFns"in e||(e._boundFns={}),t in e._boundFns?e._boundFns[t]:(e._boundFns[t]=function(){return i?e[t].apply(e,i.concat(Array.prototype.slice.call(arguments))):e[t].apply(e,arguments)},e._boundFns[t])},t.classMixin={f:function(e,i){var n=this;if("string"==typeof e)return t.bindFn(n,e,i);if("function"==typeof e)return function(){return i?e.apply(n,i.concat(Array.prototype.slice.call(arguments))):e.apply(n,arguments)};throw new TypeError("Expected function: "+e+" (kff.f)")}},function(){var i,n,s,r;t.evalObjectPath=function(t,o){if(o=o||e,"string"!=typeof t)return null;for(i=t.split("."),s=0,r=i.length;r>s;s++){if(n=i[s],!(n in o))return null;o=o[n]}return o}}(),t.isPlainObject=function(e){return null!==e&&"object"==typeof e&&e.constructor===Object},t.setZeroTimeout=function(e){var i=[],n="kff-zerotimeoutmsg",s=function(e){e.source===window&&e.data===n&&(e.stopPropagation(),i.length>0&&i.shift()())};"postMessage"in window&&"addEventListener"in window&&!("attachEvent"in window)?(t.setZeroTimeout=function(e){i.push(e),window.postMessage(n,"*")},window.addEventListener("message",s,!0)):t.setZeroTimeout=function(e){setTimeout(e,0)},t.setZeroTimeout(e)},t.Events=t.createClass({constructor:function(){this.subscribers={},this.oneSubscribers={}},on:function(e,i){if(this.off(e,i),e instanceof Array)for(var n=0,s=e.length;s>n;n++)e[n]&&(this.subscribers[e[n]]||(this.subscribers[e[n]]=new t.List),this.subscribers[e[n]].append(i));else this.subscribers[e]||(this.subscribers[e]=new t.List),this.subscribers[e].append(i)},one:function(e,t){e in this.oneSubscribers||(this.oneSubscribers[e]=[]),this.oneSubscribers[e].push(t),this.on(e,t)},off:function(e,i){var n,s;if(e instanceof Array)for(n=0,s=e.length;s>n;n++)e[n]&&this.off(e[n],i);else this.subscribers[e]instanceof t.List&&this.subscribers[e].remove(i)},trigger:function(e,i){var n,s;if(e instanceof Array)for(n=0,s=e.length;s>n;n++)e[n]&&this.trigger(e[n],i);else if(this.subscribers[e]instanceof t.List&&(this.subscribers[e].each(function(e){"function"==typeof e&&e.call(null,i)}),e in this.oneSubscribers)){for(n=0,s=this.oneSubscribers[e].length;s>n;n++)this.off(e,this.oneSubscribers[e][n]);this.oneSubscribers[e]=[]}}}),t.EventsMixin={initEvents:function(){this.events=new t.Events},on:function(e,t){return this.events.on(e,t)},one:function(e,t){return this.events.one(e,t)},off:function(e,t){return this.events.off(e,t)},trigger:function(e,t){return this.events.trigger(e,t)}},t.List=t.createClass({constructor:function(){this.array=[]},count:function(){return this.array.length},each:function(e){for(var t=this.array,i=t.length,n=0;i>n&&e.call(null,t[n],n)!==!1;n++);},append:function(e){this.array.push(e)},insert:function(e,t){this.array.splice(t,0,e)},remove:function(e){var t=this.indexOf(e);return-1===t?!1:(this.array.splice(t,1),!0)},empty:function(){this.array=[]},splice:function(){Array.prototype.splice.apply(this.array,arguments)},indexOf:function(e){return t.List.prototype.indexOf=Array.prototype.indexOf?function(e){return this.array.indexOf(e)}:function(e){for(var t=0,i=this.array,n=i.length;n>t;t++)if(i[t]===e)return t;return-1},this.indexOf(e)},set:function(e,t){if(void 0===this.array[e])throw new RangeError("Bad index in kff.List.set");this.array[e]=t},get:function(e){return this.array[e]},sort:function(e){this.array.sort(e)},shuffle:function(){for(var e,t,i=this.array,n=i.length,s=n;s--;)e=parseInt(Math.random()*n,10),t=i[s],i[s]=i[e],i[e]=t}}),t.List.prototype.findByIndex=t.List.prototype.get,t.Collection=t.createClass({extend:t.List,mixins:t.EventsMixin},{constructor:function(e){return e=e||{},this.itemFactory=e.itemFactory||null,this.itemType=e.itemType||t.Model,this.serializeAttrs=e.serializeAttrs||null,this.onEachEvents=[],this.initEvents(),t.List.call(this),this},append:function(e,i){t.Collection._super.append.call(this,e),i||this.trigger("change",{type:"append",item:e})},insert:function(e,i,n){t.Collection._super.insert.call(this,e,i),n||this.trigger("change",{type:"insert",item:e,index:i})},set:function(e,i,n){t.Collection._super.set.call(this,i,e),n||this.trigger("change",{type:"set",item:i,index:e})},remove:function(e,i){var n=t.Collection._super.remove.call(this,e);return n&&!i&&this.trigger("change",{type:"remove",item:e}),n},mget:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=this.get(e.shift()),e.length>0?i instanceof t.Model||i instanceof t.Collection?i.mget(e):t.evalObjectPath(e,i):i},toJson:function(){var e=this.serializeAttrs,t=[];return this.each(function(i){i&&i.toJson?t.push(i.toJson(e)):t.push(i)}),t},fromJson:function(e,t){var i,n=this.itemFactory;this.empty();for(var s=0;e.length>s;s++)i=n?n(e[s]):new this.itemType,i.fromJson(e[s],t),this.append(i,!0);t||this.trigger("change",{type:"fromJson"})},findByAttr:function(e,t){var i=null;return this.each(function(n){return n&&n.get(e)===t?(i=n,!1):void 0}),i},empty:function(e){t.Collection._super.empty.call(this),e||this.trigger("change",{type:"empty"})},sort:function(e,i){t.Collection._super.sort.call(this,e),i||this.trigger("change",{type:"sort"})},clone:function(){var e=new t.Collection(this.options);return this.each(function(t){e.append(t)}),e},shuffle:function(e){t.Collection._super.shuffle.call(this),e||this.trigger("change",{type:"shuffle"})},splice:function(){t.Collection._super.splice.apply(this,arguments),this.trigger("change",{type:"splice"})},onEach:function(e,t){this.onEachEvents.push({eventType:e,fn:t}),this.each(function(i){i.on(e,t)}),this.on("change",this.f("refreshOnEach"))},offEach:function(e,t){for(var i=0,n=this.onEachEvents.length;n>i;i++)this.onEachEvents[i].eventType===e&&this.onEachEvents[i].fn===t&&(this.onEachEvents.splice(i,1),n--);this.each(function(i){i.off(e,t)}),0===this.onEachEvents.length&&this.off("change",this.f("refreshOnEach"))},refreshOnEach:function(e){switch(e?e.type:null){case"append":case"insert":this.bindOnOne(e.item);break;case"remove":this.unbindOnOne(e.item);break;default:this.rebindEach()}},bindOnOne:function(e){for(var t=0,i=this.onEachEvents.length;i>t;t++)e.on(this.onEachEvents[t].eventType,this.onEachEvents[t].fn)},unbindOnOne:function(e){for(var t=0,i=this.onEachEvents.length;i>t;t++)e.off(this.onEachEvents[t].eventType,this.onEachEvents[t].fn)},rebindEach:function(){var e=this;this.each(function(t){for(var i=0,n=e.onEachEvents.length;n>i;i++)t.on(e.onEachEvents[i].eventType,e.onEachEvents[i].fn)})}}),t.Model=t.createClass({mixins:t.EventsMixin},{constructor:function(e){this.initEvents(),this.attrs=this.attrs||{},e&&this.set(e)},has:function(e){return e in this.attrs},get:function(e){return this.attrs[e]},mget:function(e){var i;return"string"==typeof e&&(e=e.split(".")),i=this.get(e.shift()),e.length>0?i instanceof t.Model||i instanceof t.Collection?i.mget(e):t.evalObjectPath(e,i):i},set:function(e,t,i){var n={};if("string"==typeof e){if(this.get(e)===t)return;n[e]=t,this.attrs[e]=t}else if(null!==e&&e instanceof Object){i=t,n=e;for(var s in n)this.attrs[s]=n[s]}if(!i){for(var r in n)this.trigger("change:"+r,{model:this,changed:n,changedAttributes:n});this.trigger("change",{model:this,changed:n,changedAttributes:n})}},toJson:function(e){var t={};for(var i in this.attrs)e&&-1===$.inArray(i,e)||!this.attrs.hasOwnProperty(i)||(t[i]=this.attrs[i]&&"object"==typeof this.attrs[i]&&"toJson"in this.attrs[i]?this.attrs[i].toJson():this.attrs[i]);return t},fromJson:function(e,t){if(e){for(var i in this.attrs)this.attrs.hasOwnProperty(i)&&e.hasOwnProperty(i)&&(this.attrs[i]&&"object"==typeof this.attrs[i]&&"fromJson"in this.attrs[i]?this.attrs[i].fromJson(e[i]):this.attrs[i]=e[i]);this.set(this.attrs,t)}},createComputed:function(e,t,i){var n,s,r;for(this._computed||(this._computed=[]),n={args:[e,t,i],boundFn:this.f(function(){var n=[];for(s=0,r=t.length;r>s;s++)n[s]=this.get(t[s]);this.set(e,this.f(i).apply(this,n))})},this._computed.push(n),s=0,r=t.length;r>s;s++)this.on("change:"+t[s],n.boundFn);n.boundFn()},each:function(e){var t,i=this.attrs;for(t in i)e(t,i[t])}}),t.ServiceContainer=t.createClass({statics:{CONFIG_CONSTRUCTOR:"construct",singleParamRegex:/^%[^%]+%$/g,multipleParamsRegex:/%([^%]+)%/g}},{constructor:function(e){this.config=e||{parameters:{},services:{}},this.services={},this.cachedParams={}},getService:function(e,t){var i;if(!this.config.services[e]){if(i=this.getServiceConfigAnnotation(e),!i)throw Error("Service "+e+" not defined");this.config.services[e]=i}return this.config.services[e].shared?(this.services[e]===void 0&&(this.services[e]=this.createService(e,t)),this.services[e]):this.createService(e,t)},hasService:function(e){if(this.config.services.hasOwnProperty(e))return!0;var t=this.getServiceConfigAnnotation(e);return t?(this.config.services[e]=t,!0):!1},createService:function(e,i){var n,s,r,o,a,h,l,c,u,d;if(n=this.config.services[e],s=this.getServiceConstructor(e),r=function(){},r.prototype=s.prototype,o=new r,c=this.resolveParameters(n.args||[]),i&&i instanceof Array){for(u=[],h=0,l=i.length;l>h;h++)u[h]=void 0!==i[h]?t.isPlainObject(c[h])&&t.isPlainObject(i[h])?t.mixins({},c[h],i[h]):i[h]:c[h];c=u}if(a=s.apply(o,c),Object(a)===a&&(o=a),d=n.calls,d instanceof Array)for(h=0,l=d.length;l>h;h++)o[d[h].method].apply(o,this.resolveParameters(d[h].args));return o},getServiceConstructor:function(e){var i,n,s=t.ServiceContainer.CONFIG_CONSTRUCTOR;if(i=this.config.services[e],!i){if(i=this.getServiceConfigAnnotation(e),!i)return null;this.config.services[e]=i}if(i.hasOwnProperty("construct")?"string"==typeof i[s]&&(i[s]=t.evalObjectPath(i[s])):(n=t.evalObjectPath(e),"function"==typeof n&&(i[s]=n)),"function"!=typeof i[s])throw Error('Cannot create service "'+e+'" in kff.getServiceConstructor. Expected constructor function, got: '+i[s]);return i[s]},getServiceConfigAnnotation:function(e){var i={},n=t.evalObjectPath(e);return"function"==typeof n?("service"in n&&t.isPlainObject(n.service)&&(i=n.service),"construct"in i||(i.construct=n),i):null},resolveParameters:function(e){var i,n,s,r;if(r=this.config,"string"==typeof e)"@"===e.charAt(0)?(e=e.slice(1),i=0===e.length?this:this.getService(e)):void 0!==this.cachedParams[e]?i=this.cachedParams[e]:(-1!==e.search(t.ServiceContainer.singleParamRegex)?i=r.parameters[e.slice(1,-1)]:(i=e.replace("%%","escpersign"),i=i.replace(t.ServiceContainer.multipleParamsRegex,function(e,t){return r.parameters[t]?r.parameters[t]:""}),i=i.replace("escpersign","%")),this.cachedParams[e]=i);else if(e instanceof Array)for(i=[],n=0,s=e.length;s>n;n++)i[n]=this.resolveParameters(e[n]);else if(t.isPlainObject(e)){i={};for(n in e)e.hasOwnProperty(n)&&(i[n]=this.resolveParameters(e[n]))}else i=e;return i},registerServices:function(e,t){var i;for(i in e)(!this.config.services.hasOwnProperty(i)||t)&&(this.config.services[i]=e[i],this.services[i]=void 0)},registerParameters:function(e,t){var i;for(i in e)(!this.config.parameters.hasOwnProperty(i)||t)&&(this.config.parameters[i]=e[i])}}),t.View=t.createClass({mixins:t.EventsMixin,staticProperties:{DATA_VIEW_ATTR:"data-kff-view",DATA_OPTIONS_ATTR:"data-kff-options",DATA_RENDERED_ATTR:"data-kff-rendered",DATA_BIND_ATTR:"data-kff-bind",DATA_TRIGGER_ATTR:"data-kff-trigger"}},{constructor:function(e){var i;return e=e||{},this.options={element:null,models:null,events:[],modelEvents:[]},this.initEvents(),e.parentView?(this.parentView=e.parentView,i=function(){},i.prototype=this.parentView.models,this.models=new i):this.models={},e.events&&(this.options.events=this.options.events.concat(e.events)),e.modelEvents&&(this.options.modelEvents=this.options.modelEvents.concat(e.modelEvents)),e.element&&(this.$element=$(e.element)),e.viewFactory&&(this.viewFactory=e.viewFactory),e.models&&t.mixins(this.models,e.models),t.mixins(this.options,e),this.viewFactory=e.viewFactory||new t.ViewFactory,this.subviewsStruct=[],this.explicitSubviewsStruct=null,this.subviews=[],this.renderId=null,this},getModel:function(e){var i;return e="string"==typeof e?e.split("."):[].concat(e),i=e.shift(),this.models&&i in this.models?e.length>0?this.models[i]instanceof t.Model?this.models[i].mget(e):null:this.models[i]:null},delegateEvents:function(e,t){var i,n,s,r;for(this.undelegateEvents(),e=e||this.options.events,t=t||this.$element,n=0,s=e.length;s>n;n++)i=e[n],3===i.length?(r="string"==typeof i[2]?this.f(i[2]):i[2],"string"==typeof i[1]?t.on(i[0],i[1],r):i[1].on(i[0],r)):2===i.length&&(r="string"==typeof i[1]?this.f(i[1]):i[1],t.on(i[0],r))},undelegateEvents:function(e,t){var i,n,s,r;for(e=e||this.options.events,t=t||this.$element,n=0,s=e.length;s>n;n++)i=e[n],3===i.length?(r="string"==typeof i[2]?this.f(i[2]):i[2],"string"==typeof i[1]?t.off(i[0],i[1],r):i[1].off(i[0],r)):2===i.length&&(r="string"==typeof i[1]?this.f(i[1]):i[1],t.off(i[0],r))},addEvents:function(e){this.options.events=this.options.events.concat(e)},delegateModelEvents:function(e){var t,i,n,s;for(this.undelegateModelEvents(),e=e||this.options.modelEvents,i=0,n=e.length;n>i;i++)t=e[i],3===t.length&&this.models[t[0]]&&(s="string"==typeof t[2]?this.f(t[2]):t[2],this.models[t[0]].on(t[1],s))},undelegateModelEvents:function(e){var t,i,n,s;for(e=e||this.options.modelEvents,i=0,n=e.length;n>i;i++)t=e[i],3===t.length&&this.models[t[0]]&&(s="string"==typeof t[2]?this.f(t[2]):t[2],this.models[t[0]].off(t[1],s))},init:function(){this.startRender(),this.startRun()},render:function(){},run:function(){},startRender:function(){this.renderId=Math.floor(1e8*Math.random()),this.explicitSubviewsStruct=[],this.render(),this.renderSubviews(),this.processTriggerEvents()},startRun:function(e){var i=this.run();this.runSubviews(),this.delegateEvents(),this.delegateModelEvents(),"function"==typeof this.afterRender&&this.afterRender(),this.$element.attr(t.View.DATA_RENDERED_ATTR,!0),e!==!0&&i!==!1&&this.trigger("render")},renderSubviews:function(){var e,i,n,s,r,o=this.$element.get(0);for(o&&this.findViewElements(o,this.subviewsStruct),r=this.subviewsStruct.concat(this.explicitSubviewsStruct),e=0,i=r.length;i>e;e++)s=r[e].options,s.element=r[e].$element,n=this.createView(r[e].viewName,s),n instanceof t.View&&n.startRender()},runSubviews:function(){for(var e=0,t=this.subviews.length;t>e;e++)this.subviews[e].startRun()},createView:function(e,i){i.parentView=this;var n=this.viewFactory.createView(e,i);return n instanceof t.View&&(n.viewFactory=this.viewFactory,this.subviews.push(n)),n},addSubview:function(e,t,i){this.explicitSubviewsStruct.push({viewName:t,$element:e,options:i||{}})},findViewElements:function(e,i,n){var s,r,o,a,h,l,c,u;if(e.hasChildNodes())for(o=e.childNodes,s=0,r=o.length;r>s;s++)a=o[s],1===a.nodeType&&(l=a.getAttribute(t.View.DATA_RENDERED_ATTR),(!l||n)&&(h=a.getAttribute(t.View.DATA_VIEW_ATTR),!h&&a.getAttribute(t.View.DATA_BIND_ATTR)&&(h="kff.BindingView",a.setAttribute(t.View.DATA_VIEW_ATTR,h)),h?(u=a.getAttribute(t.View.DATA_OPTIONS_ATTR),a.setAttribute("data-kff-renderid",this.renderId),i.push({viewName:h,renderId:this.renderId,$element:$(a),options:u?JSON.parse(u):{}})):(c=a.getAttribute(t.View.DATA_TRIGGER_ATTR),c&&this.processChildTriggerEvents(a,c),this.findViewElements(a,i,n))))},processTriggerEvents:function(){this.processChildTriggerEvents(this.$element.get(0))},processChildTriggerEvents:function(e,i){var n,s,r,o,a=[];if(i=i||e.getAttribute(t.View.DATA_TRIGGER_ATTR)){for(n=i.split(/\s+/),r=0,o=n.length;o>r;r++)s=n[r].split(":"),a.push([s[0].replace("|"," "),$(e),this.f(function(){this.callTriggerMethod.apply(this,arguments)},[s[1]])]);this.addEvents(a)}},callTriggerMethod:function(e){"function"==typeof this[e]?this[e].apply(this,Array.prototype.slice.call(arguments,1)):this.parentView&&this.parentView.callTriggerMethod.apply(this.parentView,arguments)},destroy:function(){},startDestroy:function(e){var i;this.$element.removeAttr(t.View.DATA_RENDERED_ATTR),this.undelegateEvents(),this.undelegateModelEvents(),this.destroySubviews(),i=this.destroy(),"function"==typeof this.afterDestroy&&this.afterDestroy(),e!==!0&&i!==!1&&this.trigger("destroy")},destroySubviews:function(){var e,t,i;for(t=0,i=this.subviews.length;i>t;t++)e=this.subviews[t],e.startDestroy();this.subviews=[]},refresh:function(){},refreshBinders:function(e){for(var t=0,i=this.subviews.length;i>t;t++)this.subviews[t].refreshBinders(e)},getBindingIndex:function(e){return this.parentView instanceof t.View?this.parentView.getBindingIndex(e):null},clone:function(){var e,i={parentView:this.parentView,viewFactory:this.viewFactory},n=new this.constructor(i);n.options.events=this.options.events;for(var s in this.models)this.models.hasOwnProperty(s)&&(n.models[s]=this.models[s]);for(var r=0;this.subviews.length>r;r++)e=this.subviews[r].clone(),e.setParentView(n),n.subviews.push(e);return n.subviewsStruct=t.mixins({},this.subviewsStruct),n.renderId=this.renderId,n},setParentView:function(e){var i=this.models||{};this.parentView=e,F=function(){},F.prototype=this.parentView.models,this.models=new F,t.mixins(this.models,i)},rebindElement:function(e){var t,i;this.$element=$(e);var n=this.$element.find('[data-kff-renderid="'+this.renderId+'"]');if(n.length>0)for(t=0,i=this.subviews.length;i>t;t++)this.subviews[t]&&this.subviews[t].rebindElement(n.eq(t).get(0))}}),t.PageView=t.createClass({extend:t.View,staticProperties:{precedingView:null}},{constructor:function(e){return e=e||{},e.element=$("body"),t.View.call(this,e)},delegateEvents:function(e,i){t.PageView._super.delegateEvents.call(this,e,i||$(document))},undelegateEvents:function(e,i){t.PageView._super.undelegateEvents.call(this,e,i||$(document))},setState:function(e,t){t||this.trigger("setState",e)},init:function(){this.startRender(),this.startRun()}}),t.BinderMap=t.createClass({constructor:function(){this.binders=[]},add:function(e){this.binders.push(e)},clone:function(){var e,i,n=new t.BinderMap,s=n.binders;for(e=0,i=this.binders.length;i>e;e++)s[e]=this.binders[e].clone();return n},setView:function(e){var t,i;for(t=0,i=this.binders.length;i>t;t++)this.binders[t].view=e,this.binders[t].$element=e.$element,this.binders[t].model=e.getModel([].concat(this.binders[t].modelPathArray)),this.binders[t].value=null},initBinders:function(){for(var e=0,t=this.binders.length;t>e;e++)this.binders[e].init()},destroyBinders:function(){for(var e=0,t=this.binders.length;t>e;e++)this.binders[e].destroy()},refreshBinders:function(){for(var e=0,t=this.binders.length;t>e;e++)this.binders[e].modelChange(!0)}}),t.BindingView=t.createClass({extend:t.View,staticProperties:{bindingRegex:/(?:([.a-zA-Z0-9*-]+))((?::[a-zA-Z0-9]+(?:\((?:[^()]*)\))?)*)/g,operatorsRegex:/:([a-zA-Z0-9]+)(?:\(([^()]*)\))?/g,commaSeparateRegex:/\s*,\s*/,modifierSeparateRegex:/([^{},\s]+)|({[a-zA-Z0-9,\[\]_\-\.\s*]+})/g,leadingPeriodRegex:/^\./,trailingPeriodRegex:/\.$/,binders:{},helpers:{},registerBinder:function(e,i){t.BindingView.binders[e]=i},registerHelper:function(e,i){t.BindingView.helpers[e]=i}}},{constructor:function(e){e=e||{},this.modelBindersMap=null,this.collectionBinder=null,this.bindingIndex=null,this.itemAlias=null,this.boundViews=[],t.View.call(this,e)},startRender:function(e){null===this.modelBindersMap&&this.initBinding(),this.collectionBinder||t.BindingView._super.startRender.call(this,e)},startRun:function(){this.collectionBinder?this.runSubviews():(null!==this.modelBindersMap&&this.modelBindersMap.initBinders(),t.BindingView._super.startRun.call(this)),t.setZeroTimeout(this.f("refreshOwnBinders"))},startDestroy:function(){this.destroyBinding(),this.destroyBoundViews(),t.BindingView._super.startDestroy.call(this,!0)},initBinding:function(){var e,i,n,s,r,o,a,h,l,c,u,d,f,g,p,v,m,w,b=this.$element.attr(t.View.DATA_BIND_ATTR),V=t.BindingView.bindingRegex,y=t.BindingView.operatorsRegex,B=t.BindingView.modifierSeparateRegex,C=t.BindingView.commaSeparateRegex,E=t.BindingView.leadingPeriodRegex,x=t.BindingView.trailingPeriodRegex;for(V.lastIndex=0,y.lastIndex=0,this.modelBindersMap=new t.BinderMap;null!==(n=V.exec(b));){for(r=n[1].replace(E,"*.").replace(x,".*").split("."),h=[],l=[],u=[],c=[],d=[],f=!1,p=!1,g=0;null!==(s=y.exec(n[2]));){if(0===g)o=s[1],a=s[2],a=a?a.split(C):[];else switch(v=s[1],m=[],s[2]&&(m=s[2].match(B)),v){case"f":this.parseHelpers(m,h);break;case"p":this.parseHelpers(m,l);break;case"on":this.parseSetters(m,d);break;case"as":this.parseSetters(m,itemAliases);break;case"set":this.parseSetters(m,u);break;case"get":this.parseSetters(m,c);break;case"fill":f=!0;break;case"watch":p=!0}g++}if(e=this.getModel(r),e instanceof t.Collection)this.options.isBoundView||(this.collectionBinder={collection:e,collectionPathArray:r},"as"===o&&a.length>0&&(this.itemAlias=a[0]));else{if(!(o&&o in t.BindingView.binders))break;i=r.length>1?r.pop():null,"*"===i&&(i=null),w=r.length>0?r[0]:null,e=this.getModel(r),e instanceof t.Collection&&"count"===i&&(e=this.bindCollectionCount(e));var A=new t.BindingView.binders[o]({view:this,$element:this.$element,params:a,attr:i,model:e,modelName:w,modelPathArray:r,formatters:h,parsers:l,setters:u,getters:c,eventNames:d,fill:f,watch:p});this.modelBindersMap.add(A)}}},bindCollectionCount:function(e){var i=new t.Model,n=function(){i.set("count",e.count())};return n(),this.boundCollectionCounts||(this.boundCollectionCounts=[]),this.boundCollectionCounts.push({collection:e,handler:n}),e.on("change",n),i},destroyCollectionCountBindings:function(){if(this.boundCollectionCounts)for(var e=0,t=this.boundCollectionCounts.length;t>e;e++)this.boundCollectionCounts[e].collection.off("change",this.boundCollectionCounts[e].handler)},parseHelpers:function(e,i){for(var n,s,r=0,o=e.length;o>r;r++)n=e[r],o>r+1&&0===e[r+1].indexOf("{")?(s=e[r+1].match(/([^,{}]+)/g),r++):s=[],t.BindingView.helpers[n]&&i.push({fn:t.BindingView.helpers[n],args:s})},parseSetters:function(e,t){for(var i=0;e.length>i;i++)t.push(e[i])},destroyBinding:function(){this.modelBindersMap.destroyBinders(),this.modelBindersMap=null,this.destroyCollectionCountBindings()},renderBoundViews:function(){this.$anchor=$(document.createTextNode("")),this.$element.before(this.$anchor),this.$element.remove(),this.boundViewsMap=[],this.boundViewName=this.$element.attr(t.View.DATA_VIEW_ATTR);var e=this.$element.attr(t.View.DATA_OPTIONS_ATTR);this.initCollectionFilter(),this.boundViewOptions=e?JSON.parse(e):{},this.boundViewOptions.parentView=this,this.boundViewOptions.viewFactory=this.viewFactory,this.boundViewOptions.isBoundView=!0,this.collectionBinder.collection.on("change",this.f("refreshBoundViews")),this.collectionBinder.collection.onEach("change",this.f("collectionItemChange")),this.refreshBoundViewsAll()},destroyBoundViews:function(){var e,t,i;for(this.collectionBinder&&(this.collectionBinder.collection.off("change",this.f("refreshBoundViews")),this.collectionBinder.collection.offEach("change",this.f("collectionItemChange"))),t=0,i=this.boundViews.length;i>t;t++)e=this.boundViews[t],e.startDestroy();if(this.boundViews=[],this.elements)for(var t=0,i=this.elements.length;i>t;t++)this.elements[t].remove();this.elements=[],this.$anchor&&(this.$anchor.after(this.$element),this.$anchor.remove()),this.boundViews=[]},refreshBoundViews:function(e){switch(e?e.type:null){case"append":this.refreshBoundViewsOnAppend(e);break;case"insert":this.refreshBoundViewsOnInsert(e);break;case"remove":this.refreshBoundViewsOnRemove(e);break;default:this.refreshBoundViewsAll()}},refreshBoundViewsOnAppend:function(e){this.boundViewsMap.push(!1),this.collectionItemChange({model:e.item})},refreshBoundViewsOnInsert:function(e){this.boundViewsMap.splice(e.index,0,!1),this.collectionItemChange({model:e.item})},refreshBoundViewsOnRemove:function(e){for(var t=0,i=this.boundViews.length;i>t&&e.item!==this.boundViews[t].models["*"];t++);for(var n=t,s=null,t=0,i=this.boundViewsMap.length;i>t;t++)if(this.boundViewsMap[t]===n){s=t;break}null!==s&&(this.boundViewsMap[t]!==!1&&this.removeBoundViewAt(n),this.boundViewsMap.splice(t,1)),this.reindexBoundviews(t)},refreshBoundViewsAll:function(){var e,i,n,s,r,o=0,a=this;if(a.elements)for(var h=0,l=a.elements.length;l>h;h++)a.elements[h].remove();if(a.elements=[],a.boundViewsMap=[],a.collectionFilter&&(e=!0,i=a.collectionFilter.model||null,n=a.collectionFilter.fn),a.collectionBinder.collection.each(function(t){var h;s=!0,e&&(h=i||t,s=!!h[n](t)),s?(r=a.createBoundView(t),a.elements.push(r.$element),a.boundViewsMap.push(o),o++):a.boundViewsMap.push(!1)}),"Zepto"in window&&$===window.Zepto){for(var c=[],h=0,l=a.elements.length;l>h;h++)c.push(a.elements[h].get(0));a.$anchor.after(c)}else a.$anchor.after(a.elements);a.reindexBoundviews(),t.setZeroTimeout(function(){t.setZeroTimeout(function(){for(var e=0,t=a.boundViews.length;t>e;e++)a.boundViews[e].startRun()})})},initCollectionFilter:function(){var e=this.$element.attr("data-kff-filter");e&&(this.collectionFilter={model:null,fn:null},e=e.replace(/^\./,"").split("."),1===e.length?this.collectionFilter.fn=e[0]:(this.collectionFilter.fn=e.pop(),this.collectionFilter.model=this.getModel([].concat(e))))},collectionItemChange:function(e){var t,i,n,s,r=e.model,o=this.collectionBinder.collection.indexOf(r);if(this.collectionFilter)if(s=r,this.collectionFilter.model&&(s=this.collectionFilter.model),i=0,n=!!s[this.collectionFilter.fn].call(s,r),n&&this.boundViewsMap[o]===!1){for(t=0;o>t;t++)this.boundViewsMap[t]!==!1&&i++;this.addBoundViewAt(o,i)}else n||this.boundViewsMap[o]===!1||(i=this.boundViewsMap[o],this.boundViewsMap[o]=!1,this.removeBoundViewAt(i));else this.boundViewsMap[o]===!1&&this.addBoundViewAt(o,o)},refilterCollection:function(){this.collectionBinder.collection.each(this.f(function(e){this.collectionItemChange({model:e})}))},removeBoundViewAt:function(e){this.boundViews[e]&&(this.boundViews[e].startDestroy(),this.boundViews.splice(e,1),this.elements[e].remove(),this.elements.splice(e,1),this.reindexBoundviews(e))},addBoundViewAt:function(e,t){var i=this.collectionBinder.collection.findByIndex(e),n=this.createBoundView(i,t),s=n.$element;0===t?this.$anchor.after(s):this.elements[t-1].after(s),this.elements.splice(t,0,s),this.boundViewsMap[e]=t,this.reindexBoundviews(t),n.startRun()},reindexBoundviews:function(e,t){e||(e=0),(!t||t>this.boundViews.length)&&(t=this.boundViews.length);for(var i=e;t>i;i++)this.boundViews[i].setBindingIndex(i),this.boundViews[i].refreshBinders(!0);for(var i=0,n=this.boundViewsMap.length,s=0;n>i;i++)this.boundViewsMap[i]!==!1&&(this.boundViewsMap[i]=s,s++)},createBoundView:function(e,i){var n,s,r;return this.viewTemplate?(s=this.$elementTemplate.clone(),n=this.viewTemplate.clone(),void 0===i?(this.boundViews.push(n),i=this.boundViews.length-1):this.boundViews.splice(i,0,n),n.models["*"]=e,this.itemAlias&&(n.models[this.itemAlias]=e),n.setBindingIndex(i),n.rebindElement(s.get(0))):(s=this.$element.clone(),r=t.mixins({},this.boundViewOptions,{element:s,models:{"*":e}}),this.itemAlias&&(r.models[this.itemAlias]=e),n=new this.constructor(r),n.collectionBinder=null,void 0===i?(this.boundViews.push(n),i=this.boundViews.length-1):this.boundViews.splice(i,0,n),n.setBindingIndex(i),n.startRender(),this.viewTemplate=n.clone(),this.$elementTemplate=s.clone()),s.attr(t.View.DATA_RENDERED_ATTR,!0),n},refreshOwnBinders:function(e){this.modelBindersMap&&this.modelBindersMap.refreshBinders(),e!==!0&&this.collectionBinder&&this.collectionFilter&&this.refilterCollection()},refreshBinders:function(e){this.refreshOwnBinders(e),t.BindingView._super.refreshBinders.call(this,e)},renderSubviews:function(){this.collectionBinder||t.BindingView._super.renderSubviews.call(this)},runSubviews:function(){this.collectionBinder?this.renderBoundViews():t.BindingView._super.runSubviews.call(this)},destroySubviews:function(){this.collectionBinder?this.destroyBoundViews():t.BindingView._super.destroySubviews.call(this)},getBindingIndex:function(e){return e=e||"*",null!==this.bindingIndex&&this.models.hasOwnProperty(e)?this.bindingIndex:this.parentView instanceof t.View?this.parentView.getBindingIndex(e):null},setBindingIndex:function(e){this.bindingIndex=e},clone:function(){var e=t.View.prototype.clone.call(this);return this.collectionBinder&&(e.collectionBinder={collection:null,collectionPathArray:this.collectionBinder.collectionPathArray}),this.modelBindersMap&&(e.modelBindersMap=this.modelBindersMap.clone(),e.modelBindersMap.setView(e),e.boundViews=[]),e.options.isBoundView=this.options.isBoundView,e},rebindElement:function(e){t.BindingView._super.rebindElement.call(this,e),null!==this.modelBindersMap&&this.modelBindersMap.setView(this),this.collectionBinder&&(this.collectionBinder.collection=this.getModel(this.collectionBinder.collectionPathArray))}}),t.BindingView.registerHelper("index",function(e,t){return null!==this.getBindingIndex(t)?this.getBindingIndex(t):e}),t.BindingView.registerHelper("indexFromOne",function(e,t){return null!==this.getBindingIndex(t)?this.getBindingIndex(t)+1:e}),t.BindingView.registerHelper("boolean",function(e){var t=parseInt(e,10);return isNaN(t)?"true"===e:!!t}),t.BindingView.registerHelper("not",function(e){return!e}),t.BindingView.registerHelper("null",function(e){return null===e||"null"===e?null:e}),t.BindingView.registerHelper("int",function(e){return e=parseInt(e,10),isNaN(e)&&(e=0),e}),t.BindingView.registerHelper("float",function(e){return e=parseFloat(e),isNaN(e)&&(e=0),e}),t.BindingView.registerHelper("string",function(e){return""+e}),t.Binder=t.createClass({constructor:function(e){this.options=e,this.eventNames=e.eventNames,this.events=e.events||[],this.view=e.view,this.$element=e.$element,this.attr=e.attr,this.model=e.model,this.modelName=e.modelName,this.modelPathArray=e.modelPathArray,this.parsers=e.parsers,this.formatters=e.formatters,this.setter=e.setters instanceof Array&&e.setters.length>0?e.setters[0]:null,this.getter=e.getters instanceof Array&&e.getters.length>0?e.getters[0]:null,this.params=e.params,this.currentValue=null,this.bindingIndex=null,this.dynamicBindings=[],this.value=null},init:function(){this.options.watch?this.rebind():this.model instanceof t.Model&&(this.model.on("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.$element&&this.events.length>0&&this.delegateEvents.call(this,this.events)),this.options.fill&&this.model instanceof t.Model&&this.fill()},destroy:function(){this.model instanceof t.Model&&this.model.off("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.options.watch&&this.unbindDynamic(),this.$element&&this.events.length>0&&this.undelegateEvents.call(this,this.events),this.currentValue=null,this.value=null},delegateEvents:t.View.prototype.delegateEvents,undelegateEvents:t.View.prototype.undelegateEvents,modelChange:function(e){var i;this.model instanceof t.Model&&(i=this.getter&&"function"==typeof this.model[this.getter]?this.model[this.getter](this.attr):e!==!0?e.changed[this.attr]:"string"==typeof this.attr?this.model.get(this.attr):null,e!==!0&&this.compareValues(i,this.currentValue)||(this.value=this.format(i),this.currentValue=i,this.refresh()))
},compareValues:function(e,t){if(e instanceof Array&&t instanceof Array){var i=e.length;if(i!==t.length)return!1;for(var n=0;i>n;n++)if(e[n]!==t[n])return!1;return!0}return e===t},getFormattedValue:function(){return this.value},updateModel:function(e){var t,i;if(e instanceof Array)for(t=0,i=e.length;i>t;t++)e[t]=this.parse(e[t]);else e=this.parse(e);this.compareValues(e,this.currentValue)||(this.currentValue=e,this.setter&&"function"==typeof this.model[this.setter]?null===this.attr?this.model[this.setter](this.currentValue):this.model[this.setter](this.attr,this.currentValue):this.model.set(this.attr,this.currentValue))},refresh:function(){},format:function(e){var t,i,n,s,r;for(t=0,i=this.formatters.length;i>t;t++)if(e instanceof Array){for(r=[],n=0,s=e.length;s>n;n++)r[n]=this.formatters[t].fn.apply(this,[e[n]].concat(this.formatters[t].args));e=r}else e=this.formatters[t].fn.apply(this,[e].concat(this.formatters[t].args));return e},parse:function(e){var t,i,n,s,r;for(t=0,i=this.parsers.length;i>t;t++)if(e instanceof Array){for(r=[],n=0,s=e.length;s>n;n++)r[n]=this.parsers[t].fn.apply(this,[e[n]].concat(this.parsers[t].args));e=r}else e=this.parsers[t].fn.apply(this,[e].concat(this.parsers[t].args));return e},getBindingIndex:function(e){return e=e||"*",this.view.getBindingIndex(e)},clone:function(){var e=new this.constructor({eventNames:this.eventNames,view:null,$element:this.$element,attr:this.attr,model:null,modelName:this.modelName,modelPathArray:this.modelPathArray,parsers:this.parsers,formatters:this.formatters,params:this.params,fill:this.options.fill});return e.setter=this.setter,e.getter=this.getter,e},fill:function(){},rebindTimed:function(){t.setZeroTimeout(this.f("rebind"))},rebind:function(){this.unbindDynamic(),this.model instanceof t.Model&&(this.model.off("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.$element&&this.events.length>0&&this.undelegateEvents.call(this,this.events)),this.bindDynamic(),this.model instanceof t.Model&&(this.model.on("change"+(null===this.attr?"":":"+this.attr),this.f("modelChange")),this.$element&&this.events.length>0&&this.delegateEvents.call(this,this.events),this.modelChange(!0))},bindDynamic:function(){for(var e,i=this.modelPathArray[0],n=this.view.getModel(i),s=1,r=this.modelPathArray.length;r>s;s++)e=this.modelPathArray[s],n instanceof t.Model?(n.on("change:"+e,this.f("rebindTimed")),this.dynamicBindings.push({model:n,attr:e}),n=n.get(e)):n=null!==n&&"object"==typeof n&&e in n?n.attr:null;this.model=n instanceof t.Model?n:null},unbindDynamic:function(){for(var e=0,t=this.dynamicBindings.length;t>e;e++)this.dynamicBindings[e].model.off("change:"+this.dynamicBindings[e].attr,this.f("rebindTimed"));this.dynamicBindings=[]}}),t.EventBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click";e.events=[[i,"triggerEvent"]],t.Binder.call(this,e)},init:function(){this.userValue=this.params[0]||null,t.EventBinder._super.init.call(this)},triggerEvent:function(e){t.setZeroTimeout(this.f(function(){this.updateModel(this.userValue)})),e.preventDefault()},compareValues:function(){return!1}}),t.BindingView.registerBinder("event",t.EventBinder),t.AttrBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},init:function(){this.attribute=this.params[0]||null,this.prefix=this.params[1]||"",this.suffix=this.params[2]||"",t.AttrBinder._super.init.call(this)},refresh:function(){this.attribute&&this.$element.attr(this.attribute,this.prefix+this.value+this.suffix)}}),t.BindingView.registerBinder("attr",t.AttrBinder),t.CheckBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click change";e=e||{},e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){t.setZeroTimeout(this.f(function(){this.updateModel(this.$element.is(":checked"))}))},refresh:function(){this.$element.prop("checked",!!this.value)},fill:function(){this.fillVal||(this.fillVal=this.$element.is(":checked")),t.setZeroTimeout(this.f(function(){this.updateModel(this.fillVal)}))}}),t.BindingView.registerBinder("check",t.CheckBinder),t.DisabledBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},refresh:function(){this.$element.prop("disabled",!!this.value)},fill:function(){this.fillVal||(this.fillVal=this.$element.is(":disbaled")),t.setZeroTimeout(this.f(function(){this.updateModel(this.fillVal)}))}}),t.BindingView.registerBinder("disabled",t.DisabledBinder),t.ClassBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},init:function(){this.className=this.params[0]||null,this.equalsTo=this.params[1]||!0,this.operator=this.params[2]||null,t.ClassBinder._super.init.call(this)},refresh:function(){this.className&&this.$element[this.matchValue()?"addClass":"removeClass"](this.className)},matchValue:function(){return this.equalsTo?"ne"===this.operator?this.value!==this.parse(this.equalsTo):this.value===this.parse(this.equalsTo):this.value}}),t.BindingView.registerBinder("class",t.ClassBinder),t.StyleBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},init:function(){this.styleProperty=this.params[0]||null,t.StyleBinder._super.init.call(this)},refresh:function(){this.styleProperty&&this.$element.css(this.styleProperty,this.value)}}),t.BindingView.registerBinder("style",t.StyleBinder),t.ClickBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["click"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("click",t.ClickBinder),t.DoubleClickBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["dblclick"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("dblclick",t.DoubleClickBinder),t.FocusBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["focus"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("focus",t.FocusBinder),t.BlurBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["blur"]),t.EventBinder.call(this,e)}}),t.BindingView.registerBinder("blur",t.BlurBinder),t.FocusBlurBinder=t.createClass({extend:t.EventBinder},{constructor:function(e){0===e.eventNames.length&&(e.eventNames=["focus blur"]),t.EventBinder.call(this,e)},triggerEvent:function(){t.setZeroTimeout(this.f(function(){this.updateModel(this.$element.is(":focus"))}))},refresh:function(){this.value?this.$element.is(":focus")||this.$element.trigger("focus"):this.$element.is(":focus")&&this.$element.trigger("blur")}}),t.BindingView.registerBinder("focusblur",t.FocusBlurBinder),t.HtmlBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},refresh:function(){this.$element.html(this.value)}}),t.BindingView.registerBinder("html",t.HtmlBinder),t.RadioBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"click";e=e||{},e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){t.setZeroTimeout(this.f(function(){this.$element.is(":checked")&&this.updateModel(this.$element.val())}))},refresh:function(){this.$element.prop("checked",this.parse(this.$element.val())===this.currentValue)},fill:function(){this.fillVal||(this.fillVal=this.$element.is(":checked")),t.setZeroTimeout(this.f(function(){this.fillVal&&this.updateModel(this.$element.val())}))}}),t.BindingView.registerBinder("radio",t.RadioBinder),t.TextBinder=t.createClass({extend:t.Binder},{constructor:function(e){t.Binder.call(this,e)},refresh:function(){this.$element.text(this.value)}}),t.BindingView.registerBinder("text",t.TextBinder),t.ValueBinder=t.createClass({extend:t.Binder},{constructor:function(e){var i=e.eventNames.length>0?e.eventNames.join(" "):"keydown drop change";e.events=[[i,"inputChange"]],t.Binder.call(this,e)},inputChange:function(){t.setZeroTimeout(this.f(function(){this.updateModel(this.$element.val())}))},refresh:function(){this.$element.val(this.getFormattedValue())},fill:function(){this.fillVal||(this.fillVal=this.$element.val()),t.setZeroTimeout(this.f(function(){this.updateModel(this.fillVal)}))}}),t.BindingView.registerBinder("val",t.ValueBinder),t.ViewFactory=t.createClass({constructor:function(e){e=e||{},this.serviceContainer=e.serviceContainer||null,this.precedingViews=e.precedingViews||{}},createView:function(e,i){var n,s=null;return i=i||{},"function"!=typeof e&&this.serviceContainer&&this.serviceContainer.hasService(e)?s=this.serviceContainer.getService(e,[i]):(n="function"!=typeof e?t.evalObjectPath(e):e,n&&(s=new n(t.mixins({},i,{viewFactory:this})))),s},getServiceConstructor:function(e){return"function"==typeof e?e:this.serviceContainer&&this.serviceContainer.hasService(e)?this.serviceContainer.getServiceConstructor(e):t.evalObjectPath(e)},getPrecedingView:function(e){var t;return"string"==typeof e&&void 0!==this.precedingViews[e]?this.precedingViews[e]:(t=this.getServiceConstructor(e),t&&t.precedingView?t.precedingView:null)}}),t.Route=t.createClass({constructor:function(e,t){this.pattern=e,this.target=t,this.keys=null,this.regexp=this.compileRegex()},getTarget:function(){return this.target},match:function(e,t){var i=this.keys,n=e.indexOf("?"),s=~n?e.slice(0,n):e,r=this.regexp.exec(s);if(!r)return!1;for(var o=1,a=r.length;a>o;++o){var h=i[o-1],l="string"==typeof r[o]?decodeURIComponent(r[o]):r[o];h?t[h.name]=void 0!==t[h.name]?t[h.name]:l:t.push(l)}return!0},compileRegex:function(e,t){var i,n=this.keys=[];return i=this.pattern.concat(t?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(e,t,i,s,r,o){return n.push({name:s,optional:!!o}),t=t||"",""+(o?"":t)+"(?:"+(o?t:"")+(i||"")+(r||i&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+i+"$",e?"":"i")}}),t.Router=t.createClass({constructor:function(e){this.options=e||{},this.routes=[],this.buildRoutes()},buildRoutes:function(){this.routes=[];var e=this.options.routes;for(var i in e)this.routes.push(new t.Route(i,e[i]))},match:function(e){for(var t,i=0,n=this.routes.length;n>i;i++)if(t=[],this.routes[i].match(e,t))return{target:this.routes[i].getTarget(),params:t};return null}}),t.FrontController=t.createClass({constructor:function(e){e=e||{},this.options=e,this.views=null,this.viewsQueue=[],this.viewFactory=e.viewFactory||new t.ViewFactory,this.router=e.router||null},init:function(){this.router?$(window).bind("hashchange",this.f("hashChange")).trigger("hashchange"):this.setState(null)},createViewFromState:function(e){if(this.router){var t,i=e.path;if(""===i&&(i="#"),t=this.router.match(i))return e.params=t.params,t.target}return this.options.defaultView},hashChange:function(){var e=location.hash;return 0!==e.indexOf("#")&&""!=e?!1:(this.setState({path:e,params:{}}),!1)},getLastView:function(){return this.viewsQueue.length>0?this.viewsQueue[this.viewsQueue.length-1]:null},pushView:function(e){var i=this.getLastView();this.viewsQueue.push(e),i&&(i.instance.on("render",t.bindFn(e.instance,"init")),i.instance.on("setState",t.bindFn(e.instance,"setState")))},popView:function(){if(0!==this.viewsQueue.length){var e=this.viewsQueue.pop(),i=this.getLastView();return e.instance.off("render",t.bindFn(this,"cascadeState")),i&&(i.instance.off("render",t.bindFn(e.instance,"init")),i.instance.off("setState",t.bindFn(e.instance,"setState"))),e}},cascadeState:function(){this.viewsQueue[0]&&this.viewsQueue[0].instance.setState(this.state)},setState:function(e){var i,n,s,r=[];for(this.state=e,this.newViewName=this.createViewFromState(e),i=this.getLastView()?this.getLastView().name:null,n=this.findSharedView(this.newViewName,i);null!==(i=this.getLastView()?this.getLastView().name:null)&&i!==n;)r.push(this.popView());for(s=0;r.length>s;s++)r[s+1]?r[s].instance.on("destroy",t.bindFn(r[s+1].instance,"startDestroy")):r[s].instance.on("destroy",t.bindFn(this,"startInit"));r[0]?r[0].instance.startDestroy():this.startInit()},startInit:function(){var e,i,n=this.getPrecedingViews(this.newViewName),s=0;for(e=0,i=n.length;i>e;e++)e>=this.viewsQueue.length?this.pushView({name:n[e],instance:this.viewFactory.createView(n[e],{viewFactory:this.viewFactory})}):s=e+1;this.newViewName=null,this.getLastView()&&this.getLastView().instance.on("render",t.bindFn(this,"cascadeState")),this.viewsQueue[s]?this.viewsQueue[s].instance.init():this.cascadeState()},findSharedView:function(e,t){var i,n=this.getPrecedingViews(e),s=this.getPrecedingViews(t),r=null;for(i=0,l=n.length<s.length?n.length:s.length;l>i&&n[i]===s[i];i++)r=n[i];return r},getPrecedingViews:function(e){for(var t=e,i=[t];t;)t=this.viewFactory.getPrecedingView(t),t&&i.unshift(t);return i}}),t.App=t.createClass({constructor:function(e){var i;e=e||{},i=e.models||{};var n={parameters:{},services:{viewFactory:{construct:"kff.ViewFactory",args:[{serviceContainer:"@"}],shared:!0},frontController:{construct:"kff.FrontController",args:[{viewFactory:"@viewFactory",defaultView:"pageView"}],shared:!0},pageView:{construct:"kff.PageView",args:[{viewFactory:"@viewFactory",models:i}]}}};return this.serviceContainer=new t.ServiceContainer(n),"parameters"in e&&this.serviceContainer.registerParameters(e.parameters,!0),"services"in e&&this.serviceContainer.registerServices(e.services,!0),this},init:function(){this.serviceContainer.getService("frontController").init()},getServiceContainer:function(){return this.serviceContainer}})})(this);